<h2>QEMU是如何打开plugin功能的？</h2>

在QEMU初始化的源代码(`softmmu/vl.c`)中可以看到，如果在命令行中输入了有关plugin的指令，会进入plugin的指令扫描，调用的是`qemu_plugin_opt_parse()`函数。



在里面可以看到，它对于每一个plugin循环调用`plugin_add()`函数，来**添加**plugin。



在`plugin_add()`函数内部，它只是做了一些参数的比较(寻找到对应的plugin)，貌似并没有写如何打开。**但是注意这句话**：

```c
p->argv = g_realloc_n(p->argv, p->argc, sizeof(char **));
```

这句话将我们输入的参数保存起来，其中就含有我们添加进qemu的plugin的名称和各种属性。**等到QEMU扫描完所有的参数之后，紧接着就会运行plugin**。下面是加载的函数，依然位于`vl.c`中，正好就在扫描结构运行完毕后：



在`qemu_plugin_load_list()`函数中，对每一个plugin都进行了加载操作，而加载的核心就是这个`plugin_load()`函数：



在其中使用`g_module_open()`函数来打开plugin的handler服务；使用`(qemu_plugin_install_func_t) sym`来安装plugin。当安装完之后，这个plugin的描述符(desc)以及context的handler(服务函数，就是写在plugin中的函数)以及各种事件就已经全部就绪。