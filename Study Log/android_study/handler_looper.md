---
author: Spread Zhao
title: handler_looper
category: 
description: 
link: 
tags:
  - "#question/coding/android"
  - "#language/coding/kotlin"
  - "#language/coding/java"
  - "#question/coding/practice"
  - "#question/coding/theory"
  - "#question/interview"
  - "#rating/high"
mtrace:
  - 2023-09-04
---

# 1 Looperå’ŒMessageQueue

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼š**ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰0ä¸ªæˆ–1ä¸ªLooper**ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸ç®¡æˆ‘ä»¬æ˜¯åœ¨Javaä¸­new Thread()è¿˜æ˜¯åœ¨Kotliné‡Œthread {}ï¼Œå…¶å®åˆ›å»ºçš„éƒ½æ˜¯ä¸å«æœ‰Looperçš„çº¿ç¨‹ã€‚Looperåœ¨å®‰å“ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œè€Œä¸»çº¿ç¨‹é‡Œå°±æ˜¯å«æœ‰Looperçš„ï¼Œè¿™æ˜¯å› ä¸ºSDKå·²ç»å¸®æˆ‘ä»¬é»˜è®¤åˆ›å»ºå¥½äº†ä¸€ä¸ªLooperã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•è®©ä¸€ä¸ªçº¿ç¨‹å«æœ‰Looperå‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸€çœ‹Looperçš„å®˜æ–¹ä»‹ç»å°±çŸ¥é“äº†ï¼š

![[Study Log/android_study/resources/Pasted image 20230729164212.png]]

Looperçš„prepare()å‡½æ•°æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹å®ƒçš„å®ç°ï¼š

```java
/** 
  * Initialize the current thread as a looper.  
  * This gives you a chance to create handlers that then reference  
  * this looper, before actually starting the loop. Be sure to call  
  * {@link #loop()} after calling this method, and end it by calling  
  * {@link #quit()}.  
  */
public static void prepare() {  
    prepare(true);  
}
```

é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªThreadçš„runæ–¹æ³•ä¸­é¦–å…ˆè°ƒç”¨ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨**Looper.myLooper()**å‡½æ•°æ¥è·å–åˆ°è¿™ä¸ªprepareè¿‡çš„Looperå¯¹è±¡äº†ã€‚è¿™ä¸ªå¯¹è±¡å°±æ˜¯ä¸ºè¿™ä¸ªçº¿ç¨‹ä¸“é—¨å‡†å¤‡å¥½çš„Looperï¼Œå®ƒçš„å†…éƒ¨æœ‰ä¸€ä¸ªæœ€é‡è¦çš„ç»“æ„ï¼Œå«åšMessageQueueï¼š

```java
/**  
 * Low-level class holding the list of messages to be dispatched by a 
 * {@link Looper}.  Messages are not added directly to a MessageQueue,  
 * but rather through {@link Handler} objects associated with the Looper.  
 * * <p>You can retrieve the MessageQueue for the current thread with  
 * {@link Looper#myQueue() Looper.myQueue()}.  
 */
public final class MessageQueue {
```

å®ƒå°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œè¿™ä¸ªé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼Œå°±æ˜¯å„ç§å„æ ·çš„Handlerå‘è¿‡æ¥çš„ã€‚é‚£ä¹ˆç°åœ¨é—®é¢˜æ¥äº†ï¼š*Handleræ˜¯æ€ä¹ˆå¤Ÿå¾—ç€è¿™ä¸ªMessageQueueçš„*ï¼Ÿè¿™å°±è¦ä»Handlerçš„æ„é€ æ–¹æ³•è¯´èµ·äº†ã€‚

# 2 Handler

Handlerçš„æ„é€ æ–¹æ³•éå¸¸éå¸¸å¤šï¼Œä½†æ€»å¾—æ¥è¯´ï¼Œåªåˆ†ä¸ºä¸¤ç±»ï¼š

* ä½¿ç”¨ç¨‹åºå‘˜æä¾›ç»™ä»–çš„Looperæ¥æ„é€ ï¼›
* ä½¿ç”¨é»˜è®¤çš„Looperæ¥æ„é€ ã€‚

éå¸¸æ¸…æ™°ä¸æ˜¯ï¼Ÿï¼å› ä¸ºHandlerè¦æ˜¯æƒ³å‘é€æ¶ˆæ¯ï¼Œå¿…é¡»èƒ½è·å¾—MessageQueueï¼Œè€ŒMessageQueueåˆæ˜¯ä¸€ä¸ªçº¿ç¨‹é‡Œçš„å”¯ä¸€ä¸€ä¸ªLooperæ‰€ä¿ç®¡çš„ã€‚æ‰€ä»¥ï¼ŒHandlerçš„æ„é€ æ–¹æ³•é‡Œå¿…é¡»æä¾›ä¸€ä¸ªLooperæ¥æŒ‡æ˜**è¿™ä¸ªHandleræ˜¯attachåˆ°å“ªä¸ªLooperï¼Œä¹Ÿå°±æ˜¯å“ªä¸ªçº¿ç¨‹ä¸Šçš„**ã€‚

å®é™…ä¸Šï¼ŒLooperæœ¬èº«çš„ä½œç”¨ï¼Œå°±æ˜¯å’Œä¾é™„äºå®ƒçš„Handlerä»¬æ‰“äº¤é“ï¼Œå®ç°çº¿ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼š

![[Study Log/android_study/resources/Drawing 2023-07-29 17.03.53.excalidraw.png]]

ä¸Šå›¾å±•ç¤ºäº†ï¼Œä¸€ä¸ªå¸¦æœ‰Looperçš„çº¿ç¨‹ï¼Œå’Œå…¶å®ƒä¸¤ä¸ªçº¿ç¨‹ä¸­ä¾é™„äºè‡ªå·±Looperçš„Handleræ‰“äº¤é“çš„åœºé¢ã€‚ç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š**Handleråœ¨å“ªé‡Œåˆ›å»ºä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å®ƒè¡£æœçš„Looperæ˜¯è°ï¼Œåœ¨å“ªä¸ªçº¿ç¨‹é‡Œ**ã€‚å› ä¸ºæœ€ç»ˆå¤„ç†æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±ä¼šåˆ‡æ¢åˆ°Looperæ‰€åœ¨çš„çº¿ç¨‹ä¸­å»æ‰§è¡Œã€‚

æ¥ä¸‹æ¥ï¼Œè§£ç­”å‰é¢çš„ä¸€ä¸ªéšè—çš„ç–‘æƒ‘ï¼šHandlerçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸æä¾›Looperï¼Œé‚£å°±ä¼šç»™ä¸€ä¸ªé»˜è®¤çš„ã€‚é‚£è¿™ä¸ªé»˜è®¤çš„æ˜¯è°å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ï¼š`myLooper()`ï¼

```java
// Handleræ‰€æœ‰é»˜è®¤Looperæ„é€ æ–¹æ³•çš„å¿…ç»ä¹‹è·¯
mLooper = Looper.myLooper();  
if (mLooper == null) {  
    throw new RuntimeException(  
        "Can't create handler inside thread " + Thread.currentThread()  
                + " that has not called Looper.prepare()");  
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸æä¾›Looperçš„ç”»ï¼Œé‚£ä¹ˆå½“å‰è¿è¡Œçš„çº¿ç¨‹ä¸­çš„Looperå°±ä¼šè¢«è¿™ä¸ªHandlerä¾é™„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å®éªŒä¸€ä¸‹ï¼šåœ¨MainActivityï¼Œæˆ–è€…åªè¦æ˜¯ä¸»çº¿ç¨‹çš„åœ°æ–¹ï¼Œéšä¾¿è°ƒç”¨ä¸€ä¸‹æ— å‚æ„é€ ï¼š

```kotlin
val handler = Handler()
```

ç¨‹åºæ˜¯ä¸ä¼šå¼‚å¸¸çš„ã€‚å› ä¸ºä¸»çº¿ç¨‹ä¸­SDKå·²ç»ä¸ºæˆ‘ä»¬å‡†å¤‡å¥½äº†ä¸€ä¸ªLooperã€‚ç°åœ¨åˆ‡æ¢åˆ°å­çº¿ç¨‹ä¸­æ¥ä¸€æ¬¡ï¼š

```kotlin
thread {
	val handler = Handler()
}
```

æœç„¶æŠ›å‡ºäº†å¼‚å¸¸ï¼è¿™å’Œä»£ç ä¸­å®šä¹‰çš„å¼‚å¸¸ä¸€æ¨¡ä¸€æ ·ï¼š

![[Study Log/android_study/resources/Pasted image 20230729171658.png|300]]

é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿç»™ä»–ä¸ªLooperå‘—ï¼æ‰€ä»¥ï¼Œæˆ‘ä»¬é€šå¸¸çš„åšæ³•ï¼Œéƒ½æ˜¯åœ¨é‡Œé¢ä¼ å…¥Looper.getMainLooper()æ¥è·å¾—ä¸»çº¿ç¨‹é»˜è®¤çš„Looperï¼š

```kotlin
thread {  
    val handler = Handler(Looper.getMainLooper())  
}
```

è¿™ä¸‹ç¨‹åºä¸ä¼šå‡ºé”™äº†ï¼Œä½†æ˜¯åƒä¸‡è¦çŸ¥é“åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆï¼Œä¸è¦åªè¦æ˜¯æ„é€ Handlerï¼Œå°±å¾€é‡Œé¢å¡Looper.getMainLooper()ï¼Œè€Œæ˜¯ï¼Œ**æˆ‘ä»¬æƒ³è®©Handleråœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œä»£ç ï¼Œå°±åœ¨å“ªä¸ªçº¿ç¨‹é‡Œæ„é€ Looperï¼Œç„¶åæŠŠå®ƒå¡åˆ°Handleré‡Œé¢å»**ã€‚æ¯”å¦‚ï¼Œæˆ‘ç°åœ¨å°±æƒ³è®©è¿™ä¸ªHandleråœ¨æˆ‘å½“å‰çš„çº¿ç¨‹é‡Œæ‰§è¡Œä»£ç ï¼ˆçº¯å±è„±è£¤å­æ”¾å±ï¼Œæ•™å­¦éœ€è¦è€Œå·²ï¼‰ï¼Œå°±å¯ä»¥è¿™æ ·åšï¼š

```kotlin
thread {  
    Looper.prepare()  
    val handler = Looper.myLooper()?.let { Handler(it) }  
    if (handler != null) {  
        Log.e("MainActivity", "Handler is not null!")  
    }  
}
```

ç”±äºKotllinçš„å¼ºè¡Œåˆ¤ç©ºæœºåˆ¶ï¼Œæˆ‘ä»¬æ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œæ¥è¯æ˜è¿™ä¸ªæ–¹æ³•çœŸçš„å¯è¡Œã€‚ç»“æœå½“ç„¶æ˜¯æˆåŠŸåˆ›å»ºäº†Handlerï¼Œå¹¶ä¸”Looperæ˜¯æˆ‘å½“å‰è¿™ä¸ªçº¿ç¨‹çš„ï¼Œå¹¶ä¸æ˜¯ä¸»çº¿ç¨‹çš„Looperã€‚

åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒHandlerçš„Looperéƒ½åº”è¯¥æ˜¯å…¶å®ƒçº¿ç¨‹çš„ï¼Œå› ä¸ºHandleræœ¬èº«æœ€å¤§çš„ä½œç”¨å°±æ˜¯å®ç°çº¿ç¨‹é—´é€šä¿¡ã€‚æ‰€ä»¥ï¼Œæ‰€æœ‰æ²¡æœ‰æŒ‡å®šLooperçš„æ„é€ æ–¹æ³•ï¼Œå¦‚ä»Šéƒ½å·²ç»è¢«æ ‡è®°æˆäº†Deprecatedã€‚å…¶ä¸­æœ€å¤§çš„åŸå› ï¼Œå°±æ˜¯æ—¶åˆ»æé†’æˆ‘ä»¬ï¼š**ä¸€å®šè¦ç‰¢è®°ä½ åˆ›å»ºçš„Handleråˆ°åº•æ˜¯å’Œå“ªä¸€ä¸ªLooperå…³è”çš„ï¼Œä¹Ÿå°±æ˜¯å’Œå“ªä¸€ä¸ªçº¿ç¨‹å…³è”çš„**ã€‚

# 3 post & send

Handlerçš„ä½¿ç”¨æœ€é‡è¦çš„å°±æ˜¯è¿™ä¸¤ç±»æ–¹æ³•ï¼š

* postXXX
* sendXXX

å®ƒä»¬çš„æœ¬è´¨åŒºåˆ«æ˜¯ï¼Œå‰è€…æ¥æ”¶çš„å‚æ•°æ˜¯Runnableï¼Œåè€…æ¥æ”¶çš„å‚æ•°æ˜¯Messageã€‚ç„¶è€Œï¼Œè¿™ä¸ªåŒºåˆ«å…¶å®ä¹Ÿä¸ç®—åŒºåˆ«ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹postçš„æºç å°±æ¸…æ¥šäº†ï¼š

```kotlin
public final boolean post(@NonNull Runnable r) {  
	return sendMessageDelayed(getPostMessage(r), 0);  
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æœ€ç»ˆå‘é€çš„è¿˜æ˜¯ä¸€ä¸ªMessageï¼Œè€ŒgetPostMessageæ–¹æ³•å°±æ˜¯æ„é€ ä¸€ä¸ªMessageï¼Œç„¶åæŠŠRunnableå¯¹è±¡å¡«è¿›å»ï¼š

```java
private static Message getPostMessage(Runnable r) {  
    Message m = Message.obtain();  
    m.callback = r;  
    return m;  
}
```

ç„¶åï¼Œå°±æ˜¯Handlerå¤„ç†æ¶ˆæ¯çš„æ–¹å¼ã€‚ä¸€å…±æœ‰ä¸‰ç§ï¼š

1. Messageé‡Œè‡ªå¸¦çš„Runnableï¼Œåˆšåˆšå°±æåˆ°è¿‡ï¼Œä½¿ç”¨postXXXå‘é€çš„éƒ½æ˜¯è¿™ç§ï¼›
2. Handleré‡Œé¢æœ‰ä¸€ä¸ªCallbackæ¥å£ï¼Œåœ¨æ„é€ Handleræ—¶ï¼Œä¹Ÿå¯ä»¥ä¼ è¿™ä¸ªè¿›å»ã€‚è€Œè¿™ä¸ªæ¥å£é‡Œé¢ä¹Ÿå°±æ˜¯ä¸€ä¸ªhandleMessageæ–¹æ³•ï¼›
3. Handlerè‡ªå·±çš„handleMessageæ–¹æ³•ã€‚

è¿™ä¸‰è€…çš„ä¼˜å…ˆçº§æ˜¯ä»é«˜åˆ°ä½çš„ï¼Œä¹Ÿå°±æ˜¯ï¼š

* åªè¦Messageé‡Œè‡ªå¸¦Runnableï¼Œé‚£ä¹ˆåä¸¤ä¸ªéƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼›
* å¦‚æœMessageé‡Œæ²¡æœ‰Runnableï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬åœ¨Handleræ„é€ çš„æ—¶å€™ä¼ äº†Callbackè¿›å»ï¼Œé‚£ä¹ˆè¿™é‡Œçš„handleMessageä¼šå…ˆæ‰§è¡Œï¼Œ**å¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å˜é‡**ï¼›
* å¦‚æœä¹‹å‰è¿”å›çš„å¸ƒå°”å˜é‡æ˜¯trueï¼Œé‚£ä¹ˆHandlerè‡ªå·±çš„handleMessageå°±ä¸ä¼šæ‰§è¡Œäº†ï¼›å¦‚æœè¿”å›çš„æ˜¯falseï¼Œåˆæˆ–è€…Callbackå¯¹è±¡æ ¹æœ¬å°±ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆHandlerè‡ªå·±çš„handleMessageå°±ä¼šæ‰§è¡Œã€‚

# 4 Summary

Handlerå‡ºç°æœ€æ ¹æœ¬çš„åŸå› ï¼šæˆ‘ä¸æƒ³æˆ‘è‡ªå·±ï¼ˆå­çº¿ç¨‹ï¼‰æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘è¦ä½ ï¼ˆä¸»çº¿ç¨‹ï¼‰æ‰§è¡Œï¼

ä¸ºä»€ä¹ˆä¸€ä¸ªçº¿ç¨‹æœ€å¤šåªæœ‰ä¸€ä¸ªLooperï¼Ÿä½ æœ‰å¤šä¸ªä¹Ÿæ²¡åµç”¨ã€‚å› ä¸ºLooper.loopæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè€Œè¿™ä¸ªå¾ªç¯ç»“æŸäº†ï¼Œä¹Ÿå°±ä»£è¡¨çº¿ç¨‹æ¶ˆäº¡äº†ã€‚åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå¦‚æœloopæ–¹æ³•æ‰§è¡Œå®Œï¼Œç¨‹åºå°±é€€å‡ºäº†ã€‚æ‰€ä»¥ï¼Œå³ä½¿ä½ ç»™ä¸€ä¸ªçº¿ç¨‹ç»‘äº†ä¸¤ä¸ªlooperï¼Œé‚£ä¸€ä¸ªçº¿ç¨‹çš„loopä¸€æ—¦å¯åŠ¨ï¼Œåé¢çš„ä¹ŸåŸºæœ¬ä¸Šä¸ä¼šæ‰§è¡Œåˆ°äº†ï¼Œé™¤éä½ è¿™ä¸ªè®¾è®¡æœ¬èº«çš„bugå¯¼è‡´äº†å¾ªç¯é€€å‡ºã€‚

# 5 Others

> [!question]- Handler å¼•èµ·çš„å†…å­˜æ³„éœ²åŸå› ä»¥åŠæœ€ä½³è§£å†³æ–¹æ¡ˆ
> 
> å› ä¸ºHandlerä¸€èˆ¬æ˜¯ä½œä¸ºActivityçš„å†…éƒ¨ç±»ï¼Œå¯ä»¥å‘é€å»¶è¿Ÿæ‰§è¡Œçš„æ¶ˆæ¯ï¼Œå¦‚æœåœ¨å»¶è¿Ÿé˜¶æ®µï¼Œæˆ‘ä»¬æŠŠActivityå…³æ‰ï¼Œæ­¤æ—¶å› ä¸ºè¯¥Activityè¿˜è¢«Handlerè¿™ä¸ªå†…éƒ¨ç±»æ‰€æŒæœ‰ï¼Œå¯¼è‡´Activityæ— æ³•è¢«å›æ”¶ï¼Œæ²¡æœ‰çœŸæ­£é€€å‡ºå¹¶é‡Šæ”¾ç›¸å…³èµ„æºï¼Œå› æ­¤å°±é€ æˆå†…å­˜æ³„æ¼ã€‚
> 
> å·¥ç¨‹ä¸Šå¸¸ç”¨çš„æ–¹æ³•æ˜¯å°† Handler å®šä¹‰æˆé™æ€çš„å†…éƒ¨ç±»ï¼Œåœ¨å†…éƒ¨æŒæœ‰ Activity çš„å¼±å¼•ç”¨ï¼Œå¹¶åœ¨Acitivityçš„onDestroy()ä¸­è°ƒç”¨handler.removeCallbacksAndMessages(null)åŠæ—¶ç§»é™¤æ‰€æœ‰æ¶ˆæ¯ã€‚å¦‚æœå’Œé¢è¯•å®˜è¯´äº†è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œé‚£ä½ å°±100åˆ†è¿‡å…³äº†ï¼Œä½†æ›´è¿›ä¸€æ­¥æ˜¯å»ºè®®å°†HandleræŠ½ç¦»å‡ºæ¥ä½œä¸ºBaseHandlerï¼Œç„¶åæ¯ä¸ªActivityéœ€è¦ç”¨åˆ°Handlerçš„æ—¶å€™ï¼Œå°±å»ç»§æ‰¿BaseHandlerã€‚æœ€ä½³è§£å†³æ–¹æ¡ˆå…·ä½“ä»£ç ï¼š[[Study Log/android_study/resources/basehandler|basehandler]]

^b9e691

> [!question]- ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨ Handlerï¼Œè€Œä¸éœ€è¦åˆ›å»º Looper ï¼Ÿ
> 
> è¯¦æƒ…å¯¹åº”2.1å°èŠ‚ï¼ŒActivityThreadæ˜¯ä¸»çº¿ç¨‹æ“ä½œçš„ç®¡ç†è€…ï¼Œåœ¨ ActivityThread.main() æ–¹æ³•ä¸­è°ƒç”¨äº† Looper.prepareMainLooper() ï¼Œè¯¥æ–¹æ³•è°ƒç”¨prepare()åˆ›å»ºLooperã€‚å› æ­¤ä¸»çº¿ç¨‹ä¸æ˜¯ä¸éœ€è¦åˆ›å»ºLooperï¼Œè€Œæ˜¯ç³»ç»Ÿå¸®æˆ‘ä»¬åšäº†ã€‚
> 

> [!question]- Handlerã€Threadå’ŒHandlerThreadçš„å·®åˆ«
> 
> åˆæ˜¯è¿™ç§è€ƒåŒºåˆ«çš„é¢˜ç›®ï¼Œä¸è¿‡è¿˜ç®—æ˜¯æ¯”è¾ƒå¸¸è§çš„ä¸‰ä¸ªçŸ¥è¯†ç‚¹ï¼š
> 
> 1.  Handlerï¼šæœ¬æ–‡æ‰€å­¦çš„çŸ¥è¯†ï¼Œæ˜¯Androidçš„ä¸€ç§å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ï¼Œè´Ÿè´£å‘é€å’Œå¤„ç†æ¶ˆæ¯ï¼Œå¯å®ç°å­çº¿ç¨‹å’Œä¸»çº¿ç¨‹çš„æ¶ˆæ¯é€šè®¯ï¼›
> 2.  Threadï¼šJavaçš„ä¸€ä¸ªå¤šçº¿ç¨‹ç±»ï¼Œæ˜¯Javaè¿›ç¨‹ä¸­æœ€å°æ‰§è¡Œè¿ç®—å•ä½ï¼Œç”¨äºç»™å­ç±»ç»§æ‰¿ï¼Œåˆ›å»ºçº¿ç¨‹/
> 3.  HandlerThreadï¼šä»åå­—çœ‹å°±çŸ¥é“æ˜¯ç”±å‰é¢ä¸¤è€…ç»“åˆèµ·æ¥çš„ã€‚å¯ä»¥ç†è§£ä¸ºâ€œä¸€ä¸ªç»§æ‰¿è‡ªThreadçš„Handlerç±»â€ï¼Œå› æ­¤æœ¬è´¨ä¸Šå’Œçˆ¶ç±»ä¸€æ ·æ˜¯Threadï¼Œä½†å…¶å†…éƒ¨ç›´æ¥å®ç°äº†Looperï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨HandlerThreadé‡Œé¢ç›´æ¥ä½¿ç”¨Handleræ¶ˆæ¯æœºåˆ¶ã€‚å‡å°‘äº†æ‰‹åŠ¨è°ƒç”¨Looper.prepare()å’ŒLooper.loop()è¿™äº›æ–¹æ³•ã€‚
> 

> [!question]- å­çº¿ç¨‹ä¸­æ€ä¹ˆä½¿ç”¨ Handlerï¼Ÿ
> 
> è¿™ä¸ªé¢˜ç›®å°±å¯ä»¥ç»“åˆä¸Šé¢ä¸¤ä¸ªé¢˜ç›®æ¥æ‹“å±•ç†è§£äº†ã€‚å­çº¿ç¨‹ä¸­ä½¿ç”¨ Handler éœ€è¦å…ˆæ‰§è¡Œä¸¤ä¸ªæ“ä½œï¼šLooper.prepare() å’Œ Looper.loop()ï¼Œçœ‹åˆ°è¿™é‡Œä½ åº”è¯¥è¦è®°å¾—è¿™ä¸¤ä¸ªå‡½æ•°æ‰§è¡Œé¡ºåºæ˜¯ä¸èƒ½å˜çš„å“¦ã€‚åŒæ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨HandlerThreadç±»å³å¯ã€‚

> [!question]- ä¸ºä»€ä¹ˆåœ¨å­çº¿ç¨‹ä¸­åˆ›å»º Handler ä¼šæŠ›å¼‚å¸¸ï¼Ÿ
> 
> ä¸èƒ½åœ¨è¿˜æ²¡æœ‰è°ƒç”¨ Looper.prepare() æ–¹æ³•çš„çº¿ç¨‹ä¸­åˆ›å»º Handlerã€‚ å› ä¸ºæŠ›å‡ºå¼‚å¸¸çš„åœ°æ–¹ï¼Œåœ¨Handlerçš„æ„å»ºå‡½æ•°ï¼Œåˆ¤æ–­ mLooper å¯¹è±¡ä¸ºnullçš„æ—¶å€™ï¼Œ ä¼šæŠ›å‡ºå¼‚å¸¸

> [!question]- Handler é‡Œè—ç€çš„ Callback èƒ½å¹²ä»€ä¹ˆï¼Ÿ
> 
> è¯¦æƒ…å¯¹åº”2.4å°èŠ‚ï¼Œå½“ä»æ¶ˆæ¯é˜Ÿåˆ—è·å–åˆ°ä¿¡æ¯åï¼Œéœ€è¦åˆ†é…ç»™å¯¹åº”çš„Handlerå»å¤„ç†ï¼Œæ€»å…±æœ‰3ç§ä¼˜å…ˆçº§ã€‚
> 
> 1.  handleCallback(msg)ï¼šMessageé‡Œè‡ªå¸¦çš„callbackä¼˜å…ˆçº§æœ€é«˜ï¼›å¯¹åº”Handlerçš„postæ–¹æ³•ï¼›
> 2.  mCallback.handleMessage(msg)ï¼šä¹Ÿå°±æ˜¯Handler.Callback å†™æ³•ï¼›
> 3.  handleMessage(msg)ï¼šé‡å†™handlerMessage()æ–¹æ³•ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼›
> 
> è€ŒHandler.Callbackå¤„äºç¬¬äºŒä¼˜å…ˆçº§ï¼Œå½“ä¸€æ¡æ¶ˆæ¯è¢« Callback å¤„ç†å¹¶è¿”å›trueï¼Œé‚£ä¹ˆ Handler çš„ handleMessage(msg) æ–¹æ³•å°±ä¸ä¼šè¢«è°ƒç”¨äº†ï¼›ä½†å¦‚æœ Callback å¤„ç†åè¿”å›falseï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆæ¯å°±å…ˆåè¢«Handler.Callbackå’ŒhandleMessage(msg)éƒ½å¤„ç†è¿‡ã€‚
> 

> [!question]- Handler çš„ send å’Œ post çš„åŒºåˆ«ï¼Ÿ
> 
> åŸºäºä¸Šé“é¢˜ç»§ç»­å±•å¼€ï¼Œpostæ–¹æ³•ï¼Œå®ƒä¼šæŠŠä¼ å…¥çš„ Runnable å‚æ•°èµ‹å€¼ç»™ Message çš„ callback æˆå‘˜å˜é‡ã€‚å½“ Handler è¿›è¡Œåˆ†å‘æ¶ˆæ¯æ—¶ï¼Œmsg.callback ä¼šæœ€ä¼˜å…ˆæ‰§è¡Œã€‚
> 
> -   postæ˜¯å±äºsendMessageçš„ä¸€ç§èµ‹å€¼callbackçš„ç‰¹ä¾‹
> -   postå’ŒsendMessageæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œä¸¤ç§éƒ½ä¼šæ¶‰åŠåˆ°å†…å­˜æ³„éœ²çš„é—®é¢˜
> -   postæ–¹å¼é…åˆlambdaè¡¨è¾¾å¼å†™æ³•æ›´ç²¾ç®€
> 

> [!question]- åˆ›å»º Message å®ä¾‹çš„æœ€ä½³æ–¹å¼
> 
> è¯¦æƒ…å¯¹åº”2.3å°èŠ‚ï¼Œä¸ºäº†èŠ‚çœå¼€é”€ï¼ŒAndroid ç»™ Message è®¾è®¡äº†å›æ”¶æœºåˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™å°½é‡å¤ç”¨ Message ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—ï¼š
> 
> - [*] é€šè¿‡ Message çš„é™æ€æ–¹æ³• Message.obtain()ï¼› é€šè¿‡ Handler çš„å…¬æœ‰æ–¹æ³• handler.obtainMessage()ã€‚
> 

> [!question]- Message çš„æ’å…¥ä»¥åŠå›æ”¶æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Œå¦‚ä½•å®ä¾‹åŒ–ä¸€ä¸ª Message å‘¢ï¼Ÿ
> 
> æ’å…¥å¯¹åº”2.5.1å°èŠ‚æ³¨é‡Š2ï¼ŒMessage å¾€ MessageQueue æ’å…¥æ¶ˆæ¯æ—¶ï¼Œä¼šæ ¹æ® when å­—æ®µï¼ˆç›¸å¯¹æ—¶é—´ï¼‰æ¥åˆ¤æ–­æ’å…¥çš„é¡ºåº.
> 
> æ¶ˆæ¯å›æ”¶å¯¹åº”2.4å°èŠ‚loop()å‡½æ•°æ³¨é‡Š5ï¼Œåœ¨æ¶ˆæ¯æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¼šè¿›è¡Œå›æ”¶æ¶ˆæ¯ï¼Œå›æ”¶æ¶ˆæ¯å¯è§2.3å°èŠ‚recycleUnchecked()å‡½æ•°ï¼Œåªæ˜¯ Message çš„æˆå‘˜å˜é‡è®¾ç½®ä¸º0æˆ–è€…nullï¼›
> 
> å®ä¾‹åŒ– Message çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»¶2.3å°èŠ‚ï¼Œæœ¬æ–‡å»ºè®®å¤šæ¬¡äº†ï¼Œå°½é‡ä½¿ç”¨ Message.obtain æ–¹æ³•ï¼Œè¿™æ˜¯ä»ç¼“å­˜æ¶ˆæ¯æ± é“¾è¡¨é‡Œç›´æ¥è·å–çš„å®ä¾‹ï¼Œå¯ä»¥é¿å… Message çš„é‡å¤åˆ›å»ºã€‚

> [!question]- å¦™ç”¨Looperæœºåˆ¶ï¼Œæˆ–è€…ä½ çŸ¥é“Handleræœºåˆ¶çš„å…¶ä»–ç”¨é€”å—ï¼Ÿ
> 
> - å°† Runnable post åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œï¼›
> - [*] åˆ©ç”¨ Looper åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼›
> 
> ```java
> public boolean isMainThread() {
>     return Looper.getMainLooper() == Looper.myLooper();
> }
> ```

> [!question]- Looper.loop()æ­»å¾ªç¯ä¸€ç›´è¿è¡Œæ˜¯ä¸æ˜¯ç‰¹åˆ«æ¶ˆè€—CPUèµ„æºå‘¢ï¼Ÿä¸ä¼šé€ æˆåº”ç”¨å¡æ­»å—ï¼Ÿ
> 
> è¯¦æƒ…å¯¹åº”2.4å’Œ2.5å°èŠ‚ã€‚è¿™è¿˜æ¶‰åŠlinuxå¤šè¿›ç¨‹é€šè®¯æ–¹å¼ï¼šPipeç®¡é“é€šè®¯ã€‚Androidåº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹åœ¨è¿›å…¥æ¶ˆæ¯å¾ªç¯è¿‡ç¨‹å‰ï¼Œä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸€ä¸ªLinuxç®¡é“ã€‚é¦–å…ˆåœ¨loop()æ–¹æ³•ä¸­ï¼Œè°ƒç”¨queueçš„next()æ–¹æ³•è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ã€‚å…·ä½“çœ‹2.5.2å°èŠ‚ï¼Œnext()æºç åˆ†æè¯´è¿‡ï¼ŒMessageQueueæ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œä¾¿é˜»å¡åœ¨nativePollOnce()æ–¹æ³•é‡Œï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹ä¼šé‡Šæ”¾CPUèµ„æºè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå› æ­¤å¹¶ä¸ç‰¹åˆ«æ¶ˆè€—CPUèµ„æºã€‚
> 
> ç›´åˆ°ç­‰å¾…æ—¶é•¿åˆ°äº†æˆ–è€…æœ‰æ–°çš„æ¶ˆæ¯æ—¶ï¼Œé€šè¿‡å¾€pipeç®¡é“å†™ç«¯å†™å…¥æ•°æ®æ¥å”¤é†’ä¸»çº¿ç¨‹å·¥ä½œã€‚è¿™é‡Œé‡‡ç”¨çš„epollæœºåˆ¶æ˜¯ä¸€ç§IOå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå¯ä»¥åŒæ—¶ç›‘è§†å¤šä¸ªæè¿°ç¬¦ã€‚å½“ä¸€ä¸ªæè¿°ç¬¦å·å‡†å¤‡å¥½(è¯»æˆ–å†™)æ—¶ï¼Œç«‹å³é€šçŸ¥ç›¸åº”çš„ç¨‹åºè¿›è¡Œè¯»æˆ–å†™æ“ä½œï¼Œå…¶å®è´¨æ˜¯åŒæ­¥ I/Oï¼Œå³è¯»å†™æ˜¯é˜»å¡çš„ã€‚å…¶å®ä¸»çº¿ç¨‹å¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯å¤„äºè¿™ç§ä¼‘çœ çŠ¶æ€ï¼Œå¹¶ä¸ä¼šæ¶ˆè€—å¤§é‡CPUèµ„æºï¼Œæ›´ä¸ä¼šé€ æˆåº”ç”¨å¡æ­»ã€‚

> [!question]- MessageQueue ä¸­å¦‚ä½•ç­‰å¾…æ¶ˆæ¯ï¼Ÿä¸ºä½•ä¸ä½¿ç”¨ Java ä¸­çš„ wait/notify æ¥å®ç°é˜»å¡ç­‰å¾…å‘¢ï¼Ÿ
> 
> ç›´æ¥å›ç­”åœ¨ MessageQueue çš„ nativePollOnce å‡½æ•°é˜»å¡ï¼Œç›´åˆ°ç­‰å¾…æ—¶é•¿åˆ°äº†æˆ–è€…æœ‰æ–°çš„æ¶ˆæ¯æ—¶æ‰é‡æ–°å”¤é†’MessageQueueã€‚å…¶å®åœ¨ Android 2.2 åŠå…¶ä»¥å‰ï¼Œç¡®å®æ˜¯ä½¿ç”¨wait/notifyæ¥å®ç°é˜»å¡å’Œå”¤é†’ï¼Œä½†æ˜¯ç°åœ¨MessageQueueæºç æ¶‰åŠå¾ˆå¤šnativeçš„æ–¹æ³•ï¼Œå› æ­¤Javaå±‚çš„wait/notifyè‡ªç„¶ä¸è¿‡ç”¨äº†ï¼Œè€ŒPipeç®¡é“é€šè®¯æ˜¯å¾ˆåº•å±‚çš„linuxè·¨è¿›ç¨‹é€šè®¯æœºåˆ¶ï¼Œæ»¡è¶³nativeå±‚å¼€å‘éœ€æ±‚ã€‚

> [!question]- ä½ çŸ¥é“å»¶æ—¶æ¶ˆæ¯çš„åŸç†å—ï¼Ÿ
> 
> é¦–å…ˆæ˜¯ä¿¡æ¯æ’å…¥ï¼šä¼šæ ¹æ®whenå±æ€§ï¼ˆéœ€è¦å¤„ç†æ¶ˆæ¯çš„ç›¸å¯¹æ—¶é—´ï¼‰è¿›è¡Œæ’åºï¼Œè¶Šæ—©çš„æ—¶é—´çš„Messageæ’åœ¨é“¾è¡¨çš„è¶Šå‰é¢ï¼›
> 
> åœ¨å–æ¶ˆæ¯å¤„ç†æ—¶ï¼Œå¦‚æœæ—¶é—´è¿˜æ²¡åˆ°ï¼Œå°±ä¼‘çœ åˆ°æŒ‡å®šæ—¶é—´ï¼›å¦‚æœå½“å‰æ—¶é—´å·²ç»åˆ°äº†ï¼Œå°±è¿”å›è¿™ä¸ªæ¶ˆæ¯äº¤ç»™ Handler å»åˆ†å‘ï¼Œè¿™æ ·å°±å®ç°å¤„ç†å»¶æ—¶æ¶ˆæ¯äº†ã€‚

> [!question]- handler postDelayè¿™ä¸ªå»¶è¿Ÿæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ
> 
> 
> - [ ] #TODO handler postDelayè¿™ä¸ªå»¶è¿Ÿæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ ğŸ”¼

> [!question]- å¦‚ä½•ä¿è¯åœ¨msg.postDelayæƒ…å†µä¸‹ä¿è¯æ¶ˆæ¯æ¬¡åºï¼Ÿ
> 
> è¯¦æƒ…å¯¹åº”2.5.1å°èŠ‚ï¼Œå’Œä¸Šä¸€é¢˜æœ‰æ‰€è”ç³»ã€‚handler.postDelayä¸æ˜¯å»¶è¿Ÿä¸€æ®µæ—¶é—´å†æŠŠMessageæ”¾åˆ°MessageQueueä¸­ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥MessageQueueï¼Œæ ¹æ®whenå˜é‡ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰çš„å¤§å°æ’åºåœ¨æ¶ˆæ¯æ± çš„é“¾è¡¨é‡Œæ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œå¦‚æ­¤ä¹Ÿä¿è¯äº†æ¶ˆæ¯çš„æ¬¡åºçš„å‡†ç¡®æ€§ã€‚ä¹Ÿå°±æ˜¯æœ¬è´¨ä¸Šä»¥MessageQueueçš„æ—¶é—´é¡ºåºæ’åˆ—å’Œå”¤é†’çš„æ–¹å¼ç»“åˆå®ç°çš„ã€‚

> [!question]- æ›´æ–°UIçš„æ–¹å¼æœ‰å“ªäº›
> 
> è¿™ä¸ªé¢˜ç›®æ”¾åˆ°è¿™ä¸€èŠ‚ç¡®å®æ¯”è¾ƒé å‰ï¼Œä½†å› ä¸ºæœ¬èŠ‚ä»‹ç»äº†å…¶ä¸­çš„ä¸¤ä¸ªã€‚æ‰€ä»¥ä¹Ÿæä¸€ä¸‹ã€‚
> 
> -   Activity.runOnUiThread(Runnable)
> -   View.post(Runnable)ï¼ŒView.postDelay(Runnable, long)
> -   Handler
> -   AsyncTask
> -   Rxjava
> -   LiveData
> 

> [!question]- çº¿ç¨‹ã€Handlerã€Looperã€MessageQueue çš„å…³ç³»ï¼Ÿ
> 
> è¿™é‡Œè¿˜æ˜¯æœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª Looper ï¼ˆå¯è§2.1å°èŠ‚prepare()å‡½æ•°æ³¨é‡Š1çš„åˆ¤æ–­ï¼‰ï¼ŒåŒæ—¶å¯¹åº”ä¸€ä¸ª MessageQueueï¼Œå¯¹åº”å¤šä¸ª Handlerã€‚

> [!question]- å¤šä¸ªçº¿ç¨‹ç»™ MessageQueue å‘æ¶ˆæ¯ï¼Œå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ
> è§2.5.1 enqueueMessage()åœ¨æ’å…¥Messageçš„æ—¶å€™ä½¿ç”¨synchronizedæœºåˆ¶åŠ é”ã€‚

> [!question]- View.post å’Œ Handler.post çš„åŒºåˆ«ï¼Ÿ
> 
> #TODO 
> 
> - [x] View.postå’ŒHandler.postçš„åŒºåˆ«

> [!question]- ä½ çŸ¥é“IdleHandlerå—ï¼Ÿ
> 
> çœ‹çœ‹next()æºç ï¼š
> 
> [[Study Log/android_study/resources/next|next]]
> 
> IdleHandler æ˜¯é€šè¿‡ MessageQueue.addIdleHandler æ¥æ·»åŠ åˆ° MessageQueue çš„ï¼Œå‰é¢æåˆ°å½“ MessageQueue.next å½“å‰æ²¡æœ‰éœ€è¦å¤„ç†çš„æ¶ˆæ¯æ—¶å°±ä¼šè¿›å…¥ä¼‘çœ ï¼Œè€Œåœ¨è¿›å…¥ä¼‘çœ ä¹‹å‰å‘¢ï¼Œä¼šæ‰§è¡Œæ³¨é‡Š1ï¼Œæ­¤æ—¶å¦‚æœè¿”å›trueï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•åç»§ç»­ä¿ç•™ï¼Œä¸‹æ¬¡é˜Ÿåˆ—åˆç©ºé—²çš„æ—¶å€™ç»§ç»­è°ƒç”¨ã€‚å¦‚æœè¿”å›falseï¼Œå°±ä¼šåœ¨æ³¨é‡Š2å°†å½“å‰çš„idleråˆ é™¤ã€‚