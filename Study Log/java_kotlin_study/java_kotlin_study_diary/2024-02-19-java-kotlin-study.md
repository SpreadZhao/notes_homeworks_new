---
title: è‡ªå®šä¹‰Mutexçš„å¹¶å‘é—®é¢˜
date: 2024-02-19
tags:
  - language/coding
mtrace:
  - 2024-02-19
---

#date 2024-02-19

# è‡ªå®šä¹‰Mutexçš„å¹¶å‘é—®é¢˜

èµ·å› æ˜¯æˆ‘å†™ã€Šå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ã€‹ç¬”è®°çš„æ—¶å€™ï¼Œåœ¨[[Study Log/java_kotlin_study/concurrency_art/5_lock_in_java|5_lock_in_java]]è‡ªå·±å®ç°çš„ä¸€ä¸ªMutexï¼š

```kotlin
class LockTest {

    companion object {
        var i = 1
        var currThNum = 1
        val mutex = Mutex()
    }

    class MutexPrintThread(private val thNum: Int, private val otherNum: Int) : Thread("mutex-thread-$thNum") {
        override fun run() {
            while (i < 100) {
                mutex.lock()
                if (currThNum != thNum && mutex.isLocked) {
                    mutex.unlock()
                    continue
                }
                println("thread $thNum print $i")
                currThNum = otherNum
                i++
                mutex.unlock()
            }
        }
    }
}
```

ä¹Ÿæ˜¯å¤šçº¿ç¨‹äº¤æ›¿è¾“å‡ºçš„ä¾‹å­ã€‚ç›®å‰è¿™ä¸ªæ˜¯å¯ä»¥å·¥ä½œçš„ã€‚ä½†æ˜¯æˆ‘å‘ç°ï¼Œè¿™ä¸ª`mutex.lock()`æ€»æ˜¯æ„Ÿè§‰å¤šä½™ã€‚å› ä¸ºä½ å¦‚æœè·å–é”å¤±è´¥ï¼Œé‚£ä¹ˆå°±åœ¨è¿™é‡Œé”ä½äº†ï¼Œä¼šä¸æ–­å°è¯•è·å–ï¼Œç„¶åè·å–äº†å‘ç°å½“å‰è½®ä¸åˆ°æˆ‘æ‰“å°ï¼Œç„¶ååˆè§£é”å›å¤´é‡æ¥ã€‚ã€‚ã€‚

å¥½å§ï¼Œè¿™æ ·å®ç°å¥½åƒæ˜¯å¯¹çš„ã€‚å…¶å®æˆ‘å°±æ˜¯æƒ³æ”¹æˆtryLockçš„å®ç°ï¼š

```kotlin
while (i < 100) {
	val got = mutex.tryLock()
	if (currThNum != thNum) {
		if (got) mutex.unlock()
		continue
	}
	println("thread $thNum print $i")
	currThNum = otherNum
	i++
	mutex.unlock()
}
```

- [ ] #TODO è¿™æ ·å®ç°ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä¸ºå•¥ï¼Ÿå¦‚æœæˆ‘æ”¹æˆè¿™æ ·å°±å¯¹äº†ï¼š ğŸ”¼

```kotlin
while (i < 100) {
	val got = mutex.tryLock()
	if (!got) continue
	if (currThNum != thNum) {
		mutex.unlock()
		continue
	}
	println("thread $thNum print $i")
	currThNum = otherNum
	i++
	mutex.unlock()
}
```

ä¸è¿‡æˆ‘å€’æ˜¯æ€»ç»“å‡ºä¸€ä¸ªå…³äºè¿™ç§å¹¶å‘æ§åˆ¶çš„åŸºæœ¬æ€è·¯ï¼š

å…ˆä¿è¯è¿›å…¥åˆ°ä¸´ç•ŒåŒºï¼Œä¹‹åçš„äº‹æƒ…ä½ åœ¨ä¸´ç•ŒåŒºé‡Œç®¡ã€‚æ¯”å¦‚è¿™é‡Œçš„è·å–é”ï¼Œåªæœ‰gotä¸ºtrueçš„æ—¶å€™æ‰è¯æ˜æˆåŠŸè¿›å…¥åˆ°äº†ä¸´ç•ŒåŒºã€‚è€Œæˆ‘ä»¬è¦çŸ¥é“ï¼ŒcurrThNumè¿™ä¸ªå˜é‡æ¯«æ— ç–‘é—®æ˜¯ä¸´ç•ŒåŒºä¸­çš„å˜é‡ã€‚æ‰€ä»¥ï¼Œæ‰€æœ‰è¯»å†™è¿™ä¸ªå˜é‡çš„ä»£ç éƒ½è§†ä¸ºä¸´ç•ŒåŒºä»£ç ã€‚æ¢å¥è¯è¯´ï¼Œ**ä½ åœ¨åˆ¤æ–­æ˜¯ä¸æ˜¯æˆ‘è¯¥æ‰“å°çš„è¿™ä¸€åˆ»å¼€å§‹ï¼Œä½ å°±å·²ç»åœ¨ä¸´ç•ŒåŒºé‡Œé¢äº†**ã€‚æ‰€ä»¥ï¼Œä½ åº”è¯¥æƒ³çš„æ˜¯å¦‚æœä¸æ˜¯è½®åˆ°æˆ‘ï¼Œå°±é€€å‡ºä¸´ç•ŒåŒºã€‚ ^b08f74

~~è€Œé‚£ä¸ªé”™è¯¯çš„å®ç°ï¼Œå®ƒæŠŠé€€å‡ºä¸´ç•ŒåŒºçš„æ“ä½œ`if (got) mutex.unlock()`ç”¨ä¸€ä¸ªä¸´ç•ŒåŒºå¤–çš„`got`å˜é‡æ¥æ ‡è¯†ï¼Œè¿™æ ·çš„å†™æ³•ä»è®¾è®¡è§’åº¦ä¸Šå°±æ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚æ›´è‡´å‘½çš„é”™è¯¯æ˜¯ï¼Œ**å¦‚æœgotä¸ºfalseï¼Œé‚£ä¹ˆæœ¬èº«ä½ å°±æ²¡æœ‰æƒåˆ©è¿›å…¥ä¸´ç•ŒåŒº**ï¼ä½†æ˜¯é‚£ä¸ªé”™è¯¯çš„å®ç°å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚å®ƒåœ¨ä¸´ç•ŒåŒºé‡Œé¢æ‰è¯»gotå˜é‡ï¼Œå°±ç›¸å½“äº==æˆ‘åœ¨ä¸´ç•ŒåŒºé‡Œé¢åˆ¤æ–­æˆ‘æ˜¯ä¸æ˜¯è¯¥è¿›ä¸´ç•ŒåŒº==ï¼Œè¿™ä¹ˆå†™ä¸å‡ºé—®é¢˜æ‰æ€ªã€‚~~

> [!important] æˆ‘åœ¨ä¸´ç•ŒåŒºé‡Œé¢åˆ¤æ–­æˆ‘æ˜¯ä¸æ˜¯è¯¥è¿›ä¸´ç•ŒåŒº
> è¿™ä¸€æ®µä¹Ÿæ˜¯é”™è¯¯çš„ï¼ï¼ï¼ä¹‹åæŠŠè¿™é‡Œçš„å®ç°ç»™è¡¥ä¸Šã€‚å¹¶ä¸”è”ç³»[[Study Log/java_kotlin_study/concurrency_art/5_lock_in_java#^5a197f|5_lock_in_java]]

- [ ] #TODO é‚£ä¸ªé”™è¯¯çš„å®ç°ï¼Œth1è¿›å…¥äº†ä¸´ç•ŒåŒºï¼ŒåˆšåˆšæŠŠcurrThNumæ”¹æˆ2è¿˜æ²¡ç­‰é‡Šæ”¾é”çš„æ—¶å€™ï¼Œth2å¼€å§‹åˆ¤æ–­`if (currThNum != thNum)`ï¼Œé‚£ä¹ˆå¯¼è‡´th2ä¹Ÿèƒ½è¿›å…¥ä¸´ç•ŒåŒºå¹¶è¾“å‡ºã€‚è¿™æ ·ä¸´ç•ŒåŒºé‡Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚â• 2024-02-26 ğŸ”º 

ç°åœ¨æˆ‘ä»¬é‡æ–°æ¥ç†ä¸€éã€‚é¦–å…ˆï¼Œé”™è¯¯çš„ç‰ˆæœ¬é”™åœ¨å“ªå„¿ï¼Ÿä»ä¸Šé¢çš„todoå¯ä»¥çœ‹å‡ºæ¥ï¼Œ**é”æ˜¯å¦è·å¾—æˆåŠŸ**ï¼Œéœ€è¦ç«‹åˆ»åˆ¤å®šã€‚å…¶å®æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„ä¸¥æ ¼çš„é”çš„è·å–å’Œè®¿é—®ä¸´ç•ŒåŒºçš„è§„çŸ©ã€‚åªè¦ä½ çš„ç¨‹åºåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ä¹Ÿæ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå°±æ²¡é—®é¢˜ã€‚è¿™ä¸ªäº¤æ›¿æ‰“å°çš„åœºæ™¯ï¼Œå¯¹ã€è°è¯¥è¯»ã€æ˜¯éå¸¸æ•æ„Ÿçš„ã€‚åªæœ‰å‰é¢çš„äººå†™äº†ä¹‹åï¼Œæˆ‘ä»¬æ‰å…è®¸è¢«è¯»ã€‚æ‰€ä»¥è¯»è¿™ä¸ªå€¼çš„æ“ä½œ`if (currThNum != thNum)`æ˜¯ä¸å…è®¸åœ¨==é”è¿˜æ²¡ç¡®å®šæ˜¯å¦è·å¾—==çš„æ—¶å€™å°±æ‰§è¡Œçš„ã€‚ ^39f670

> [!error] Deprecated
> ä¸‹é¢åˆ æ‰çš„ä¸€å †çœ‹çœ‹å°±æˆï¼Œéƒ½æ˜¯é”™çš„ã€‚ç›´æ¥çœ‹æœ€åçš„æ€»ç»“ã€‚

~~ç†è§£äº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘å‘ç°ï¼Œå³ä½¿åªç”¨volatileæˆ‘ä»¬éƒ½èƒ½å®ç°ï¼~~

```kotlin
class OneToHundred2 {
    companion object {
        @Volatile
        var inCritical = false
        var currTh = 1
        var num = 1
    }

    class PrintThread(
        private val thNum: Int,
        private val nextThNum: Int
    ) : Thread("thread-$thNum") {
        override fun run() {
            while (num < 100) {
                if (inCritical) continue
                // ä»è¿™è¡Œå¼€å§‹è¿›å…¥ä¸´ç•ŒåŒº
                inCritical = true
                if (currTh != thNum) {
                    inCritical = false
                    continue
                }
                println("thread $thNum: $num")
                currTh = nextThNum
                num++
                inCritical = false
            }
        }
    }
}
```

~~è¿™ä¸ªç¨‹åºä¹Ÿèƒ½åšåˆ°å¤šä¸ªçº¿ç¨‹äº¤æ›¿è¾“å‡ºã€‚å¹¶ä¸”ä»…ä»…åªç”¨äº†ä¸€ä¸ªvolatileå˜é‡æ¥æ ‡è¯†ç›®å‰æ˜¯å¦å¤„äºä¸´ç•ŒåŒºã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ ·çš„å®ç°æ–¹å¼åªæœ‰åœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯æ­£ç¡®çš„ã€‚~~

~~ç°åœ¨æƒ³è±¡è¿™æ ·çš„æƒ…å†µï¼šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å‘ç°inCriticalä¸ºfalseï¼Œå› æ­¤éƒ½æ‰“ç®—æ‰§è¡Œ`inCritical = true`è¿™å¥è¯ã€‚ä½†æ˜¯ï¼Œç”±äºvolatileçš„å†™å†…å­˜è¯­ä¹‰ï¼ˆå†™åè¯»ï¼‰ï¼Œ ä¸¤ä¸ªçº¿ç¨‹ä¼šæ’é˜Ÿã€‚ç¬¬ä¸€ä¸ªçº¿ç¨‹èƒ½å°†inCriticalä»falseç½®ä¸ºtrueï¼Œè€Œç¬¬äºŒä¸ªçº¿ç¨‹ä¼šå°†inCriticalä»trueç½®ä¸ºtrueã€‚ä½†æ˜¯ç”±äºæœ‰`currTh != thNum`çš„åˆ¤æ–­ï¼Œæ‰€ä»¥æœ€ç»ˆä¹Ÿåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›è¡Œè¾“å‡ºï¼Œå…¶ä½™çº¿ç¨‹åªèƒ½å†æ¬¡è¿”å›åˆ°whileå¾ªç¯ã€‚~~

~~åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå·²ç»å‡ºç°äº†â€œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºâ€çš„æƒ…å†µã€‚æ‰€ä»¥è™½ç„¶è¿™æ ·åšçš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è¿™ä¸ªå®ç°å´å¾ˆtrickyã€‚~~

~~å¥½å§ï¼Œæˆ‘æŒºå‚»çš„ã€‚ä¸‹é¢çš„å®ç°ä¹Ÿæ­£å¸¸ï¼š~~

```kotlin
class OneToHundred2 {
    companion object {
        var currTh = 1
        var num = 1
    }

    class PrintThread(
        private val thNum: Int,
        private val nextThNum: Int
    ) : Thread("thread-$thNum") {
        override fun run() {
            while (num < 100) {
                if (currTh != thNum) continue
                println("thread $thNum: $num")
                num++
                currTh = nextThNum
            }
        }
    }
}
```

~~å¯¹æ¯”ä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬çš„å®ç°ï¼š[[Study Log/java_kotlin_study/java_kotlin_study_diary/lock_in_java#^legacy|lock_in_java]]ï¼Œæˆ‘å½“æ—¶çœŸæ˜¯ä¸ªsbã€‚æˆ‘å½“æ—¶çš„å®ç°ï¼Œå¦‚æœ`currTh != thNum`çš„è¯ï¼Œç›´æ¥åœ¨é‚£é‡Œç©ºè½¬ã€‚è¿™å°±å¯¼è‡´äº†~~

è¡Œå§ï¼Œè¯´è¿™ä¹ˆå¤šä¹Ÿç´¯äº†ï¼Œå‘ç°é”™è¯¯è¶Šè¯´è¶Šå¤šã€‚æ‰€å¹¸è¿™é‡Œç›´æ¥æ¥ä¸€ä¸ªæ€»ç»“ï¼š

1. å…ˆè¿›å…¥ä¸´ç•ŒåŒºï¼Œåœ¨ä¸´ç•ŒåŒºé‡Œé¢å†åˆ¤æ–­æ˜¯å¦è¦é€€å‡ºä¸´ç•ŒåŒºã€‚è¿™ä¸ªæ“ä½œæ˜¯æ­£ç¡®çš„ï¼›
2. æˆ‘ä¸Šé¢åˆ æ‰çš„é‚£äº›å®ç°ï¼Œæ— è®ºæ˜¯volatileçš„ï¼Œè¿˜æ˜¯å•¥ä¹Ÿæ²¡æœ‰çš„ï¼ŒåŒ…æ‹¬æˆ‘ä¹‹å‰å®ç°çš„é‚£ä¸ª[[Study Log/java_kotlin_study/java_kotlin_study_diary/lock_in_java#^legacy|lock_in_java]]ï¼Œéƒ½æ˜¯é”™è¯¯çš„ã€‚é”™å°±é”™åœ¨æ²¡æœ‰æŒ‰ç…§ç¬¬ä¸€æ¡çš„è§„çŸ©æ¥ã€‚ä½ å¯ä»¥è¯•è¯•ï¼Œå¦‚æœå¹¶å‘é‡ä¸€æ—¦æé«˜ï¼Œé‚£ä¹ˆå‡ºé”™çš„æ¦‚ç‡ä¼šæ˜æ˜¾å¢åŠ ã€‚

è€Œæˆ‘ä»¬è‡ªå·±å®ç°çš„é‚£ä¸ªMutexï¼Œä¸ç®¡æ˜¯tryLock()çš„ç‰ˆæœ¬è¿˜æ˜¯lock()çš„ç‰ˆæœ¬ï¼Œä¸ç®¡ä½ ç”¨å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œç”šè‡³æ˜¯99ä¸ªï¼Œæœ€åçš„ç»“æœä¹Ÿéƒ½æ˜¯æ­£ç¡®çš„ã€‚

é‚£ä¹ˆï¼ŒtryLock()çš„ç‰ˆæœ¬å’Œlock()çš„ç‰ˆæœ¬çœŸæ­£çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å°±æ˜¯ï¼ŒäºŒè€…åœ¨è·å–ä¸åˆ°é”æ—¶çš„è¡Œä¸ºä¸åŒã€‚æˆ‘ä»¬æŠ½ç¦»å‡ºæ¥çœ‹ï¼š

```kotlin
// lock()ç‰ˆæœ¬
mutex.lock()
```

```kotlin
// tryLock()ç‰ˆæœ¬
val got = mutex.tryLock()
if (!got) continue
```

lock()ç‰ˆæœ¬åœ¨è·å–å¤±è´¥æ—¶ä¼šç›´æ¥é˜»å¡åœ¨è¿™é‡Œï¼›è€ŒtryLock()ç‰ˆæœ¬åœ¨è·å–å¤±è´¥æ—¶ä¼šç»§ç»­æ‰§è¡Œï¼Œåªä¸è¿‡ä¼šè¿”å›ä¸€ä¸ªfalseã€‚è¿™ä¸ªå…¶å®å°±æ˜¯busyWaitingå’Œsleep \& wakeupçš„åŒºåˆ«ã€‚æ‰€ä»¥ï¼Œé¢è¯•å®˜åº”è¯¥æ˜¯å€¾å‘äºç¬¬ä¸€ç§å®ç°ï¼Œå› ä¸ºæ›´é«˜çº§ï¼›åŒæ—¶ï¼Œåœ¨çº¿ç¨‹æ›´å¤šçš„æ—¶å€™ï¼Œæ¯”å¦‚99ä¸ªçº¿ç¨‹ï¼Œ**lock()çš„ç‰ˆæœ¬å…¶å®æ˜¯æ¯”tryLock()æ›´å¿«çš„**ã€‚è€Œä¸”è¦å¿«éå¸¸å¤šï¼å°±æ˜¯å› ä¸ºtryLock()ç”±äºæ˜¯éé˜»å¡çš„ï¼Œå¯¼è‡´æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨å¿™ç€æŠ¢é”ï¼Œé‚£ä¹ˆä¸€æ—¦æŠ¢é”çš„äººå¤šäº†ï¼Œé”å°±æ›´ä¸å®¹æ˜“è¢«æ­£ç¡®çš„äººè·å¾—äº†ã€‚è¿™æ ·åè€Œæ‹–ç´¯äº†æ€§èƒ½ã€‚

å¦å¤–ï¼Œlock()ç‰ˆæœ¬ä¸­åˆ¤æ–­çº¿ç¨‹çš„æ—¶å€™ï¼š

```kotlin
if (currThNum != thNum && mutex.isLocked) {
	mutex.unlock()
	continue
}
```

åé¢çš„`mutex.isLocked`æ˜¯å¤šä½™çš„ã€‚å› ä¸ºåœ¨é˜»å¡çš„æƒ…å†µä¸‹ï¼Œç¨‹åºå¦‚æœä¸é˜»å¡å”¯ä¸€çš„å¯èƒ½å°±æ˜¯å·²ç»è·å¾—äº†é”ã€‚æ‰€ä»¥è¿™å¥è¯æ°¸è¿œæ˜¯trueã€‚