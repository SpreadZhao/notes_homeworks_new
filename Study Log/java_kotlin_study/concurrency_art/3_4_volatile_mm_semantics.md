---
title: 3.4 volatileå†…å­˜è¯­ä¹‰
chapter: "3"
order: "7"
---

## 3.4 volatileçš„å†…å­˜è¯­ä¹‰

### 3.4.1 volatileç‰¹æ€§

æ¥ä¸‹æ¥æˆ‘å†™ä¸€ä¸ªä»£ç ã€‚è¿™ä¸ªä»£ç åœ¨ä¹‹å‰ä¹Ÿå†™è¿‡ç±»ä¼¼çš„ï¼š[[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal#2.3.2 Javaå¦‚ä½•å®ç°åŸå­æ“ä½œï¼ˆCASï¼‰|2_concurrency_internal]]ã€‚å…¶å®å°±æ˜¯å¤šä¸ªçº¿ç¨‹å»å¢åŠ ä¸€ä¸ªæ•°å­—çš„æ“ä½œï¼š

```kotlin
class VolatileExample {

  private var _integer = 0

  val integer: Int
    get() = _integer

  fun increment() {
    _integer++
  }

  companion object {
    fun test() {
      val volatileExample = VolatileExample()
      // æ‰€æœ‰çš„çº¿ç¨‹
      val threads = arrayListOf<Thread>()
      // åˆ›å»º100ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ç´¯åŠ 100æ¬¡integer
      repeat(100) {
        val t = Thread {
          repeat(100) { volatileExample.increment() }
          println("thread${it} result: ${volatileExample.integer}")
        }
        threads.add(t)
      }
      // å¼€å§‹æ‰€æœ‰çº¿ç¨‹
      threads.forEach { it.start() }
      // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
      threads.forEach {
        try {
          it.join()
        } catch (e: InterruptedException) {
          e.printStackTrace()
        }
      }
      // è¾“å‡ºæœ€ç»ˆçš„ç»“æœ
      println("final result: ${volatileExample.integer}")
    }
  }

}
```

è¿™é‡Œæˆ‘ä¸€å¼€å§‹ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ªçº¿ç¨‹æ¥æ¨¡æ‹Ÿã€‚ä½†æ˜¯å‘ç°ï¼Œä¸¤ä¸ªçº¿ç¨‹å¹¶ä¸ä¼šæš´éœ²å‡ºè¿™ä¸ªé—®é¢˜ã€‚å› ä¸ºCPUå®åœ¨æ˜¯å¤ªå¿«äº†ã€‚æ‰€ä»¥æˆ‘æäº†100ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ç´¯åŠ 100æ¬¡integerã€‚ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œæœ€ç»ˆçš„ç­”æ¡ˆåº”è¯¥æ˜¯10000ï¼Œä½†æ˜¾ç„¶ä¸ä¼šæ˜¯çš„ï¼š

```
thread0 result: 100
thread5 result: 300
thread3 result: 400
thread8 result: 500
thread1 result: 200
thread9 result: 600
thread11 result: 700
... ...
thread90 result: 9175
thread89 result: 8975
thread87 result: 8775
final result: 9975
```

è¿™æ˜¯æˆ‘éšä¾¿æ‰§è¡Œä¸€æ¬¡çš„ç»“æœã€‚æ˜¾ç„¶æ¯æ¬¡æ‰§è¡Œçš„ç»“æœä¹Ÿéƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•è®©æ‰§è¡Œç»“æœå°±æ˜¯10000å‘¢ï¼Ÿä¹‹å‰ï¼ˆ[[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal#2.3.2 Javaå¦‚ä½•å®ç°åŸå­æ“ä½œï¼ˆCASï¼‰|2.3.2 Javaå¦‚ä½•å®ç°åŸå­æ“ä½œï¼ˆCASï¼‰]]ï¼‰æˆ‘ä»¬æ˜¯æ€ä¹ˆåšçš„ï¼ŸCASï¼ä½†æ˜¯ç°åœ¨ï¼Œæˆ‘ä»¬ç”¨volatileæ¥è¯•ä¸€è¯•ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119150520.png|300]]

ä»…ä»…æ˜¯åœ¨integerä¸Šé¢åŠ ä¸€ä¸ªvolatileï¼Œæˆ‘ä»¬å†è¯•ä¸€è¯•ã€‚emmï¼Œç»“æœæ˜¯ï¼Œæœ‰çš„æ—¶å€™æ˜¯10000ï¼Œæœ‰çš„æ—¶å€™åˆä¸æ˜¯ã€‚é‚£ä¹ˆè¿™å°±æ„å‘³ç€ï¼Œvolatileèµ·ä½œç”¨äº†ï¼Œä½†æ²¡æœ‰å®Œå…¨èµ·ä½œç”¨ã€‚é‚£ä¹ˆï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

å¦å¤–ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªvolatileå»æ‰ï¼Œç„¶ååœ¨increment()æ–¹æ³•ä¸ŠåŠ ä¸Šsyncronizedï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119151046.png|300]]

è¿™ä¸‹ä¸ç®¡ä½ æ€ä¹ˆæ‰§è¡Œï¼Œæœ€åçš„ç»“æœéƒ½æ˜¯10000äº†ã€‚è¿™ä¸ªæ“ä½œå…¶å®å¥½ç†è§£ï¼šå› ä¸º100ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½è¦è·å¾—é”ï¼Œè€Œç«äº‰çš„é”æ˜¯åŒä¸€æŠŠï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡volatileExampleã€‚è‡ªç„¶å°±ä¸ä¼šå‡ºç°é‚£æ ·çš„é—®é¢˜ã€‚

ä½†æ˜¯ä¸ºä»€ä¹ˆvolatileæ²¡æœ‰å®Œå…¨è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿåœ¨ç¬¬äºŒç« ä¸­ï¼ˆ[[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal|2_concurrency_internal]]ï¼‰ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»è¿‡volatileçš„ä¸€äº›ç‰¹æ€§ã€‚æ¯”å¦‚å®ƒæ˜¯æ€ä¹ˆå¢åŠ é‚£ä¸ªlockæŒ‡ä»¤çš„ï¼Œé‚£ä¸ªæŒ‡ä»¤åˆæœ‰ä»€ä¹ˆç”¨ï¼›åœ¨ç¬¬ä¸‰ç« ä¸­ï¼ˆ[[Study Log/java_kotlin_study/concurrency_art/3_1_JMM_basic#3.1.3 happens-before|3.1.3 happens-before]]ï¼‰ï¼Œæˆ‘ä»¬åˆä»‹ç»äº†ä¸€äº›happens-beforeè§„åˆ™ï¼Œå…¶ä¸­å°±æåˆ°äº†volatileçš„è¿™ä¸ªè§„åˆ™ï¼š

```note-imp
å¯¹ä¸€ä¸ªvolatileçš„å†™ï¼Œhappens-beforeä»»æ„ä¹‹åå¯¹å®ƒçš„è¯»ã€‚
```

ä¸€å®šè¦æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå†™â€å’Œâ€œè¯»â€ï¼ï¼ï¼è€Œä½ æƒ³ä¸€æƒ³ï¼Œ`integer++`è¿™æ ·çš„æŒ‡ä»¤ï¼ŒçœŸçš„ä»…ä»…æ˜¯å†™å’Œè¯»å—ï¼Ÿ

æˆ‘ä»¬å°†è¿™ä¸ªæŒ‡ä»¤ç¿»è¯‘å‡ºæ¥ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

```kotlin
var temp = get()
temp += 1
set(temp)
```

å¯¹å§ï¼å…¶å®`integer++`è¿™æ ·çš„æŒ‡ä»¤ï¼Œæ˜¯æ‹¿åˆ°åŸå§‹çš„å€¼ï¼Œç„¶ååœ¨ä¸Šé¢åŠ ä¸Š1ï¼Œç„¶åå†å†™å›åˆ°åŸæ¥çš„å˜é‡é‡Œã€‚é‚£ä¹ˆï¼Œè¿™é‡ŒçœŸçš„åªæ˜¯å†™å’Œè¯»å—ï¼Ÿä¸€çœ¼å°±çœ‹å‡ºæ¥äº†å§ï¼

```kotlin
var temp = get() // è¯»
temp += 1 // What's this???
set(temp) // å†™
```

æˆ‘ä»¬å¯ä»¥å†è¿›ä¸€æ­¥çŒœæµ‹ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆvolatileèƒ½ä¿è¯é‚£ä¸ªhappens-beforeè§„åˆ™ã€‚æ—¢ç„¶è¯»å’Œå†™å¯ä»¥æ»¡è¶³è¿™ç§è§„åˆ™ï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯è¯´ï¼Œ**å®ƒç»™è¿™ä¸¤ä¸ªæ“ä½œåšäº†åŒæ­¥çš„å‘€**ï¼ï¼ï¼

æ¢å¥è¯æ¥è¯´ï¼Œ**å°±æ˜¯ä¸Šé¢çš„get()æ–¹æ³•å’Œset()æ–¹æ³•ï¼Œå…¶å®==ç›¸å½“äº==æ˜¯syncronizedä¿®é¥°çš„**ï¼æŒ‰ç…§è¿™ä¸ªçŒœæµ‹ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªvolatileçš„å˜é‡ï¼š

```kotlin
class VolatileExample {
	@Volatile
	var integer
}
```

**ç»™è¿™ä¸ªå˜é‡åŠ ä¸Švolatileï¼Œå…¶å®å°±ç­‰ä»·äºï¼š**

```kotlin
class VolatileExample {
	var integer

	@Syncronized
	fun get() = integer

	@Syncronized
	fun set(i: Int) {
		integer = i
	}
}
```

> [!important]
:fas_up_long:è¿™æ˜¯æˆ‘ä»¬è¿™ä¸€ç« æœ€é‡è¦çš„ä¸œè¥¿ï¼ï¼ï¼

å› ä¸ºå¤ªé‡è¦äº†ï¼Œè¿™é‡Œæˆ‘å†ç»™å‡ºä¹¦ä¸Šçš„Javaç‰ˆæœ¬ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119163747.png]]

æˆ‘ä»¬åˆšåˆšå†™çš„é‚£ä¸ªincrement()æ–¹æ³•ï¼Œå¦‚æœåŠ äº†volatileï¼Œå°±ä¼šè¢«ç¿»è¯‘æˆä¸Šå›¾çš„getAndIncrement()æ–¹æ³•ã€‚volatileå› ä¸ºåªå¯¹è¯»å†™åšäº†åŒæ­¥ï¼Œå› æ­¤ï¼Œè¿™ç§++çš„æ“ä½œå¹¶ä¸ä¼šè¿›è¡ŒåŒæ­¥ã€‚æ‰€ä»¥ä¸‹é¢ä¸‰ä¸ªæ“ä½œå°±ä¼šè¢«å¤šä¸ªçº¿ç¨‹æ¥ä¹±åºæ‰§è¡Œï¼š

```kotlin
var temp = get()
temp += 1
set(temp)
```

> [!info]
> è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆCASèƒ½åšåˆ°è¿™ä¸€ç‚¹çš„åŸå› ã€‚å› ä¸ºCASè‡ªå¸¦çš„incrementAndGet()æ–¹æ³•æœ¬èº«å°±æ˜¯**å¯¹è¿™ä¸‰æ­¥æ“ä½œæ•´ä½“çš„åŒæ­¥**ã€‚

ä¹Ÿæ­£æ˜¯å› ä¸ºvolatileå¯¹è¯»å†™åšäº†åŒæ­¥ï¼Œæˆ‘ä»¬æ‰è¯´volatileå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

* **å¯è§æ€§**ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ï¼›
* **åŸå­æ€§**ï¼šå¯¹ä»»æ„å•ä¸ªvolatileå˜é‡çš„**è¯»/å†™**å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äºvolatile++è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚

### 3.4.2 volatileçš„å†…å­˜è¯­ä¹‰

ç°åœ¨æˆ‘ä»¬æ¥è¯´ä¹‹å‰çš„å¦ä¸€ä¸ªä¾‹å­ï¼š[[Study Log/java_kotlin_study/concurrency_art/3_3_sequential_consistency#3.3.3 åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ|3.3.3 åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ]]

è¿™ä¸ªä¾‹å­å¯ä»¥ç”¨volatileæ¥è§£å†³å—ï¼Ÿ

```kotlin
class VolatileExample2 {
  var a = 1

  @Volatile
  var flag = false

  fun writer() {
    a = 3
    Thread.sleep(3000)
    flag = true
  }

  fun reader() {
    if (flag) {
      val i = a * a
      println("i: $i")
    } else {
      println("I can't read it!")
    }
  }

  companion object {
    fun test() {
      val example = VolatileExample2()
      thread { example.writer() }
      thread { example.reader() }
    }
  }
}
```

æˆ‘ä»¬ä»…ä»…ç»™flagå˜é‡åŠ ä¸Švolatileå°±èƒ½æˆåŠŸå—ï¼Ÿæ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„æ¨è®ºï¼Œç­”æ¡ˆæ˜¾ç„¶æ˜¯ä¸å¯ä»¥ã€‚å› ä¸ºvolatileåªèƒ½ä¿è¯è¯»å’Œå†™flagå˜é‡æ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸èƒ½ä¿è¯writer()å…ˆäºreader()æ‰§è¡Œã€‚

- [?] é‚£ä¹ˆï¼Œvolatileåœ¨è¿™ä¸ªåœ°æ–¹åˆ°åº•èµ·äº†ä»€ä¹ˆä½œç”¨ï¼Ÿå›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå›ç­”ä¸€ä¸ªé—®é¢˜ï¼š*ä¹‹å‰é‚£ä¸ªä¸¤ä¸ªsyncronizedçš„ç‰ˆæœ¬ï¼ŒçœŸçš„å°±èƒ½ä¿è¯ä¸€å®šæ­£ç¡®å—*ï¼Ÿ

- [I] **ä»¥ä¸‹çš„ä»‹ç»ç»Ÿç»Ÿè¯´çš„æ˜¯ä¸¤ä¸ªsyncronizedç‰ˆæœ¬ï¼Œè€Œvolatileçš„ç‰ˆæœ¬ä¼šåœ¨ä¹‹åä»‹ç»ã€‚**

æŒ‰ç…§è°ƒç”¨é¡ºåºæ¥è®²ï¼Œç¡®å®å‡ ä¹å¯ä»¥ä¿è¯writer()æ–¹æ³•åœ¨reader()æ–¹æ³•ä¹‹å‰æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦çœ‹çœ‹è¿™ä¸ªsyncronizedçš„è¾¹ç•Œï¼š

åœ¨writer()æ–¹æ³•ä¸­ï¼Œè¾¹ç•Œæ˜¯`flag = true`è¿™å¥è¯ã€‚æ„æ€å°±æ˜¯å°†è¿™ä¸ªå˜é‡æ”¹ä¸ºtrueï¼Œå¹¶å†™å›åˆ°å†…å­˜ä¸­ã€‚æ ¹æ®ä¹‹å‰æˆ‘ä»¬è®²è¿‡çš„å†…å­˜æ¨¡å‹ï¼ˆ[[Study Log/java_kotlin_study/concurrency_art/3_1_JMM_basic#3.1.1 JMM|3.1.1 JMM]]ï¼‰ï¼Œæˆ‘ä»¬èƒ½çŸ¥é“ï¼Œè¿™å¥è¯å®é™…ä¸ŠåŒ…å«äº†ä¸¤æ­¥æ“ä½œï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2023-11-19 17.07.15.excalidraw.png]]

è€Œæ ¹æ®ä¹‹å‰æ‰€è¯´ï¼ˆ[[Study Log/java_kotlin_study/concurrency_art/3_3_sequential_consistency#^0578f5|3_3_sequential_consistency]]ï¼‰ï¼Œè¿™ä¸¤æ­¥æ“ä½œæ˜¯**æ— æ³•é€ƒé€¸åˆ°syncronizedå¤–é¢**çš„ã€‚æ‰€ä»¥ï¼Œåœ¨çº¿ç¨‹Bæ‰§è¡Œreader()ä¹‹å‰ï¼Œå†…å­˜çš„æ¨¡å‹**ä¸€å®š**æ˜¯ä¸‹é¢çš„æƒ…å†µï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2023-11-19 17.12.19.excalidraw.png]]

é‚£ä¹ˆæ¥ä¸‹æ¥çº¿ç¨‹Bæ‰§è¡Œçš„æ—¶å€™ï¼Œå°±ä¸ä¼šæœ‰ä»»ä½•é—®é¢˜äº†ï¼š**å®ƒä¸€å®šä¼šè¯»åˆ°flagä¸ºtrueï¼Œä»è€ŒæˆåŠŸè·å–åˆ°æ–°çš„açš„å€¼**ã€‚æ‰€ä»¥ï¼Œä¸Šé¢çš„ç­”æ¡ˆå®é™…ä¸Šæ˜¯ï¼šæ­£ç¡®çš„ã€‚

---

ç°åœ¨æŠŠç›®å…‰è½¬å›åˆ°volatileçš„ç‰ˆæœ¬ä¸Šï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿvolatileè™½ç„¶æ²¡èƒ½ä¿è¯è¿™ä¸ªæ‰§è¡Œé¡ºåºä¸€æ ·ï¼Œä½†æ˜¯åˆä¿è¯äº†ä»€ä¹ˆå‘¢ï¼Ÿç°åœ¨å›æƒ³ä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å¯¹äºvolatileæœ¬è´¨çš„ä»‹ç»ï¼š[[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal#^35e1b7|2_concurrency_internal]] å’Œ [[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal#^ce42bc|2_concurrency_internal]]

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå€¼åœ¨**å†™**çš„æ—¶å€™ï¼Œä¼šå°†æ‰€æœ‰ç¼“å­˜éƒ½æ›´æ–°ï¼Œå°†æœ¬çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¹Ÿæ›´æ–°ï¼Œå¹¶æœ€ç»ˆå°†è¿™ä¸ªæ›´æ–°ä¹ŸåŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ã€‚

é‚£ä¹ˆï¼Œè¯»çš„æ—¶å€™å‘¢ï¼Ÿå¦‚æœè¯•å›¾è¯»ä¸€ä¸ªvolatileå˜é‡ï¼Œåˆä¼šåšå‡ºä»€ä¹ˆåˆ¤æ–­å‘¢ï¼Ÿç»§ç»­å›æƒ³ä¹‹å‰æ‰€è¯´ï¼š[[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal#^a73a5c|2_concurrency_internal]] å’Œ [[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal#^cd709e|2_concurrency_internal]]

ä¹‹å‰æ‰€åŸ‹ä¸‹çš„ä¼ç¬”ï¼Œç»ˆäºåœ¨æ­¤æ­å¼€ã€‚å½“çº¿ç¨‹è¯•å›¾**è¯»**ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼Œæ‰€ä½œçš„ç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯è®©è‡ªå·±æœ¬åœ°å†…å­˜ä¸­çš„é‚£ä¸ªå˜é‡æ— æ•ˆï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2023-11-19 17.34.18.excalidraw.png]]

æ‰€ä»¥ï¼ŒvolatileçœŸæ­£ä¿è¯çš„äº‹æƒ…å…¶å®æ˜¯ï¼š**ä½ è‡³å°‘å¾—è®©æˆ‘è¯»åˆ°ä¸€ä¸ªä¹‹å‰çº¿ç¨‹æ›´æ–°è¿‡çš„æ–°å€¼å§**ï¼

è™½ç„¶ä¹‹å‰å¯èƒ½æ²¡æœ‰çº¿ç¨‹æ›´æ–°è¿‡ï¼Œè™½ç„¶æˆ‘è¯»åˆ°çš„ä¾æ—§å¯èƒ½æ˜¯é”™è¯¯çš„å€¼ã€‚ä½†æ˜¯æˆ‘å´æ˜¯åœ¨ä¸»å­˜ä¸­å»è¯»çš„ï¼Œè€Œè¿™å°±ä»£è¡¨ç€ï¼Œæˆ‘è¯»åˆ°è¿‡çš„ï¼Œè‡³å°‘ä¹Ÿä¸æ˜¯æˆ‘æœ¬åœ°å†…å­˜ä¸­çš„å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯èƒ½è¢«å…¶å®ƒçº¿ç¨‹å†™å…¥è¿‡çš„å€¼ï¼Œ**å› ä¸ºvolatileçš„å†™æœ€ç»ˆå°±æ˜¯ä¼šåˆ°ä¸»å­˜é‡Œå»å‘€**ï¼

å®é™…ä¸Šï¼Œè¿™ä¸ªflagçš„ä¾‹å­ä¸¾å¾—å¹¶ä¸æ˜¯å¾ˆæ°å½“ï¼Œå®ƒæ²¡æ³•å¾ˆç›´è§‚åœ°ä½“ç°å‡ºvolatileçš„ä½œç”¨ã€‚ä½†æ˜¯æˆ‘ä¹Ÿå°½é‡è§£é‡Šåˆ°å®Œç¾äº†ã€‚

- [x] #TODO #urgency/high å¦‚æœä¹‹åæœ‰ä¸€ä¸ªå®Œç¾çš„volatileçš„ä½¿ç”¨ä¾‹å­ï¼Œæˆ‘ä¼šè´´åœ¨è¿™é‡Œã€‚

> [!todo] å¦‚æœä¹‹åæœ‰ä¸€ä¸ªå®Œç¾çš„volatileçš„ä½¿ç”¨ä¾‹å­ï¼Œæˆ‘ä¼šè´´åœ¨è¿™é‡Œã€‚
> * #date 2024-01-07 æœ‰äº†ï¼Œçœ‹ä¸‹é¢è¿™ä¸ªæ—¥æœŸçš„è¡¥å……ã€‚

> [!summary] åšä¸€ä¸ªæ€»ç»“
> 
> é¦–å…ˆï¼Œæ˜¯volatileåˆ°åº•èƒ½åšåˆ°ä»€ä¹ˆäº‹æƒ…ï¼š
> 
> 1. å†™çš„æ—¶å€™ï¼Œä¸€è‚¡è„‘å„¿ä»Cacheåˆ°æœ¬åœ°å†…å­˜åˆ°ä¸»å­˜ä¸€æ¡é¾™åˆ·æ–°ï¼Œå¹¶ä¸”è¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­çš„ï¼ˆä¹Ÿå°±æ˜¯å¯¹å•ä¸ªå˜é‡**å†™æ“ä½œçš„åŸå­æ€§**ï¼‰ï¼›
> 2. è¯»çš„æ—¶å€™ï¼Œè®©**è¯»å®ƒçš„çº¿ç¨‹çš„**æœ¬åœ°å†…å­˜ç›´æ¥æ— æ•ˆï¼Œå°±æ˜¯è¦ä»ä¸»å­˜ä¸­å»è¯»ï¼ˆä¹Ÿå°±æ˜¯**è¯»çš„åŸå­æ€§plusç‰ˆ**ï¼‰ã€‚
> 
> ç„¶åï¼Œå°±æ˜¯volatileçš„å†…å­˜è¯­ä¹‰çš„æ€»ç»“ï¼š
> 
> * çº¿ç¨‹ A å†™ä¸€ä¸ª volatile å˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹ A å‘æ¥ä¸‹æ¥å°†è¦è¯»è¿™ä¸ª volatile å˜é‡çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆå…¶å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚
> * çº¿ç¨‹ B è¯»ä¸€ä¸ª volatile å˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹ B æ¥æ”¶äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆåœ¨å†™è¿™ä¸ª volatile å˜é‡ä¹‹å‰å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚
> * çº¿ç¨‹ A å†™ä¸€ä¸ª volatile å˜é‡ï¼Œéšåçº¿ç¨‹ B è¯»è¿™ä¸ª volatile å˜é‡ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹ A é€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹ B å‘é€æ¶ˆæ¯ã€‚

å¦å¤–ï¼Œæˆ‘é—æ¼äº†ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ï¼Œè¿™é‡Œè¡¥ä¸Šã€‚å›åˆ°ä¹‹å‰é‚£å¼ å›¾ï¼Œå®Œæ•´çš„å›¾ï¼š ^61ac91

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2023-11-19 17.48.21.excalidraw.png]]

> [!question]
> æˆ‘çš„çŒœæµ‹ï¼švolatileçš„ä½¿ç”¨ï¼Œæ˜¯å¦å»ºç«‹åœ¨ä»£ç çš„æ‰§è¡Œé¡ºåºæ˜¯100%ç¡®å®šçš„å‰æä¸‹ï¼Ÿåˆæˆ–è€…æ˜¯æˆ‘ä¸å…³å¿ƒä»£ç æ‰§è¡Œé¡ºåºçš„å‰æä¸‹ï¼Ÿå› ä¸ºåªæœ‰è¿™ä¸ªæƒ…å†µä¸‹ï¼Œå•ç‹¬ä½¿ç”¨volatileæ‰èƒ½å‘æŒ¥å‡ºå®ƒå¯¹å˜é‡çš„å¯è§æ€§æ§åˆ¶ã€‚

è™½ç„¶æˆ‘ä»¬çš„volatileä¾‹å­å¹¶ä¸èƒ½ä¿è¯è¿™ä¸ªå›¾ä¸­æè¿°çš„ï¼Œä½†æ˜¯å§‘ä¸”å…ˆå½“å®ƒèƒ½å§ã€‚æ¯•ç«Ÿä¹¦ä¸Šä¹Ÿæ˜¯å‡è®¾writer()å…ˆäºreader()æ‰§è¡Œã€‚

æˆ‘ä»¬ä¸€ç›´çœ‹flagå»äº†ï¼Œè¿™ä¸ªa = 3è¿˜æ²¡çœ‹å‘¢ï¼å®ƒå¹¶ä¸æ˜¯volatileå˜é‡ï¼Œä½†æ˜¯ä¾ç„¶éšç€æˆ‘ä»¬çš„æ“ä½œç»™åˆ·æ–°äº†ä¸Šå»ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿ

ä¹‹å‰æˆ‘ä»¬ä¹Ÿè¯´äº†ï¼Œåœ¨å†™volatileå˜é‡çš„æ—¶å€™ï¼Œæœ¬åœ°å†…å­˜**æ‰€æœ‰**çš„æ”¹å˜éƒ½ä¼šä¸€è‚¡è„‘å„¿flushåˆ°ä¸»å­˜ä¸­å»ã€‚è¿™æ„å‘³ç€ï¼Œ**Açº¿ç¨‹åœ¨å†™è¿™ä¸ªvolatileä¹‹å‰å¯¹==æ‰€æœ‰å…±äº«å˜é‡==çš„æ”¹å˜ï¼Œä¹Ÿæ˜¯èƒ½ä¼ é€’åˆ°Bçº¿ç¨‹é‚£é‡Œå»çš„**ã€‚ ^a3a78e

è¿™ä¸ªè¿‡ç¨‹ï¼Œä¹Ÿåƒæ˜¯å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ä¸€æ ·ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2023-11-19 17.54.13.excalidraw.png]]

### 3.4.3 volatileå†…å­˜è¯­ä¹‰çš„å®ç°

ä¸‹é¢æ¥è¯´ä¸€è¯´ï¼Œvolatileåˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ã€‚æƒ³å½“ç„¶ï¼Œè¿™é‡Œä¸€å®šä¼šæœ‰å¯¹äºé‡æ’åºçš„é™åˆ¶ã€‚ä¸‹é¢å°±æ¥è¯´ä¸€è¯´ï¼ŒJMMå¯¹**ç¼–è¯‘å™¨**æŒ‡å®šçš„volatileé‡æ’åºè§„åˆ™ï¼ˆå¹¶ä¸æ˜¯å¯¹CPUåˆ¶å®šçš„ï¼Œè²Œä¼¼ä¹Ÿåˆ¶å®šä¸äº†ï¼‰ã€‚

å‡è®¾æœ‰ä¸¤ä¸ªæ“ä½œ

```
ins1
ins2
```

å…¶å®å°±æ˜¯ä¸¤è¡Œæ¯”è¾ƒç®€å•çš„ä»£ç ã€‚é‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œå¦‚æœæ˜¯ä¸åŒçš„æŒ‡ä»¤ï¼Œèƒ½å¦é‡æ’åºä¹Ÿæœ‰ç€ä¸ä¸€æ ·çš„è¦æ±‚ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119180949.png]]

æ¯”å¦‚ï¼Œå½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯æ™®é€šè¯»/å†™çš„æ—¶å€™ï¼Œå¦‚æœç¬¬äºŒä¸ªæ“ä½œæ˜¯å¯¹volatileçš„å†™ï¼Œé‚£ä¹ˆå°±ä¸å…è®¸é‡æ’åºã€‚æ¯”å¦‚ï¼š

```kotlin
class Test {
	@Volatile
	var i = 0

	var a = 1

	companion object {
		fun test() {
			a = 2 // æ™®é€šå†™
			i = 2 // volatileå†™
		}
	}
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œtest()é‡Œé¢çš„ä»£ç å°±ä¸å…è®¸é‡æ’åºäº†ã€‚

æˆ‘ä»¬æ¥è§‚å¯Ÿä¸€ä¸‹è¿™ä¸ªè¡¨æ ¼ï¼Œå¾—å‡ºä¸€äº›ç»“è®ºã€‚é¦–å…ˆæ˜¯æœ€åä¸€åˆ—ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119181250.png]]

è¿™ä¸€åˆ—æ„å‘³ç€ï¼Œå¦‚æœç¬¬äºŒä¸ªæŒ‡ä»¤ä¸ºå¯¹volatileçš„å†™ï¼Œé‚£ä¹ˆä¸ç®¡ç¬¬ä¸€ä¸ªæŒ‡ä»¤æ˜¯ä»€ä¹ˆéƒ½ä¸å…è®¸é‡æ’åºã€‚æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿæœ¬è´¨å°±æ˜¯ï¼Œ**ä½ ä¸èƒ½æŠŠå¯¹volatileçš„å†™æŒ‡ä»¤å¾€å‰æŒª**ï¼

ä¸ºå•¥è¿™ä¹ˆè¦æ±‚ï¼Ÿå°±æ˜¯ä¸ºäº†å®ç°æˆ‘ä»¬åˆšæ‰çš„ç»“è®ºå•Šï¼š[[#^a3a78e]]ã€‚è¿™æ ·åšï¼Œå°±èƒ½è®©volatileå†™æŒ‡ä»¤ä¹‹å‰çš„ä»»ä½•æŒ‡ä»¤éƒ½ä¸ä¼šå› ä¸ºé‡æ’åºè€Œé€ƒé€¸åˆ°volatileå†™æŒ‡ä»¤çš„åé¢å»ã€‚å› ä¸ºè¿™é‡Œå¯¹é‡æ’åºçš„å•ä½è¦æ±‚æ˜¯æ¯ä¸¤ä¸ªæŒ‡ä»¤ã€‚æ„å‘³ç€ä½ åšä¸äº†è¿™æ ·çš„æ“ä½œï¼š

```
normalRead1--------
normalRead2       |
volatileWrite3    |
           <______âŒŸ
```

ä¹Ÿå°±æ˜¯ä¸èƒ½éš”ç€ä¸€ä¸ªæŒ‡ä»¤æŠŠå€’æ•°ç¬¬äºŒæ¡æ’åˆ°åé¢å»ã€‚å› ä¸ºæ˜¯æ¯ä¸¤ä¸ªæŒ‡ä»¤ã€‚ä½ **æœ€å¤š**åªèƒ½å†³å®šnormalRead1å’ŒnormalRead2çš„é‡æ’åºã€‚

æ¥ä¸‹æ¥ï¼Œæ˜¯è¿™ä¸ªè¡¨æ ¼çš„ç¬¬äºŒè¡Œï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119182058.png]]

> [!note]
> å…¶å®è¿™ä¸€è¡Œå’Œé‚£ä¸€åˆ—ï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯é‚£ä¸ªvolatileçš„happens-beforeåŸåˆ™ã€‚

è¿™ä¸€è¡Œä»£è¡¨ç€ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileçš„è¯»ï¼Œé‚£ä¹ˆä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå’Œä¹‹å‰æ˜¯ç›¸å¯¹åº”çš„ï¼Œvolatileè¯»ä¹‹åçš„æ“ä½œä¹Ÿä¸èƒ½é€ƒé€¸åˆ°volatileè¯»çš„å‰é¢ã€‚

è¿™ä¹ˆçœ‹å®Œï¼Œå°±å‰©æœ€åä¸€ä¸ªäº†ã€‚ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªæ˜¯volatileå†™ï¼Œç¬¬äºŒä¸ªæ˜¯volatileè¯»çš„æ—¶å€™ï¼Œä¹Ÿä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªå…¶å®è¿˜æ˜¯ä¸€æ ·çš„é“ç†ã€‚å‰é¢éƒ½æ˜¯â€œ**å†™å’Œè¯»ä¸­é—´å¤¹å¿ƒçš„æƒ…å†µ**â€ï¼Œè€Œå¦‚æœæ²¡å¤¹å¿ƒï¼Œä¹Ÿå°±æ˜¯å®ƒä¿©æŒ¨ç€çš„æƒ…å†µä¹Ÿæ˜¯ä¸èƒ½è½ä¸‹çš„ã€‚

æ—¢ç„¶æ˜¯è¿™äº›æƒ…å†µä¸å…è®¸é‡æ’åºï¼Œä¸‹é¢å°±è¯¥å®ç°äº†ï¼æ€ä¹ˆå®ç°å‘¢ï¼Ÿå»ºè®®å›å¤´çœ‹ä¸€çœ‹[[Study Log/java_kotlin_study/concurrency_art/3_1_JMM_basic#3.1.2 é‡æ’åºç®€ä»‹|3.1.2 é‡æ’åºç®€ä»‹]]ï¼Œä¹Ÿå°±æ˜¯é‚£äº›å†…å­˜å±éšœã€‚

å¯¹äºvolatileå†™çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119184242.png]]

åœ¨å®ƒå‰é¢æ’å…¥äº†ä¸€ä¸ªStoreStoreå±éšœã€‚è¿™ä¿è¯äº†å¿…é¡»å‰é¢çš„æ™®é€šå†™å·²ç»åˆ·æ–°åˆ°å†…å­˜ä¹‹åï¼Œvolatileå†™æ‰èƒ½æ‰§è¡Œã€‚è¿™ä¹Ÿå°±ç¦æ­¢äº†é‡æ’åºã€‚

- [?] #question/coding/theory *è¿™é‡Œä¸ºä»€ä¹ˆæ’å…¥çš„æ˜¯StoreStoreè€Œä¸æ˜¯StoreLoadï¼Ÿå‰é¢å¦‚æœæ˜¯æ™®é€šè¯»çš„è¯ï¼Œä¸å°±åˆå¯ä»¥é‡æ’åºäº†å—ï¼Ÿä½†å®é™…ä¸Šæˆ‘ä¸æƒ³è®©å®ƒé‡æ’åºå‘€ï¼ŸStoreLoadæœ‰å…¶å®ƒä¸‰ä¸ªå±éšœçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä¸ºä»€ä¹ˆä¸æ’å…¥è¿™ä¸ªï¼Ÿå†æˆ–è€…ï¼Œä½ åƒä¸‹é¢volatileè¯»é‚£æ ·ï¼Œåœ¨StoreStoreåé¢è·Ÿä¸Šä¸€ä¸ªLoadStoreä¹Ÿè¡Œå‘€ï¼Ÿä½ ä¸ºå•¥ä¸è·Ÿå‘¢ï¼Ÿ*

åœ¨åé¢æ’å…¥äº†ä¸€ä¸ªStoreLoadå±éšœã€‚è¿™ä¿è¯äº†**ä¸‡ä¸€**åé¢ç´§è·Ÿç€ä¸€ä¸ªvolatileè¯»ï¼ˆæ­¤çº¿ç¨‹çš„æˆ–è€…æ˜¯å…¶å®ƒçº¿ç¨‹çš„ï¼‰ï¼Œä¾ç„¶ä¸è¦å»é‡æ’åºã€‚é‚£ä¹ˆè¿™é‡Œå¼•å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼š*ä¸ºå•¥æ˜¯åœ¨volatileå†™çš„åé¢æ’ï¼Œè€Œä¸æ˜¯åœ¨volatileè¯»çš„å‰é¢æ’*ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ**å†™æ“ä½œçš„æ•°é‡é€šå¸¸è¦è¿œå°äºè¯»æ“ä½œçš„æ•°é‡**ã€‚å› æ­¤å†™æ“ä½œæ’ä¼šè®©ä»£ç æ›´åŠ ç²¾ç®€ï¼ŒåŒæ—¶å±éšœçš„ä¸ªæ•°ä¹Ÿä¼šå˜å°‘ï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼ˆæ˜¯çœŸçš„ç»†ï¼ŒçœŸçš„ç‰›é€¼ï¼‰ã€‚

---

å¯¹äºvolatileè¯»çš„æ”¹åŠ¨å¦‚ä¸‹ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119184940.png]]

è¿™é‡Œçš„LoadLoadå±éšœæ˜¯ä¸ºäº†é˜²æ­¢ä¸‹é¢çš„æ™®é€šè¯»é€ƒé€¸ä¸Šå»ï¼›LoadStoreæ˜¯ä¸ºäº†ä¸‹é¢çš„æ™®é€šå†™é€ƒé€¸ä¸Šå»ã€‚

- [?] #question/coding/theory *è¿˜æ˜¯é‚£ä¸ªé—®é¢˜ï¼Œä½ è¿™é‡Œå’‹å°±ä¸¤ä¸ªå±éšœéƒ½æœ‰ï¼Œä¸Šé¢volatileå†™çš„å°±æ²¡æœ‰ä¿©ï¼Ÿ*

ä¸Šé¢è¿™ç§æ’å±éšœçš„æ–¹å¼ï¼Œå…¶å®æ˜¯**éå¸¸ä¿å®ˆ**çš„ï¼Œä¹Ÿå°±æ˜¯æœ€åæƒ…å†µã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™ç¼–è¯‘å™¨ä¼šæ ¹æ®å…·ä½“æƒ…å†µçœç•¥æ‰ä¸€äº›å±éšœã€‚

è¿™é‡Œå°±ç…§æ¬ä¹¦ä¸Šçš„å›¾å§ã€‚æ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹ï¼Œå°±æ˜¯é€šè¿‡åˆ†æï¼Œçœ‹å“ªäº›å±éšœæ˜¯å¯ä»¥å¹²æ‰çš„ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119185739.png]]

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119185745.png]]

ç„¶åæ˜¯x86å¹³å°çš„å•ç‹¬ä¼˜åŒ–ï¼Œå¾ˆå¥½ç†è§£ï¼Œä¹Ÿç›´æ¥æ¬ä¸Šæ¥äº†ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119185941.png]]

### 3.4.4 ä»¥å‰çš„volatile

è¿™éƒ¨åˆ†å¯¹åº”ç€æˆ‘ä¹‹å‰ä»‹ç»çš„é‚£ä¸ªè¡¥å……çš„ä¸€ç‚¹ï¼š[[#^61ac91]]ã€‚åœ¨æ—§çš„JMMæ¨¡å‹ä¸­ï¼Œé‚£ä¸ªè¡¨æ ¼å…¶å®å’Œ[[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119180949.png|ç°åœ¨çš„]]ä¸ä¸€æ ·ã€‚åœ¨ä»¥å‰ï¼Œæ™®é€šå˜é‡çš„è¯»å†™å…¶å®æ˜¯å¯ä»¥å’Œvolatileçš„è¯»å†™è¿›è¡Œæ’åºçš„ã€‚ä¸å˜çš„åªæ˜¯volatileå˜é‡ä¹‹é—´ä¸èƒ½é‡æ’åºã€‚å› æ­¤ï¼Œä¹‹å‰é‚£ä¸ªwriter() reader()çš„ä¾‹å­ï¼Œæœ‰å¯èƒ½è¢«é‡æ’åºæˆè¿™æ ·ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20231119193116.png]]

> 1. a = 3
> 2. flag = true
> 3. if (flag)
> 4. i = a \* a

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ—§çš„æ¨¡å‹ä¸‹ï¼Œä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š**çº¿ç¨‹Bè¯»flagå‘ç°æ˜¯trueï¼Œä½†æ˜¯aå±…ç„¶æ²¡å˜æˆæ–°çš„å€¼3ï¼Œè¿˜æ˜¯è€çš„å€¼1**ã€‚

æ‰€ä»¥ï¼Œvolatileæœ€ç»ˆèƒ½ä¿è¯ä»€ä¹ˆï¼Ÿåªèƒ½ä¿è¯å¯¹äºè¿™ä¸ªvolatileå˜é‡çš„è¯»/å†™æ“ä½œæ˜¯åŸå­çš„ï¼Œä½ å†åŠ ä¸Šä»»ä½•å…¶å®ƒçš„ä¸œè¥¿ï¼Œéƒ½å¯èƒ½å¤±æ•ˆäº†ã€‚

æœ€åï¼Œç»™å‡ºä¸€ä¸ªä½¿ç”¨volatileçš„æ­£ç¡®å§¿åŠ¿ï¼š[Java ç†è®ºä¸å®è·µ: æ­£ç¡®ä½¿ç”¨ Volatile å˜é‡-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)](https://cloud.tencent.com/developer/article/1340711)

- [ ] #TODO  åŸä½œè€…ï¼šBrian Goetzã€‚ä½†æ˜¯æˆ‘ä¸€ç›´æ‰¾ä¸åˆ°åŸæ–‡åœ¨å“ªé‡Œã€‚ä¸è¿‡æœ‰æ—¶é—´å¯ä»¥è¯»ä¸€è¯»ä»–å†™çš„ä¹¦ã€‚ ğŸ”½

#date 2024-01-07 è¡¥å……ä¸€ä¸ªä½¿ç”¨volatileçš„ä¾‹å­ã€‚çœ‹ä¸‹é¢çš„ä»£ç ï¼š ^d00fb6

```kotlin
class VolatileExample3 {  
  
    var flag = false  
  
    var a = 0  
  
    fun write() {  
        a = 1  
        Thread.sleep(10)  
        flag = true  
    }  
  
    companion object {  
        @JvmStatic  
        fun test() {  
            val example = VolatileExample3()  
            val th = Thread {  
                example.write()  
            }  
            th.start()  
            while (!example.flag) {}  
            println("a = ${example.a}")  
            th.join()  
        }  
    }  
}
```

å…¶å®å’Œæˆ‘ä»¬ä¹‹å‰çš„ä¾‹å­å‡ ä¹æ˜¯ä¸€æ ·çš„ã€‚å¼€äº†ä¸€ä¸ªå­çº¿ç¨‹thè´Ÿè´£æ‰§è¡Œwrite()ï¼Œè€Œä¸»çº¿ç¨‹è´Ÿè´£readã€‚writeçš„ç›®çš„å’Œæˆ‘ä»¬çœŸå®åœºæ™¯ä¸­åšçš„å…¶å®å¾ˆæ¥è¿‘äº†ï¼š**ä¸€äº›è€—æ—¶çš„å†™å…¥æ“ä½œ**ã€‚è¿™é‡Œæˆ‘ç¨å¾®æ„æ€æ„æ€å†™äº†ä¸ªå˜é‡aï¼Œå°†å…¶ç½®ä¸º1ï¼Œç„¶åsleepäº†10æ¯«ç§’ï¼Œæ¥æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶çš„å†™å…¥æ“ä½œã€‚æœ€åï¼Œå°†flagç½®ä¸ºtrueï¼Œè¡¨ç¤ºæˆ‘å·²ç»å†™å®Œäº†ã€‚

è€Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæˆ‘ä½¿ç”¨whileå¾ªç¯ä»¥busy waitingçš„æ–¹å¼æ¥æ¢æµ‹è¿™ä¸ªæ ‡è®°ï¼šåªè¦flagè¿˜æ˜¯falseï¼Œé‚£ä¹ˆå°±ä¸èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚è€Œä¸€æ—¦è·³å‡ºwhileå¾ªç¯ï¼Œ**æˆ‘çš„å¸Œæœ›æ˜¯æ‰€æœ‰å†™å…¥æ“ä½œå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå³aåº”è¯¥æ˜¯1è€Œä¸æ˜¯0**ã€‚æœ€åæˆ‘æ‰“å°å‡ºaçš„å€¼æ¥è¿›è¡ŒéªŒè¯ã€‚

å¥½äº†ã€‚ä½ è®¤ä¸ºï¼Œç»“æœåº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯1ï¼Ÿè¿˜æ˜¯0ï¼Ÿå“ˆå“ˆï¼Œéƒ½TMé”™äº†ï¼ç­”æ¡ˆæ˜¯ä¸»çº¿ç¨‹å¡æ­»äº†ï¼

![[Study Log/java_kotlin_study/concurrency_art/resources/idea64_cKH9d1VWGC.gif]]

<label class="ob-comment" title="å•çº¯å¡æ­»æˆ‘ä»¬å¯èƒ½çœ‹ä¸å‡ºæ¥å•¥ï¼Œæˆ‘ä»¬åœ¨whileå¾ªç¯é‡Œæ‰“å°ç‚¹ä¸œè¥¿" style=""> ~~å•çº¯å¡æ­»æˆ‘ä»¬å¯èƒ½çœ‹ä¸å‡ºæ¥å•¥ï¼Œæˆ‘ä»¬åœ¨whileå¾ªç¯é‡Œæ‰“å°ç‚¹ä¸œè¥¿~~ <input type="checkbox"> <span style=""> è¿™é‡Œä¸èƒ½æ‰“å°ï¼Œæ‰“å°æ“ä½œä¼šåˆ·æ–°ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹æœ¬åœ°å†…å­˜å¯èƒ½ä¼šå¤±æ•ˆï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜ç›´æ¥ç»™è§£å†³äº†ã€‚ </span></label>

å®é™…ä¸Šï¼Œè¿™é‡Œå¡ä½å°±æ˜¯å¡åœ¨äº†è¿™ä¸ªwhileå¾ªç¯é‡Œã€‚é‚£ä½ å°±ä¼šé—®äº†ï¼š10æ¯«ç§’ä¹‹åï¼Œwrite()æ‰§è¡Œå®Œflagä¸å°±æ˜¯trueäº†å—ï¼Ÿä¸ºå•¥è¿˜ä¼šå¡ï¼Ÿ

å¾ˆæ˜¾ç„¶ï¼Œè¿™å°±æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™å‡ºç°çš„é—®é¢˜ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2024-01-07 18.44.29.excalidraw.png]]

åœ¨write()ä¸­ï¼Œthç¡®å®æŠŠaå’Œflagçš„å€¼éƒ½æ›´æ–°å¹¶å†™åˆ°ä¸»å­˜é‡Œäº†ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬æƒ³ä¸€æƒ³ï¼šä¸»çº¿ç¨‹åœ¨è°ƒç”¨`th.start()`ä¹‹åç´§æ¥ç€å°±èµ°whileå¾ªç¯ã€‚<label class="ob-comment" title="é‚£ä¹ˆå¾ˆå¯èƒ½åœ¨thè¿˜æ²¡æ¥å¾—åŠæ›´æ–°aå’Œflagçš„æ—¶å€™" style=""> é‚£ä¹ˆå¾ˆå¯èƒ½åœ¨thè¿˜æ²¡æ¥å¾—åŠæ›´æ–°aå’Œflagçš„æ—¶å€™ <input type="checkbox"> <span style=""> çº¿ç¨‹çš„åˆ‡æ¢ä¹Ÿæ˜¯éœ€è¦æ—¶é—´æ»´ï¼è¿™ä¸ªæœ¬ä¹¦çš„å¼€å¤´å°±è®²äº†ã€‚ </span></label>ï¼Œ**flagå°±å·²ç»è¢«ä¸»çº¿ç¨‹è¯»è¿‡ä¸€æ¬¡äº†**ã€‚é‚£ä¹ˆè¯»åˆ°çš„æ˜¯å•¥ï¼Ÿfalseå‘—ï¼æ‰€ä»¥ï¼Œè¿™ä¸ªfalseå°±è¢«ç•™åœ¨äº†ä¸»çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¸­ã€‚è€Œç¨‹åºå‘˜æ²¡æœ‰æ˜¾å¼åœ°é€šçŸ¥ä¸»çº¿ç¨‹ï¼Œè¯´â€œ*ä½ è¿™ä¸ªæœ¬åœ°å†…å­˜é‡Œçš„ä¸œè¥¿æ—©å°±è¿‡æ—¶äº†*â€ï¼Œæ‰€ä»¥è‡ªç„¶å®ƒä¹Ÿä¸çŸ¥é“è¦å»ä¸»å­˜ä¸­å»æ‹¿ã€‚

ç­”æ¡ˆå°±æ˜¯ï¼Œåœ¨flagä¸ŠåŠ volatileï¼š

```kotlin
@Volatile  
var flag = false
```

è¿™æ ·ï¼Œå½“åœ¨writer()ä¸­å°†flagç½®ä¸ºtrueçš„åŒæ—¶ï¼Œç”±äºVolatileå¼•å…¥çš„`#lock`æŒ‡ä»¤ï¼Œä¼šè®©æ‰€æœ‰è¯»è¿™ä¸ªå€¼çš„çº¿ç¨‹çš„æœ¬åœ°å†…å­˜çš„å—ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ‰€ä»¥ä¸Šé¢Ã—æ‰çš„ç®­å¤´å°±æ¢å¤äº†ï¼Œä¹Ÿå°±å¯ä»¥ä»ä¸»å­˜ä¸­è¯»äº†ï¼Œä¹Ÿå°±èƒ½è¯»åˆ°æ­£ç¡®çš„trueäº†ã€‚

- [ ] #TODO  ä¸ºä»€ä¹ˆåœ¨whileå¾ªç¯é‡Œæ‰“ä¸€ä¸ª`print("")`ä¹Ÿèƒ½å®ç°ä¸€æ ·çš„æ•ˆæœï¼Ÿä¸ºä»€ä¹ˆåœ¨whileå¾ªç¯ä¹‹å‰è°ƒç”¨`th.join()`è¿˜èƒ½å®ç°ä¸€æ ·çš„æ•ˆæœï¼ŸçœŸçš„æ˜¯å› ä¸ºåˆ·æ–°ç¼“å†²åŒºå•¥çš„å—ï¼Ÿéœ€è¦å¥½å¥½ç ”ç©¶ä¸€ä¸‹ã€‚[java - print() make thread-local cache invalid? - Stack Overflow](https://stackoverflow.com/questions/77772954/print-make-thread-local-cache-invalid) ğŸ”¼

---

```dataviewjs
const pages = dv.pages('"Study Log/java_kotlin_study/concurrency_art"')
let nextChapterHead = undefined
let res = undefined
const current = dv.current()
for (let page of pages) {
	if (page.chapter_root == true && page.order == Number(current.chapter) + 1) {
		console.log("found next head: " + page.name)
		nextChapterHead = page
		continue
	}
	if (page.chapter == undefined || page.chapter != current.chapter) {
		console.log("not current chapter: " + page.file.name)
		continue
	}
	if (page.order == Number(current.order) + 1) {
		res = page
	}
}
console.log("res: " + res)
console.log("next: " + nextChapterHead)
if (res == undefined) {
	res = nextChapterHead
}
let text = ""
if (res != undefined) {
	const path = res.file.path
	const title = res.title
	const decoLink = "[[" + path + "|" + title + "]]"
	text = "Next Article: " + decoLink
} else {
	text = "æ—…é€”çš„ç»ˆç‚¹ï¼"
}
dv.el("p", text, { attr: { align: "right" } })
```