---
title: 9 Java ä¸­çš„çº¿ç¨‹æ± 
chapter: "9"
order: "9"
chapter_root: true
---
****
# 9 Java ä¸­çš„çº¿ç¨‹æ± 

## 9.1 ä»¥å‰çº¿ç¨‹æ± çš„æ€»ç»“

æˆ‘ä»¬ä¹‹å‰å°±å†™è¿‡ä¸€ä¸ªçº¿ç¨‹æ± ï¼š[[Study Log/java_kotlin_study/concurrency_art/4_4_thread_example#4.4 çº¿ç¨‹æ± åˆè§|4_4_thread_example]]ã€‚ä½†æ˜¯å½“æ—¶å®ç°çš„éå¸¸ç®€å•ã€‚~~ç®€å•~~æ€»ç»“ä¸€ä¸‹ï¼š

1. ç”±äºå–ä»»åŠ¡ï¼ŒåŠ ä»»åŠ¡çš„æ—¶å€™å¯èƒ½ä¼šå‘ç”Ÿç«äº‰ï¼Œæ‰€ä»¥è¿™é‡Œä»»åŠ¡éœ€è¦é”èµ·æ¥ï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯[Synchronized List](https://medium.com/@the_infinity/javas-synchronized-collections-07712ae3b2cb);
2. åœ¨æ·»åŠ ä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œéœ€è¦å¯¹jobsåŠ é”ã€‚ç”¨çš„æ˜¯ä½æ•ˆçš„synchronizedï¼›
3. åœ¨æ·»åŠ workerï¼Œ==ç§»é™¤workerçš„æ—¶å€™ï¼Œä½¿ç”¨çš„ä¾ç„¶æ˜¯synchronized==ï¼Œå³ä½¿åœ¨workerså·²ç»æ˜¯Synchronized Listçš„æƒ…å†µä¸‹ã€‚

> [!comment] ç§»é™¤workerçš„æ—¶å€™ï¼Œä½¿ç”¨çš„ä¾ç„¶æ˜¯synchronized
> è€Œä¸”ï¼Œè¿™é‡Œç”¨çš„é”ä¾ç„¶æ˜¯jobsã€‚è¿™é‡Œæˆ‘ä¸€ç›´ä¸çŸ¥é“åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆï¼Œé—®äº†gptä¹Ÿåœ¨è¯´è½¦è½±è¾˜è¯ï¼š[DefaultThreadPool Implementation Explained](https://chatgpt.com/share/8049f345-aad2-4f8a-8386-f16ed12161c2) and [[Study Log/java_kotlin_study/concurrency_art/resources/gpt_threadpool_sb.pdf|gpt_threadpool_sb]]ã€‚
> 
> ç›®å‰æˆ‘çš„æ¨æµ‹æ˜¯ï¼Œä»æœ¬è´¨ä¸Šçœ‹ï¼Œå°±æ˜¯ä¸ºäº†è®©workeråœ¨+-çš„æ—¶å€™ï¼Œä¸èƒ½æœ‰çº¿ç¨‹åœ¨å–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚è®¾æƒ³ï¼šå¦‚æœremoveWorkeræˆ‘ä»¬ä¸åŠ jobsé”çš„è¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†removeWorkerï¼Œå°±ç›´æ¥æŠŠè¿™ä¸ªworkerç»™å¹²æ‰äº†ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™è¿™ä¸ªworkeråˆšåˆšæ‰§è¡Œjobs.removeFirst()ï¼Œé‚£å°±æ„å‘³ç€è¿™ä¸ªä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå‘¢workerå°±æ²¡äº†ã€‚å› æ­¤ï¼Œè¿™é‡Œè¦è®©**ç§»é™¤workerçš„çº¿ç¨‹å’Œè¢«ç§»é™¤çš„workerè¿›è¡Œç«äº‰ï¼Œç«äº‰jobs**ã€‚
> 
> åœ¨æºä»£ç ä¸­ï¼Œworkerå–å‡ºäº†ä»»åŠ¡ä¹‹åè°ƒç”¨jobs.run()ã€‚æ­¤æ—¶å¦‚æœæ‰è¿›è¡ŒremoveWorkerçš„è¯ï¼Œå…ˆremoveå†shutdownã€‚è¿™æ ·å½“workeræ‰§è¡Œå®Œjobä¹‹åï¼Œå†æ¬¡åˆ¤æ–­isRunningå°±æ˜¯falseäº†ã€‚ç„¶è€Œï¼Œæˆ‘ä¾ç„¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆaddWorkersé‡Œé¢ä¹Ÿè¦åŠ ä¸Šjobsçš„é”ã€‚ä½ è¯´å’ŒremoveWorkerç«äº‰å§ï¼Œä½†æ˜¯è¿™ä¸ªç«äº‰ä¹Ÿä¸æ¶‰åŠä»»åŠ¡çš„æ‰§è¡Œï¼Œå¹¶ä¸”workerså·²ç»æ˜¯Synchronized Listäº†ï¼Œæ›´æ²¡æœ‰å¿…è¦å†å¥—ä¸€å±‚ï¼›ä½ è¯´å’Œexecuteç«äº‰å§ï¼Œä»–ä¿©ä¹Ÿå®Œå…¨æ²¡æœ‰èƒ½ç«äº‰çš„åœ°æ–¹å•Šã€‚ã€‚ä½ è¯´å’Œworkerç«äº‰å§ï¼Œä½ è¦åŠ workerï¼Œå’Œå·²ç»å­˜åœ¨çš„workeræœ‰å•¥å…³ç³»ï¼Ÿæ‰€ä»¥æˆ‘ä¸çŸ¥é“ä¸ºå•¥è¿™é‡Œæœ‰ä¸ª`synchronized(jobs)`ã€‚

- [ ] #TODO tasktodo1723305102984 ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ï¼Œè®¾è®¡åˆç†çš„çº¿ç¨‹æ± åˆ°åº•æ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿè¿™é‡Œæ²¡æ¢ç©¶å‡ºæ¥çš„é—®é¢˜åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ â• 2024-08-10 â« ğŸ†” 881cuz

## 9.2 çº¿ç¨‹æ± å®ç°åŸç†

> [!attention]
> ä¼°è®¡è¿™æ˜¯æ•´æœ¬ä¹¦æœ€å¤æ‚çš„éƒ¨åˆ†äº†ã€‚ç”šè‡³æ¯”[[Study Log/java_kotlin_study/concurrency_art/5_2_aqs|5_2_aqs]]è¿˜è¦å¤æ‚ã€‚

[Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰ | JavaGuide](https://javaguide.cn/java/concurrent/java-concurrent-questions-03.html#%E7%BA%BF%E7%A8%8B%E6%B1%A0)

ç°åœ¨çœ‹çœ‹javaçº¿ç¨‹æ± çš„å·¥ä½œåŸç†ã€‚javaçº¿ç¨‹æ± ä¸ºäº†èƒ½èŠ‚çœçº¿ç¨‹èµ„æºï¼Œé€šå¸¸ä¼šæœ‰ä¸€äº›é…ç½®ï¼š

- æ ¸å¿ƒçº¿ç¨‹æ± æ•°ã€‚è¿™ä¸ªæ˜¯çº¿ç¨‹æ± åˆšè¢«åˆ›å»ºï¼Œä»»åŠ¡è¿˜ä¸å¤šçš„æ—¶å€™ï¼Œå¯ä»¥åŒæ—¶è¿è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ã€‚æ¯”å¦‚å¦‚æœæ˜¯4ï¼Œæˆ‘æäº¤äº†ä¸€ä¸ªä»»åŠ¡ï¼Œ1ä¸ªçº¿ç¨‹è¿è¡Œæ¥æ‰§è¡Œï¼ˆ**éœ€è¦è·å–å…¨å±€é”**ï¼‰ï¼›ç„¶åæˆ‘åˆæäº¤äº†ä¸€ä¸ªï¼Œè¿™ä¸ªæ—¶å€™ä¼šå†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼ˆ**éœ€è¦è·å–å…¨å±€é”**ï¼‰ï¼›å½“4ä¸ªçº¿ç¨‹éƒ½åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œæˆ‘å¦‚æœå†æäº¤ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå†åˆ›å»ºæ–°çš„çº¿ç¨‹äº†ã€‚
- ä»»åŠ¡é˜Ÿåˆ—ï¼šå°±æ˜¯å­˜æ”¾ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚è¿˜æ˜¯åˆšåˆš4ä¸ªæ ¸å¿ƒçº¿ç¨‹çš„ä¾‹å­ã€‚[[#^d09730|å¦‚æœç¬¬äº”ä¸ªä»»åŠ¡è¢«æäº¤ï¼Œæ­¤æ—¶ä¸ä¼šå†åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œä¼šå°†ä»»åŠ¡å…¥é˜Ÿ]]ã€‚
- æœ€å¤§çº¿ç¨‹æ•°ï¼šå¦‚æœä¸Šé¢çš„é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼ˆè¿™ä¸ªæœ‰ç‚¹éš¾ï¼Œæ¯”å¦‚é»˜è®¤ä»»åŠ¡é˜Ÿåˆ—çš„sizeæ˜¯Integer.MAXï¼‰ï¼Œè¿˜æœ‰æ–°ä»»åŠ¡æäº¤çš„è¯ï¼Œå°±ä¼šå†æ¬¡åˆ›å»ºçº¿ç¨‹æ‰§è¡Œï¼ˆ**éœ€è¦è·å–å…¨å±€é”**ï¼‰ã€‚æ­¤æ—¶çš„çº¿ç¨‹å°±ä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹äº†ã€‚
- æ‹’ç»ç­–ç•¥ï¼šå¦‚æœæœ€å¤§çº¿ç¨‹æ•°ä¹Ÿè¾¾åˆ°äº†ï¼Œå°±ç›´æ¥æ‹’ç»ä»»åŠ¡æ‰§è¡Œã€‚æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚

é€šè¿‡ä¸Šé¢çš„è§£é‡Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯”è¾ƒå½±å“æ€§èƒ½çš„å°±æ˜¯è¿™ä¸¤ä¸ªåˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹[[#^ca5c6d|éœ€è¦è·å–å…¨å±€é”]]ã€‚å› æ­¤ï¼Œå¦‚æœæ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹æ•°åªæœ‰æœ€å¤§çº¿ç¨‹æ•°çš„è¯ï¼Œå…¨å±€é”è·å–å°±ä¼šå¾ˆé¢‘ç¹ã€‚æ¯”å¦‚ä¸€ä¸ªè„‘ç˜«å†™çš„ä»£ç ï¼Œç›´æ¥åˆ›å»ºäº†100ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œä½†æ˜¯ä»–æäº¤çš„ä»»åŠ¡å°±æ˜Ÿå´©å‡ ä¸ªï¼Œè€Œæ¯æ¬¡æäº¤ï¼Œè°ƒç”¨executeï¼Œé‡Œé¢çš„addWorkeræ–¹æ³•ï¼ˆå¢åŠ çº¿ç¨‹çš„æ–¹æ³•ï¼‰éƒ½è¦è·å–ä¸€æ¬¡å…¨å±€é”ã€‚è¿™æ ·å°±å¤ªæµªè´¹äº†ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œå°†ä¸¤ä¸ªæ•°å­—æ‹†å¼€ï¼ŒæŠŠä»»åŠ¡é˜Ÿåˆ—æ”¾åˆ°ä¸­é—´ä½œä¸ºç¼“å†²ï¼Œè¿™æ ·ç»å¤§å¤šæ•°æƒ…å†µéƒ½ä¼šèµ°å…¥é˜Ÿçš„æ“ä½œï¼Œè¿™æ ·å°±ä¸ç”¨è·å–å…¨å±€é”äº†ã€‚

çœ‹çœ‹executeçš„å®ç°ï¼ˆThreadPoolExecutorï¼‰ï¼š

```java
/**
 * Executes the given task sometime in the future.  The task
 * may execute in a new thread or in an existing pooled thread.
 *
 * If the task cannot be submitted for execution, either because this
 * executor has been shutdown or because its capacity has been reached,
 * the task is handled by the current {@link RejectedExecutionHandler}.
 *
 * @param command the task to execute
 * @throws RejectedExecutionException at discretion of
 *         {@code RejectedExecutionHandler}, if the task
 *         cannot be accepted for execution
 * @throws NullPointerException if {@code command} is null
 */
public void execute(Runnable command) {
	if (command == null)
		throw new NullPointerException();
	/*
	 * Proceed in 3 steps:
	 *
	 * 1. If fewer than corePoolSize threads are running, try to
	 * start a new thread with the given command as its first
	 * task.  The call to addWorker atomically checks runState and
	 * workerCount, and so prevents false alarms that would add
	 * threads when it shouldn't, by returning false.
	 *
	 * 2. If a task can be successfully queued, then we still need
	 * to double-check whether we should have added a thread
	 * (because existing ones died since last checking) or that
	 * the pool shut down since entry into this method. So we
	 * recheck state and if necessary roll back the enqueuing if
	 * stopped, or start a new thread if there are none.
	 *
	 * 3. If we cannot queue task, then we try to add a new
	 * thread.  If it fails, we know we are shut down or saturated
	 * and so reject the task.
	 */
	int c = ctl.get();
	if (workerCountOf(c) < corePoolSize) {
		if (addWorker(command, true))
			return;
		c = ctl.get();
	}
	if (isRunning(c) && workQueue.offer(command)) {
		int recheck = ctl.get();
		if (!isRunning(recheck) && remove(command))
			reject(command);
		else if (workerCountOf(recheck) == 0)
			addWorker(null, false);
	}
	else if (!addWorker(command, false))
		reject(command);
}
```

å¥½å¥½è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ã€‚é¦–å…ˆæ˜¯`workerCountOf(c)`çš„ä½œç”¨ï¼Œå®ƒè¿”å›çš„æ˜¯å½“å‰[[#^15fc63|è¢«å…è®¸å¯åŠ¨ï¼Œä½†ä¸å…è®¸åœæ­¢]]çš„çº¿ç¨‹çš„æ•°é‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š ^ecd2ad

- ğŸ¤¨ æˆ‘è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ˜¯å…è®¸å¯åŠ¨çš„ã€‚[[#^8bbd3d|workerCountå°±ä¼šå¢åŠ ]]ã€‚ä½†æ˜¯è¿™æ—¶å€™å¦‚æœå› ä¸ºThreadFactoryåˆ›å»ºçº¿ç¨‹[[#^0e1eb2|å¤±è´¥]]äº†ï¼Œå®é™…ä¸ŠworkerCountä¸åº”è¯¥å¢åŠ ã€‚[[#^28fb49|æ‰€ä»¥åˆ°æ—¶å€™è¿˜ä¼šè®¾ç½®å›å»]]ã€‚å› æ­¤è¿™ä¸ªå€¼æš‚æ—¶ä¼šå’ŒçœŸå®æƒ…å†µä¸ä¸€æ ·ï¼›
- ğŸ¤¨ [[#^c6627b|ä¸€ä¸ªçº¿ç¨‹è¦ç»“æŸäº†]]ï¼Œæœ€åä¼šåšä¸€äº›æ”¶å°¾å·¥ä½œäº†ã€‚æ­¤æ—¶çº¿ç¨‹[[#^e8989f|ä¸ä¼šå†è¿è¡Œæ–°ä»»åŠ¡]]ï¼Œä½†æ˜¯å› ä¸ºå®ƒæ²¡æœ‰çœŸæ­£åœæ­¢ï¼Œæ‰€ä»¥æ­¤æ—¶workerCountå…¶å®è¿˜æ˜¯æŠŠå®ƒç»™ç®—ä¸Šäº†çš„ã€‚

å› æ­¤ï¼Œè¿™é‡Œç¬¬ä¸€æ­¥çš„é€»è¾‘å°±æ˜¯ï¼Œçœ‹å½“å‰æ­£åœ¨å·¥ä½œçº¿ç¨‹çš„æ•°é‡ï¼Œçœ‹æ˜¯ä¸æ˜¯å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å¦‚æœå°äºï¼Œå°±ä¼šæ·»åŠ ä¸€ä¸ªworkerã€‚è¿™é‡Œè°ƒç”¨çš„addWorkerçš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æ˜¯å¦æ ¸å¿ƒï¼š

```java
if (workerCountOf(c) < corePoolSize) {
	if (addWorker(command, true))
		return;
	c = ctl.get();
}
```

å¦‚æœè¿™é‡Œä¸è¡Œï¼Œé‚£å°±æ˜¯è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåº”è¯¥æŠŠä»»åŠ¡å…¥é˜Ÿäº†ã€‚æ‰€ä»¥è¿™é‡Œ[[#^52b263|æ£€æŸ¥ä¸€ä¸‹çº¿ç¨‹æ± æ˜¯å¦ä»»ç„¶åœ¨è¿è¡Œ]]ï¼Œå¦‚æœåœ¨è¿è¡Œå°±ä¼šå°è¯•æŠŠä»»åŠ¡å…¥é˜Ÿã€‚å…¥é˜ŸæˆåŠŸäº†ï¼Œå°±å®Œäº†å—ï¼Ÿæ²¡æœ‰ã€‚åœ¨å…¥é˜ŸæˆåŠŸä¹‹åï¼Œå¯èƒ½ä¼šå‘ç”Ÿä¸‹é¢çš„æƒ…å†µï¼š

- çº¿ç¨‹æ± åœ¨è¿™ä¸ªæ—¶å€™è¢«å…³äº†ï¼ˆ`!isRunning(recheck)`ï¼‰ï¼šé‚£è¿™ä¸ªæ—¶å€™å°±ä¸èƒ½æ‰§è¡Œè¿™ä¸ªä»»åŠ¡äº†ï¼Œéœ€è¦æ‹’ç»ï¼›
- ==æ­¤æ—¶æ²¡æœ‰çº¿ç¨‹è¿˜èƒ½è¿è¡Œäº†==ï¼ˆ`workerCountOf(recheck) == 0`ï¼‰ï¼šè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¦å†æ·»åŠ ä¸€ä¸ªçº¿ç¨‹ã€‚å› ä¸ºæ­¤æ—¶è¦ä¹ˆæ± å­å·²ç»ç©ºäº†ï¼Œè¦ä¹ˆ ğŸ¤¨  [[#^f70a15|å‰©ä¸‹çš„çº¿ç¨‹éƒ½åœ¨åšæ”¶å°¾å·¥ä½œï¼Œé©¬ä¸Šéƒ½è¦æ­»äº†]]ã€‚[[#^7272d6|æ‰€ä»¥å¾—åŠ ä¸€ä¸ªçº¿ç¨‹æ¥å·¥ä½œ]]ã€‚

æ‰€ä»¥é€»è¾‘å¦‚ä¸‹ï¼š

```java
if (isRunning(c) && workQueue.offer(command)) {    // æ£€æŸ¥ä¸€ä¸‹çº¿ç¨‹æ± æ˜¯å¦ä»åœ¨è¿è¡Œï¼Œå¦‚æœåœ¨å°±å…¥é˜Ÿä»»åŠ¡
	int recheck = ctl.get();                       // é‡æ–°è·å–å½“å‰çŠ¶æ€
	if (!isRunning(recheck) && remove(command))    // ç”¨å½“å‰çŠ¶æ€å†æ¬¡æ£€æŸ¥æ˜¯å¦åœ¨è¿è¡Œ
		reject(command);
	else if (workerCountOf(recheck) == 0)
		addWorker(null, false);
}
```

> [!comment] æ­¤æ—¶æ²¡æœ‰çº¿ç¨‹è¿˜èƒ½è¿è¡Œäº†
> ä½ å¯èƒ½ä¼šæ„Ÿè§‰è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿï¼Œæ¯•ç«Ÿåˆšåˆšæˆ‘ä»¬è¿˜åˆ¤æ–­äº†æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚æƒ³è±¡è¿™æ ·çš„æƒ…å†µï¼šæ ¸å¿ƒçº¿ç¨‹æ˜¯4ä¸ªï¼Œæˆ‘æäº¤äº†4ä¸ªä»»åŠ¡ï¼Œæ­¤æ—¶éƒ½åœ¨æ‰§è¡Œã€‚å½“æˆ‘æäº¤ç¬¬äº”ä¸ªä»»åŠ¡æ—¶ï¼Œåˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹è‚¯å®šæ˜¯falseã€‚é‚£æ¥ä¸‹æ¥æˆ‘è¦å°è¯•å…¥é˜Ÿäº†æ˜¯æŠŠã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æˆ‘è¿˜æ²¡å…¥é˜Ÿå‘¢ï¼Œå‰é¢é‚£å››ä¸ªçº¿ç¨‹æ­£å¥½æŠŠä»»åŠ¡éƒ½åšå®Œäº†ã€‚<u>æ¥ä¸‹æ¥ä»–ä»¬ä¸€çœ‹é˜Ÿåˆ—é‡Œæ²¡ä»»åŠ¡äº†ï¼Œå°±éƒ½åšæ”¶å°¾å·¥ä½œç„¶åé€€å‡ºäº†ï¼ˆè¿™é‡Œç¡®å®æ˜¯ä¼šé€€å‡ºçš„ã€‚å¯ä»¥çœ‹keepAliveTimeè¿™ä¸ªå‚æ•°ï¼Œå¦‚æœä¸€ç›´æ²¡ç­‰åˆ°é˜Ÿåˆ—é‡Œæœ‰æ–°ä»»åŠ¡ï¼Œå°±é€€å‡ºäº†ã€‚è€Œå¤§éƒ¨åˆ†çº¿ç¨‹æ± çš„è¿™ä¸ªå€¼éƒ½æ˜¯0ï¼Œæ„å‘³ç€æ²¡ä»»åŠ¡ä¸ç­‰ï¼Œç›´æ¥çº¿ç¨‹ç»ˆç»“äº†ã€‚è¿™ä¸ªå’Œæˆ‘ä»¬è‡ªå·±å®ç°çš„ä¸€ç›´ç­‰çš„çº¿ç¨‹æ± å¾ˆä¸ä¸€æ ·ã€‚å¯ä»¥æœä¸€æœä¸ºå•¥å®ƒä¸è¿™ä¹ˆåšï¼‰</u>ã€‚
> 
> 4ä¸ªçº¿ç¨‹éƒ½é€€å‡ºäº†ï¼Œé‚£ç­‰ä»»åŠ¡å…¥é˜Ÿäº†ï¼ŒæŸ¥ä¸€ä¸‹çº¿ç¨‹æ± çŠ¶æ€ï¼Œè¿˜æ˜¯è¿è¡Œä¸­ï¼Œå› ä¸ºæˆ‘æ²¡è°ƒshutdownï¼Œè™½ç„¶å·²ç»æ²¡çº¿ç¨‹äº†ï¼Œä½†æ˜¯æ± å­è¿˜æ˜¯å¾…å‘½çŠ¶æ€ã€‚é‚£æˆ‘å¦‚æœä¸æ£€æŸ¥è¿˜æœ‰æ²¡æœ‰çº¿ç¨‹çš„è¯ï¼Œé‚£å°±çœŸæ²¡äººå¹²æ´»å„¿äº†ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œè¦æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦çœŸçš„æ²¡æœ‰èƒ½å¹²æ´»å„¿çš„çº¿ç¨‹äº†ã€‚[[#^512df9|å¦‚æœçœŸæ²¡æœ‰äº†ï¼Œé‚£æˆ‘æ€»å¾—åŠ ä¸€ä¸ªå§]]ï¼
> 
> æ³¨æ„ä¸€ä¸‹ä¸Šé¢åˆ’çº¿çš„å¥å­ã€‚æ¥ç€çœ‹ä¸‹å»ä½ ä¼šå‘ç°ï¼Œæ ¸å¿ƒçº¿ç¨‹è¦æ˜¯æƒ³åœ¨æ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ç»“æŸè‡ªå·±ï¼Œéœ€è¦ä¸€å®šçš„æ¡ä»¶ã€‚è¿™ä¸ªæ¡ä»¶æˆ‘ä»¬ä¹‹åä¼šè¯´æ˜ã€‚
> 
> - [ ] #TODO tasktodo1725772639884 è¯´æ˜äº†å—ï¼Ÿ â• 2024-09-08 â« ğŸ†” qunse9 

ä»workerè‡ªå·±ç”Ÿå‘½å‘¨æœŸï¼Œæ•´ä¸ªçº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦åˆ†åˆ«çœ‹çº¿ç¨‹æ± ã€‚

æœ€åï¼Œå¦‚æœè¿˜æ˜¯æ²¡èµ°ï¼Œé‚£å°±æ˜¯é˜Ÿåˆ—ä¹Ÿæ»¡äº†ã€‚è¿™ä¸ªæ—¶å€™å°±è¦æ‰©å±•æ–°çº¿ç¨‹äº†ã€‚å¦‚æœè¿˜ä¸è¡Œï¼Œå°±æ‹’ç»å§ï¼š

```java
else if (!addWorker(command, false))
	reject(command);
```

- [ ] #TODO tasktodo1723314678194 æ±‡æ€»çº¿ç¨‹æ± å®ç°çš„ä¸€äº›é—®é¢˜ã€‚è¿™äº›å¯¹é˜…è¯»ä»£ç éå¸¸é‡è¦ï¼ï¼ï¼ â• 2024-08-11 ğŸ”º ğŸ†” efw1c7
	- [ ] å¦‚æœç¬¬äº”ä¸ªä»»åŠ¡æ¥çš„æ—¶å€™ï¼Œæœ‰ç©ºé—²çš„æ ¸å¿ƒçº¿ç¨‹ã€‚æ­¤æ—¶ä»»åŠ¡ä¼šå…¥é˜Ÿè¿˜æ˜¯ç›´æ¥è¢«å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Ÿ ^d09730
	- [ ] ä¸ºä»€ä¹ˆéœ€è¦è·å–å…¨å±€é”ï¼Ÿ ^ca5c6d
	- [ ] è¿™é‡Œçš„æ¡ä»¶è¦ä»ä»£ç ä¸Šç»™å‡ºå‡†ç¡®çš„æ—¶æœºï¼Œå› ä¸ºåé¢å¾ˆå¤šä»£ç çš„è§£é‡Šè¦å‚è€ƒè¿™é‡Œ ^15fc63
	- [ ] [[#^283ad8|ä»£ç åœ¨å“ªé‡Œï¼Ÿ]] ^8bbd3d
	- [ ] ä¸ºä»€ä¹ˆä¼šå¤±è´¥ï¼Ÿ ^0e1eb2
	- [ ] [[#^ffb99a|ä»£ç åœ¨å“ªé‡Œ]]ï¼Ÿ ^28fb49
	- [ ] ä»€ä¹ˆæ—¶å€™ä¼šç»“æŸï¼Ÿ ^c6627b
	- [ ] çœŸçš„å—ï¼Ÿä»£ç è¯æ˜ï¼Ÿ ^e8989f
	- [ ] ä¸ºå•¥ä¸€å¼€å§‹ä¸æ£€æŸ¥ï¼Ÿ ^52b263
	- [ ] å†™ä¸ªdemoéªŒè¯ä¸€ä¸‹ï¼Ÿæ„Ÿè§‰è¿™ä¸ªæŒºéš¾è§¦å‘çš„ï¼›å¦å¤–æ”¶å°¾çš„çº¿ç¨‹åˆ°åº•æ˜¯ä¸æ˜¯ç®—åœ¨workerCounté‡Œï¼Ÿè¿™ä¸ªä¸œè¥¿è¦ç¡®å®šä¸€ä¸‹ï¼Œä¸ç„¶è¿™å¥è¯æœ¬èº«å°±æœ‰é—®é¢˜ã€‚ ^f70a15
	- [ ] è¿™é‡Œä¸ºå•¥æ ¸å¿ƒçº¿ç¨‹æ˜¯falseï¼Ÿæˆ‘çŒœæµ‹çš„æ˜¯åæ­£å·²ç»æ²¡çº¿ç¨‹äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸ç”¨å…³å¿ƒæ˜¯ä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚æ¯•ç«Ÿä¸ç®¡ä½ æ˜¯ä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œå¾…é‡éƒ½æ˜¯ä¸€æ ·çš„ã€‚åªæ˜¯å¢åŠ çš„UPPER BOUNDä¸ä¸€æ ·ã€‚æ‰€ä»¥è¿™é‡Œä¸ç®¡æ˜¯trueéƒ½æ˜¯falseéƒ½èƒ½æ·»åŠ æˆåŠŸ ^7272d6
	- [ ] è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹ï¼ŒworkerCountå¢åŠ ï¼Œä½†æ˜¯åˆ›å»ºå¤±è´¥ï¼Œè¿˜æ²¡æ¥å¾—åŠæŠŠæ•°å­—è®¾ç½®å›æ¥ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœè¿›è¡Œexecuteåˆ¤æ–­ï¼Œå¹¶ä¸”æ­£å¥½ä¹Ÿé‡åˆ°äº†ä¸Šé¢æ‰€è¯´çš„caseï¼Œé‚£è¿™ä¸ªæ—¶å€™workerCountä¸æ˜¯0ï¼Œå°±ä¸ä¼šå¢åŠ workerã€‚ä½†æ˜¯äº‹å®æƒ…å†µæ˜¯workeræœ€åä¼šåˆ›å»ºå¤±è´¥ã€‚é‚£è¿™ä¸ªæ—¶å€™ä¸æ˜¯åˆæ²¡æœ‰çº¿ç¨‹èƒ½å¹²æ´»å„¿äº†å—ï¼Ÿ ^512df9

[Deepak Vadgama blog â€“ Java ThreadPoolExecutor internals](https://deepakvadgama.com/blog/java-executor-internals/#using-ctl-lock)

[JAVA-ThreadPoolExecutor why we need to judge the worker count in the execute function during the recheck procedure? - Stack Overflow](https://stackoverflow.com/questions/46901095/java-threadpoolexecutor-why-we-need-to-judge-the-worker-count-in-the-execute-fun)

æ¥ä¸‹æ¥ï¼Œä»‹ç»workeræ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å®ƒä¼šä¸æ–­ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚

> [!Attention] With Code!
> è¯»æ¥ä¸‹æ¥çš„å†…å®¹çš„æ—¶å€™ï¼Œä¸€å®šå¯¹ç€æºç è¯»ã€‚ä¸ç„¶ä½ å¾ˆå¯èƒ½ä¸çŸ¥é“æˆ‘åœ¨è¯´ä»€ä¹ˆã€‚

- ~~çº¿ç¨‹æ± çš„å‡ ä¸ªçŠ¶æ€ï¼ŒRUNNING, SHUTDOWN... æ˜¯æ€ä¹ˆè½¬æ¢çš„ï¼Œè¿˜æœ‰runStateAtLeastçš„æ„æ€ï¼›~~
- getTaské‡Œæ˜¯å¦‚ä½•å¤„ç†ï¼Œworkeråœ¨é•¿æ—¶é—´è·å–ä¸åˆ°ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯idleçš„æ—¶å€™ä¼šå¹²å˜›ã€‚åˆ†ä¸ºéæ ¸å¿ƒçº¿ç¨‹å’Œæ ¸å¿ƒçº¿ç¨‹ã€‚è¿™é‡Œåˆ†allowCoreThreadTimeOutå»è¯´ï¼›
- æ ¸å¿ƒçº¿ç¨‹åœ¨è·å–ä¸åˆ°ä»»åŠ¡æ—¶ï¼Œä¼šç©ºè½¬è¿˜æ˜¯parkï¼Ÿ

ä»‹ç»ä¸€ä¸‹**çº¿ç¨‹æ± çš„**å‡ ä¸ªçŠ¶æ€ï¼š

- `RUNNING`ï¼šå…è®¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šå¤„ç†åœ¨é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›
- `SHUTDOWN`ï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¹Ÿä¼šå¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›
- `STOP`ï¼šä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¯¹äºæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¹Ÿä¼šå°è¯•ä¸­æ–­å®ƒä»¬ï¼›
- `TIDYING`ï¼šæ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»åœæ­¢äº†ï¼Œå¹¶ä¸”æ­¤æ—¶`workerCountOf(c)`åº”è¯¥æ˜¯0ã€‚å¦‚æœçº¿ç¨‹æ± æ­£åœ¨è½¬ç§»åˆ°`TIDYING`çŠ¶æ€ï¼Œä¼šæ‰§è¡Œä¸€äº›hookæ–¹æ³•ï¼›
- `TERMINATED`ï¼š`terminated()`æ–¹æ³•å·²ç»å®Œæˆåçš„çŠ¶æ€ã€‚

çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªçŠ¶æ€çš„è¡¨ç¤ºï¼š

```java
private static final int COUNT_BITS = Integer.SIZE - 3;
// runState is stored in the high-order bits
private static final int RUNNING    = -1 << COUNT_BITS;
private static final int SHUTDOWN   =  0 << COUNT_BITS;
private static final int STOP       =  1 << COUNT_BITS;
private static final int TIDYING    =  2 << COUNT_BITS;
private static final int TERMINATED =  3 << COUNT_BITS;
```

å…¶ä¸­ï¼Œ`COUNT_BITS`æ˜¯intç±»å‹å¤§å°-3ï¼Œä¹Ÿå°±æ˜¯32-3=29ã€‚æ³¨æ„ï¼Œ**è®¡ç®—æœºå®é™…ä¸Šæ˜¯ç”¨è¡¥ç å­˜çš„æ•°å­—**ï¼Œæ‰€ä»¥è¿™å‡ ä¸ªçŠ¶æ€çš„å®é™…å€¼æ˜¯è¿™æ ·çš„ï¼š

| çŠ¶æ€           | åè¿›åˆ¶        |                                 äºŒè¿›åˆ¶ |
| ------------ | ---------- | ----------------------------------: |
| -            | -1         | `111,11111111111111111111111111111` |
| -            | 2147483647 | `011,11111111111111111111111111111` |
| `RUNNING`    | -536870912 | `111,00000000000000000000000000000` |
| `SHUTDOWN`   | 0          |                                 `0` |
| `STOP`       | 536870912  | `001,00000000000000000000000000000` |
| `TIDYING`    | 1073741824 | `010,00000000000000000000000000000` |
| `TERMINATED` | 1610612736 | `011,00000000000000000000000000000` |

æˆ‘ä»¬èƒ½å‘ç°ï¼Œéšç€æ•°å­—ä¸æ–­å˜å¤§ï¼ŒçŠ¶æ€ä¹Ÿé€æ¸å‘ç€å…³é—­æµè½¬ã€‚è¿™é‡Œç”¨çš„æ˜¯intçš„æœ€é«˜çš„3bitè¡¨ç¤ºè¿™äº›çŠ¶æ€ã€‚è€Œå‰©ä¸‹çš„29bitå°±ç”¨æ¥è¡¨ç¤ºå·¥ä½œçº¿ç¨‹çš„æ•°é‡äº†ã€‚å°±åƒæ³¨é‡Šé‡Œè¯´çš„ï¼š

> In order to pack them **into one int**, we limit workerCount to  `(2^29)-1` (about 500 million) threads rather than `(2^31)-1` (2 billion) otherwise representable. If this is ever an issue in the future, the variable can be changed to be an AtomicLong, and the shift/mask constants below adjusted. But until the need arises, this code is a bit faster and simpler using an int.

è€Œè¿™ä¸ªintå°±æ˜¯è¯¥çº¿ç¨‹æ± çš„æ ¸å¿ƒçŠ¶æ€æ§åˆ¶ï¼š

```java
// åˆå§‹çŠ¶æ€ï¼Œstate == RUNNING, workerCount == 0
private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
```

å†æ¬¡æ¯”è¾ƒä¸€ä¸‹è¿™å‡ ä¸ªçŠ¶æ€çš„å€¼ï¼Œæˆ‘ä»¬èƒ½å‘ç°ï¼Œä¸ç®¡åé¢29bitæ˜¯å¤šå°‘ï¼Œå¯¹äºæ•´ä¸ªctlæ¥è¯´ï¼Œåªè¦å‰ä¸‰ä½æ˜¯ä¸€å®šçš„ï¼Œé‚£ä¹ˆå¤§å°å…³ç³»å°±æ˜¯ç¡®å®šçš„ã€‚è¿™å°±åƒï¼Œ100å¤šä¸‡ä¸€å®šæ¯”200å¤šä¸‡è¦å°ï¼Œä¸ç®¡åé¢çš„é›¶å¤´æ˜¯å¤šå°‘ã€‚å› æ­¤ï¼Œå¦‚æœè¦åˆ¤æ–­å½“å‰å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œå…¶å®ä¸éœ€è¦å•ç‹¬æŠŠctlçš„æœ€é«˜3bitå–å‡ºæ¥ï¼Œç›´æ¥æ•´ä¸ªæ¯”å°±è¡Œäº†ã€‚è¿™ä¹Ÿå°±æ˜¯è¿™äº›æ–¹æ³•äº§ç”Ÿçš„åŸå› ï¼š

```java
/*
 * Bit field accessors that don't require unpacking ctl.
 * These depend on the bit layout and on workerCount being never negative.
 */

private static boolean runStateLessThan(int c, int s) {
	return c < s;
}

private static boolean runStateAtLeast(int c, int s) {
	return c >= s;
}

private static boolean isRunning(int c) {
	return c < SHUTDOWN;
}
```

ä»¥`runStateAtLeast()`ä¸ºä¾‹ï¼Œåœ¨å¢åŠ çº¿ç¨‹çš„æ–¹æ³•`addWorker()`çš„æ—¶å€™å°±ä¼šè°ƒç”¨åˆ°è¿™é‡Œã€‚ç°åœ¨å°±æ˜¯ç®€å•çœ‹ä¸€çœ‹ï¼š ^29b849

```java
// Check if queue empty only if necessary.
if (runStateAtLeast(c, SHUTDOWN)
	&& (runStateAtLeast(c, STOP)
		|| firstTask != null
		|| workQueue.isEmpty()))
	return false;
```

è¿™æ˜¯å…¶ä¸­ä¸€ä¸ªå°éƒ¨åˆ†ï¼Œè¡¨ç¤ºå¦‚æœæ»¡è¶³è¿™äº›æƒ…å†µï¼Œæˆ‘æ‹’ç»åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚åˆ¤æ–­çš„é€»è¾‘å¦‚ä¸‹ï¼š

- çº¿ç¨‹æ± å¿…é¡»è‡³å°‘æ˜¯`SHUTDOWN`çŠ¶æ€ï¼›
- ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸€æˆç«‹ï¼š
	- è‡³å°‘æ˜¯`STOP`çŠ¶æ€ï¼›
	- è¦è®©æ–°åˆ›å»ºçš„çº¿ç¨‹ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ä¸ä¸ºç©ºï¼›
	- é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ã€‚

æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ã€‚é¦–å…ˆï¼Œå¦‚æœæ˜¯`RUNNING`çŠ¶æ€ï¼Œé‚£è‚¯å®šæ²¡é—®é¢˜å¯ä»¥åˆ›å»ºã€‚ä½†æ˜¯å¦‚æœæ˜¯`SHUTDOWN`çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰**ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¹Ÿä¼šå¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡**ã€‚æ‰€ä»¥ï¼Œå¯¹äºåé¢çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œ`firstTask != null`è¡¨ç¤ºæœ‰æ–°çš„ä»»åŠ¡ï¼Œæˆ‘ä¸æ¥å—å®ƒï¼›`workQueue.isEmpty()`è¡¨ç¤ºé˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œæ‰€ä»¥ä¸ç”¨å¤„ç†ã€‚è¿™æ ·è‡ªç„¶å°±éœ€è¦æ‹’ç»åˆ›å»ºæ–°çº¿ç¨‹ã€‚è‡³äº`STOP`çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œè¿é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡éƒ½è¦å…¨éƒ¨ä¸­æ–­ï¼Œæ‰€ä»¥ä¸ç®¡ä½ è¦å¹²å˜›ï¼Œè¿™ä¸ªæ—¶å€™ç»å¯¹ä¸å…è®¸åˆ›å»ºæ–°çº¿ç¨‹äº†ã€‚

- [ ] #TODO tasktodo1724255272132 åœ¨shutdownä¹‹åï¼Œå¦‚æœæˆ‘æ‚„æ‚„æŠŠæ‰€æœ‰workeréƒ½å¹²æ‰ï¼Œä½†æ˜¯ä»»åŠ¡é˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡ã€‚è¿™ä¸ªæ—¶å€™æˆ‘addWorkerçš„æ—¶å€™è¦æ˜¯æ¯ä¸€ä¸ªéƒ½å¸¦ç€firstTaskï¼Œé‚£æ˜¯ä¸æ˜¯çº¿ç¨‹æ± å°±æ°¸è¿œå…³ä¸æ‰äº†ï¼Ÿï¼Ÿ â• 2024-08-21 ğŸ”½ ğŸ†” 6n5jlv

ç„¶åç»™ä¸€ä¸‹çº¿ç¨‹æ± çŠ¶æ€ä¹‹é—´çš„æµè½¬ã€‚å½“ç„¶ï¼Œåªèƒ½å•å‘æµè½¬ã€‚

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2024-08-21 23.57.38.excalidraw.svg]]

æ¥ä¸‹æ¥ï¼Œä»‹ç»å·¥ä½œçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯workerçš„æ·»åŠ ã€‚å”¯ä¸€æ·»åŠ workerçš„æ–¹æ³•æ˜¯è°ƒç”¨`addWorker()`ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ç»å¤§å¤šæ•°æƒ…å†µæ˜¯è°ƒç”¨`execute()`æäº¤ä»»åŠ¡çš„æ—¶å€™ä¼šè¿›è¡Œã€‚å‰©ä¸‹çš„æƒ…å†µéƒ½æ˜¯ä¸€äº›è¾¹ç•Œæƒ…å†µï¼Œæ¯”å¦‚ä¿®æ”¹æ ¸å¿ƒçº¿ç¨‹æ•°é‡ç­‰ã€‚æˆ‘ä»¬å¾ˆå°‘ä¼šè°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå—¯ã€‚

æ˜¯å¦å¯ä»¥å¢åŠ ä¸€ä¸ªworkerï¼Œä¸»è¦å–å†³äºï¼š

1. å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€ã€‚è¿™ä¸ªæˆ‘ä»¬åˆšåˆšè®²è¿‡ï¼›
2. å·²å­˜åœ¨çš„çº¿ç¨‹æ•°é‡ï¼Œè¿™ä¸ªä¸çº¿ç¨‹æ˜¯å¦æ˜¯æ ¸å¿ƒçº¿ç¨‹æœ‰å…³ã€‚

åˆšåˆšæ·»åŠ workeræ—¶ï¼Œå°±ä¼šè¿›è¡Œæˆ‘ä»¬ä»‹ç»è¿‡çš„åˆ¤æ–­ï¼š

```java
// Check if queue empty only if necessary.
if (runStateAtLeast(c, SHUTDOWN)
	&& (runStateAtLeast(c, STOP)
		|| firstTask != null
		|| workQueue.isEmpty()))
	return false;
```

è¿™ä¸ªæ¡ä»¶å¦‚æœé€šè¿‡ï¼Œé‚£ä¹ˆå°±è¦å¼€å§‹åˆ›å»ºã€‚å½“ç„¶ï¼Œåˆ›å»ºçš„æ—¶å€™ï¼Œéœ€è¦è¿›è¡Œå­˜åœ¨çº¿ç¨‹æ•°çš„åˆ¤æ–­ï¼š

```java
if (workerCountOf(c) >= ((core ? corePoolSize : maximumPoolSize) & COUNT_MASK))
	return false;
```

åæ­£è¦ä¹ˆæ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè¦ä¹ˆæ˜¯æœ€å¤§çº¿ç¨‹æ•°ã€‚å°±å–å†³äºå½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚ä»è¿™é‡Œæˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œå…¶å®ä¸æ˜¯ç”±Workeræ¥è®°å¿†çš„ã€‚**çº¿ç¨‹æ± å¯¹å¾…æ ¸å¿ƒçº¿ç¨‹ï¼Œå’Œå¯¹å¾…éæ ¸å¿ƒçº¿ç¨‹çš„è¡Œä¸ºæ˜¯å®Œå…¨ä¸€è‡´çš„**ã€‚ä¹‹æ‰€ä»¥æœ‰æ ¸å¿ƒå’Œéæ ¸å¿ƒä¸€è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬ä¼šç”¨è¿™ä¸ªupper boundå»æ§åˆ¶æ•°é‡ã€‚è€Œåœ¨åé¢æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°ï¼Œä¹‹æ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šé€€å‡ºï¼Œä¹Ÿæ˜¯å› ä¸ºçº¿ç¨‹åœ¨å–ä»»åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœæ²¡å–åˆ°ï¼Œè¿˜ä¼šåˆ¤æ–­ä¸€ä¸‹å½“å‰å­˜æ´»çš„çº¿ç¨‹æ•°é‡ä¸æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚æ¢å¥è¯è¯´ï¼Œ**æˆ‘ä»¬ä¸å…³å¿ƒâ€œå“ªå‡ ä¸ªâ€çº¿ç¨‹æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œæˆ‘ä»¬åªå…³å¿ƒéœ€è¦â€œæœ‰å‡ ä¸ªâ€çº¿ç¨‹æ˜¯æ ¸å¿ƒçº¿ç¨‹**ã€‚è€Œâ€œæœ‰å‡ ä¸ªâ€ï¼Œç”¨æ ¸å¿ƒçº¿ç¨‹æ•°è¿™ä¸ªupper boundå»åˆ¤æ–­è¶³çŸ£ã€‚

æ¥ä¸‹æ¥ï¼Œä¼šå°è¯•å¢åŠ workerçš„æ•°é‡ã€‚è¿˜è®°å¾—è¿™ä¸ªä¸œè¥¿åœ¨å“ªå„¿å­˜çš„å—ï¼Ÿå°±æ˜¯workerCountï¼Œé‚£æ˜¾ç„¶æ˜¯åœ¨`ctl`é‡Œå­˜çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å•ç‹¬è®¾ç½®è¿™ä¸ªAtomicIntegerï¼Œé‚£æ˜¾ç„¶å°±æ˜¯ä¼šç”¨CASå»è®¾ç½®ã€‚å¦‚æœè®¾ç½®æˆåŠŸäº†ï¼Œé‚£å½“ç„¶ç»§ç»­å°±è¡Œäº†ï¼›å¦‚æœå¤±è´¥äº†ï¼Œå°±è¦é‡è¯•ã€‚ ^283ad8

åˆ°äº†è¿™é‡Œï¼Œå…¶å®è¿˜æœ‰ä¸€ç§æƒ…å†µæ²¡æœ‰è¦†ç›–åˆ°ã€‚å°±æ˜¯å¦‚æœä½ çš„CASä¸€ç›´å¤±è´¥ï¼Œä¼šä¸€ç›´é‡è¯•ã€‚ä½†æ˜¯å¦‚æœä¸æ–­é‡è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¤–é¢æŠŠçº¿ç¨‹æ± ç»™å…³äº†ã€‚è¿™ä¸ªæ—¶å€™è¦èµ°ä¸€å¼€å§‹åˆ¤æ–­SHUTDOWN, STOPçš„é€»è¾‘ã€‚TPEçš„å®ç°æ€è·¯å¦‚ä¸‹ã€‚æˆ‘ä»¬é‡è¯•CASçš„è¿‡ç¨‹ï¼Œè¢«åŒ…åœ¨ä¸€ä¸ªæ— é™çš„forå¾ªç¯é‡Œï¼š

```java
for (;;) {
	/* ä¸æ–­å°è¯•CASï¼Œå¦‚æœæˆåŠŸäº†å°±è¦è·³å‡ºå¾ªç¯ */
}
```

ç„¶åä¸€å¼€å§‹çŠ¶æ€çš„åˆ¤æ–­ï¼Œæ˜¯åœ¨è¿™ä¸ªforå¾ªç¯çš„ä¸Šé¢åšçš„ï¼š

```java
// Check if queue empty only if necessary.
if (runStateAtLeast(c, SHUTDOWN) ...
for (;;) {
	/* ä¸æ–­å°è¯•CASï¼Œå¦‚æœæˆåŠŸäº†å°±è¦è·³å‡ºå¾ªç¯ */
}
```

é‚£ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œåœ¨forå¾ªç¯é‡Œé¢éœ€è¦åˆ¤æ–­TPEçš„çŠ¶æ€ï¼Œç„¶åè¿˜éœ€è¦é‡æ–°èµ°ä¸€éå¤–é¢çš„é€»è¾‘ã€‚è¿™é‡Œçš„åšæ³•å°±æ˜¯ï¼Œå†ç”¨ä¸€å±‚forå¾ªç¯åŒ…èµ·æ¥ï¼Œå¹¶åŠ ä¸Šæ ‡ç­¾ã€‚è¿™æ ·æˆ‘ä»¬continueçš„æ—¶å€™å°±å¯ä»¥continueåˆ°å¤–å±‚çš„å¾ªç¯äº†ï¼š

```java
retry:
for (int c = ctl.get();;) {
	// Check if queue empty only if necessary.
	if (runStateAtLeast(c, SHUTDOWN) ...
	for (;;) {
		/* ä¸æ–­å°è¯•CASï¼Œå¦‚æœæˆåŠŸäº†å°±è¦è·³å‡ºå¾ªç¯ */
		c = ctl.get();  // Re-read ctl
		if (runStateAtLeast(c, SHUTDOWN))
			continue retry;  // è¿™é‡Œè·³åˆ°äº†retryï¼Œä¹Ÿå°±æ˜¯å¤–å±‚å¾ªç¯
	}
}

```

å¹¶ä¸”æ³¨æ„ï¼Œå¤–å±‚å¾ªç¯çš„é‚£ä¸ªæ¡ä»¶é‡Œï¼Œåé¢ä¸¤ä¸ªè¯­å¥éƒ½æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ„å‘³ç€å¤–å±‚å¾ªç¯ä¹Ÿåªä¼šæ‹¿ä¸€æ¬¡`ctl`ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ‰ä¼šåœ¨å†…å±‚å¾ªç¯å¸®å®ƒæ‹¿ä¸€æ¬¡`ctl`ï¼Œè¿™æ ·åˆ°äº†å¤–å±‚å¾ªç¯é‡è¯•ï¼Œå°±ä¼šç”¨æˆ‘ä»¬åˆšåˆšåœ¨å†…å±‚å¾ªç¯æ‹¿åˆ°çš„æ–°çš„`ctl`å»åšçŠ¶æ€åˆ¤æ–­ï¼Œä»è€Œæ­£ç¡®è¿”å›falseã€‚

è¿™éƒ¨åˆ†å®Œæ•´çš„ä»£ç ï¼š

```java
private boolean addWorker(Runnable firstTask, boolean core) {
	retry:
	for (int c = ctl.get();;) {
		// Check if queue empty only if necessary.
		if (runStateAtLeast(c, SHUTDOWN)
			&& (runStateAtLeast(c, STOP)
				|| firstTask != null
				|| workQueue.isEmpty()))
			return false;

		for (;;) {
			if (workerCountOf(c) >= ((core ? corePoolSize : maximumPoolSize) & COUNT_MASK))
				return false;
			if (compareAndIncrementWorkerCount(c))
				break retry;
			c = ctl.get();  // Re-read ctl
			if (runStateAtLeast(c, SHUTDOWN))
				continue retry;
			// else CAS failed due to workerCount change; retry inner loop
		}
	}
	
	/* æˆåŠŸè®¾ç½®CAS,å¼€å§‹æ·»åŠ worker */
}
```

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰çœŸæ­£åˆ›å»ºWorkerå®ä¾‹ï¼Œæ›´æ²¡æœ‰åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚ä½†æ˜¯æˆ‘ä»¬å´è®¾ç½®äº†`ctl`ï¼ŒæŠŠworkerCountç»™+1äº†ã€‚æ‰€ä»¥åé¢å¦‚æœworkeræ²¡æœ‰çœŸæ­£è¢«åˆ›å»ºå‡ºæ¥ï¼ˆå› ä¸ºå„ç§å¼‚å¸¸ï¼‰ï¼Œè¿˜éœ€è¦è¿›è¡ŒçŠ¶æ€å›æ»šã€‚

åˆ›å»ºWorkerçš„è¿‡ç¨‹å°±å…ˆä¸è¯´äº†ï¼Œåœ¨åˆ›å»ºä¹‹åï¼Œéœ€è¦æ·»åŠ ã€‚æ·»åŠ ä¹‹å‰ï¼Œæœ€é‡è¦çš„ä¸€ä»¶äº‹å°±æ˜¯è·å–è¿™ä¸ªå…¨å±€é”ï¼š

```java
final ReentrantLock mainLock = this.mainLock;
mainLock.lock();
```

åœ¨`addWorker()`ä¸­ï¼Œè·å–è¿™ä¸ªé”çš„ä¸»è¦ç›®çš„æ˜¯é¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼ŒåŒæ—¶æ“ä½œ`workers`è¿™ä¸ªç»“æ„ï¼Œå®ƒæ˜¯å¾ˆè„†å¼±çš„ï¼š

```java
/**
 * Set containing all worker threads in pool. Accessed only when
 * holding mainLock.
 */
private final HashSet<Worker> workers = new HashSet<>();
```

> [!question]-
> è¿™ä¸ªæ—¶å€™ä½ å¯èƒ½å°±ä¼šé—®äº†ï¼š*æˆ‘ç”¨ä¸€äº›å¹¶å‘çš„é›†åˆï¼Œæ¯”å¦‚CopyOnWriteArrayListä¹‹ç±»çš„ï¼Œä¸æ˜¯å°±èƒ½é¿å…ä½¿ç”¨é”äº†å—*ï¼Ÿç¡®å®ã€‚ä½†æ˜¯è¿™é‡Œé€‰æ‹©ç”¨é”çš„åŸå› ï¼Œä¹Ÿå†™åœ¨mainLockçš„æ³¨é‡Šé‡Œäº†ã€‚æœ€ä¸»è¦çš„åŸå› å°±æ˜¯**é¿å…"interrupt storm"**ã€‚åœ¨TPEé‡Œæœ‰ä¸ªæ–¹æ³•å«`interruptIdleWorkers()`ï¼ŒåŠŸèƒ½æ˜¯ä¸­æ–­æ­£åœ¨ç­‰ç€ä»»åŠ¡çš„çº¿ç¨‹ã€‚å¤§æ¦‚çœ‹ä¸€çœ¼å®ç°å°±èƒ½æ˜ç™½ï¼Œè¿™é‡Œé¢åšçš„å…¶å®å°±æ˜¯å°½å¯èƒ½ï¼ŒæŠŠ`workers`é‡Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½ç»™ä¸­æ–­ã€‚çº¿ç¨‹æ˜¯å¦åœ¨æ‰§è¡Œä»»åŠ¡æ˜¯é€šè¿‡`w.tryLock()`çš„è¿”å›å€¼å†³å®šçš„ã€‚è¿™ä¸ªæˆ‘ä»¬åé¢ä¼šè¯´ã€‚æ˜¾ç„¶ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹å¹¶å‘åœ°è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œé‚£è¿˜çœŸå°±æ˜¯ä¸€ä¸ª"interrupt storm"ã€‚å› ä¸ºç›¸å½“äºåŒæ—¶æœ‰å¤šä¸ªçº¿ç¨‹å¯¹`workers`è¿›è¡Œéå†ï¼Œå¹¶ä¸”å¯¹å…¶ä¸­çš„workerè¿›è¡Œä¸­æ–­ï¼ˆæ­£åœ¨é€€å‡ºçš„çº¿ç¨‹å¹¶å‘åœ°ä¸­æ–­é‚£äº›è¿˜æ²¡è¢«ä¸­æ–­çš„çº¿ç¨‹ï¼‰ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åªèƒ½å°†`interruptIdleWorkers()`çš„æ‰§è¡Œç»™åŸå­åŒ–ï¼Œä¹Ÿå°±æ˜¯æ³¨é‡Šä¸­è¯´çš„"serializes"ï¼ˆåºåˆ—åŒ–ï¼Œå°±æ˜¯æŒ‡æŠŠå¤šä¸ª`interruptIdleWorkers()`çš„è°ƒç”¨æ’æˆä¸€æ’ï¼Œè¿™æ ·æ¯ä¸€ä¸ªè°ƒç”¨å°±ä¼šè¢«è®¤ä¸ºæ˜¯åŸå­çš„ï¼‰ã€‚è€Œå¦‚æœä¸è¿™ä¹ˆåšçš„è¯ï¼Œå¯ä»¥çœ‹çœ‹`processWorkerExit()`æ–¹æ³•ã€‚å®ƒæ˜¯workeræ‰§è¡Œç»“æŸçš„æ—¶å€™è°ƒç”¨çš„ã€‚è¿™é‡Œé¢æœ€ç»ˆå°±ä¼šè°ƒç”¨åˆ°`interruptIdleWorkers()`ã€‚æ„å‘³ç€ï¼Œè¿™äº›å°†è¦ç»“æŸçš„çº¿ç¨‹ï¼Œå¦‚æœåŒæ—¶ç»“æŸï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå¹¶å‘åœ°è°ƒç”¨åˆ°`interruptIdleWorkers()`ï¼Œå¯¼è‡´ä¹‹å‰æ‰€è¯´çš„"interrupt storm"ã€‚è€Œ**å¦‚æœæˆ‘ä»¬è°ƒç”¨äº†`shutdown()`ï¼Œè¿™ç§æƒ…å†µä¼šæ›´åŠ ä¸¥é‡**ã€‚å› ä¸ºæ¯ä¸ªç»“æŸçš„çº¿ç¨‹éƒ½ä¼šæ¥ä¸€éè¿™æ ·çš„æ“ä½œã€‚
> 
> é™¤äº†ç»™workersåŠ é”ï¼ŒmainLockè¿˜æœ‰ä¸€ä¸ªæ›´é‡è¦çš„ä½œç”¨ï¼Œå°±æ˜¯**è®©[[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2024-08-21 23.57.38.excalidraw.svg|çº¿ç¨‹æ± çŠ¶æ€çš„è½¬ç§»]]ä¹Ÿè¦åŸå­åŒ–**ã€‚ä¸€æ—¦è·å–äº†mainLockï¼Œæˆ‘èƒ½ä¿è¯ä¹‹åè·å–çš„çº¿ç¨‹æ± çŠ¶æ€ï¼Œ**åœ¨é”çš„ä½œç”¨åŸŸå†…ä¸€å®šæ˜¯æ­£ç¡®çš„**ï¼Œç»å¯¹ä¸ä¼šè¢«åˆ«äººæ”¹å˜ã€‚è¿™ä¸ªåŠŸèƒ½é©¬ä¸Šå°±ä¼šä½“ç°ã€‚

- [ ] #TODO tasktodo1724436111909 ç»“åˆå¦¥å–„ç»ˆç»“çº¿ç¨‹çš„æ–¹æ³•ï¼Œæ¥è¯´æ˜TPEçš„shutdownæ˜¯æ€ä¹ˆå®ç°çš„ã€‚ â• 2024-08-24 ğŸ”º ğŸ†” oqel59 

è·å–äº†é”ä¹‹åï¼ŒçœŸæ­£è¦æ·»åŠ workerï¼Œè¿˜éœ€è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼š

- çº¿ç¨‹æ± çŠ¶æ€æ»¡è¶³æ¡ä»¶ï¼›
- çº¿ç¨‹æ­£å¸¸å¯åŠ¨ã€‚

æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€ä¸ªã€‚è¿™é‡Œæ˜¾ç„¶æ— éè¿˜æ˜¯è¦æŸ¥ä¸€ä¸‹ctlï¼Œä½†æ˜¯è¿™é‡Œçš„ä»£ç ä¾ç„¶å¾ˆæ™¦æ¶©ï¼š

```java
// Recheck while holding lock.  
// Back out on ThreadFactory failure or if  
// shut down before lock acquired.  
int c = ctl.get();  
  
if (isRunning(c) || (runStateLessThan(c, STOP) && firstTask == null)) {
	... ...
}
```

ä»æ³¨é‡Šçš„æç¤ºå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœåœ¨mainLockçš„è·å–ä¹‹å‰ï¼Œæ›´å‡†ç¡®æ¥è¯´ï¼Œåœ¨ä¸Šé¢é‚£ä¸¤ä¸ªforå¾ªç¯è·³å‡ºæ¥ä¹‹åï¼Œå’ŒmainLockè·å–ä¹‹å‰ï¼Œå¦‚æœæœ‰äººå…³æ‰äº†çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œä¼šè¿›è¡Œæœ€åä¸€æ¬¡æ•æ‰ã€‚æ•æ‰çš„ä»£ç å°±æ˜¯ifé‡Œé¢çš„æ¡ä»¶ã€‚

`isRunning(c)`è¿™ä¸ªå¾ˆå¥½æ‡‚ï¼Œå°±ä¸è¯´äº†ï¼Œä½†æ˜¯åé¢åˆæ˜¯å•¥æ„æ€ã€‚`isRunning`è¡¨ç¤ºå½“å‰æ˜¯RUNNINGçŠ¶æ€ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œå¹¶ä¸”åé¢è¿™ä¸ªæ¡ä»¶ä¹Ÿæ»¡è¶³äº†ï¼Œless than STOPï¼Œé‚£ä¹ˆå½“å‰çš„çŠ¶æ€è‚¯å®šæ˜¯SHUTDOWNï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»è·å–mainLockäº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœfirstTaskè¿˜æ˜¯ç©ºçš„è¯ï¼Œä»£è¡¨æ²¡æœ‰æ–°ä»»åŠ¡æäº¤ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥è®©è¿™ä¸ªæ–°çš„workerå»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚æ‰€ä»¥è¿™é‡Œå…è®¸æ·»åŠ ï¼›è€Œå¦‚æœfirstTaskä¸æ˜¯ç©ºï¼Œä»£è¡¨è¿™ä¸ªworkerè¦å¤„ç†æ–°ä»»åŠ¡ã€‚ä½†æ˜¯SHUTDOWNçŠ¶æ€ä¸å…è®¸å¤„ç†æ–°ä»»åŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œä¸è®©æ·»åŠ ã€‚

> [!summary]
> æ€»ç»“ä¸€ä¸‹ä¸Šé¢â€œå…è®¸æ·»åŠ workerâ€çš„æƒ…å†µã€‚å°±æ˜¯ä¸¤ç§ï¼š
> 
> - RUNNINGçŠ¶æ€ï¼›
> - SHUTDOWNçŠ¶æ€ï¼Œå¹¶ä¸”è¿™ä¸ªæ·»åŠ çš„workeræ˜¯è¦å»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡çš„ï¼Œè€Œä¸æ˜¯firstTaskã€‚
> 
> å¦‚æœä½ æ˜¯STOPåŠä»¥ä¸Šçš„çŠ¶æ€ï¼Œå•¥çº¿ç¨‹ä¹Ÿä¸è®©ä½ åŠ äº†ï¼Œè¿™é‡Œå°±ç›´æ¥ä¸ä¼šæ‰§è¡Œã€‚

å¥½äº†ï¼Œçœ‹ç¬¬äºŒä¸ªï¼Œçº¿ç¨‹æ˜¯å¦æ­£å¸¸å¯åŠ¨ã€‚è¿™ä¸ªåˆ¤æ–­å°±å¾ˆç®€å•äº†ï¼š

```java
if (t.getState() != Thread.State.NEW)
	throw new IllegalThreadStateException();
```

ä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚

å¦‚æœæ¡ä»¶éƒ½æ»¡è¶³ï¼Œå°±å¯ä»¥æ·»åŠ workeräº†ï¼š

```java
workers.add(w);  
workerAdded = true;  
int s = workers.size();  
if (s > largestPoolSize)  
    largestPoolSize = s;
```

è¿™é‡Œçš„`largestPoolSize`æ²¡æœ‰å®ƒç”¨ï¼Œæ˜¯çº¯ç²¹æä¾›ç»™ä¸šåŠ¡æ–¹çš„ã€‚ç”¨æ¥æ ‡è¯†è¿™ä¸ªçº¿ç¨‹æ± é‡Œ**æ›¾ç»å‡ºç°è¿‡çš„**æœ€å¤šçš„çº¿ç¨‹æ•°ã€‚

æœ€åï¼Œæ— éä¸¤ç§ç»“æœï¼Œæ·»åŠ æˆåŠŸæˆ–è€…å¤±è´¥ï¼š

- æˆåŠŸï¼Œå¯åŠ¨workerçš„çº¿ç¨‹ï¼›
- å¤±è´¥ï¼Œå›æ»šçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯`addWorkerFailed()`æ–¹æ³•ã€‚

> [!note]
> åœ¨èµ°æˆåŠŸæˆ–è€…å¤±è´¥çš„é€»è¾‘ä¹‹å‰ï¼Œä¼šå…ˆé‡Šæ”¾ä¸€ä¸‹mainLockã€‚

å…ˆçœ‹æˆåŠŸï¼Œç›´æ¥æ”¾ä»£ç ï¼Œä¸ç”¨è¯´ï¼š

```java
if (workerAdded) {
	t.start();
	workerStarted = true;
}
```

ç„¶åæ˜¯å¤±è´¥ã€‚è¿™é‡Œéœ€è¦è¿›è¡Œå›æ»šã€‚å›æ»šçš„æ“ä½œå½“ç„¶æ˜¯ä»workersé‡Œç§»é™¤æ·»åŠ çš„workerï¼Œç„¶åæŠŠworkerCountè®¾ç½®å›æ¥ã€‚å› ä¸ºä¹Ÿè¦æ“ä½œworkersï¼Œæ‰€ä»¥ä¹Ÿè¦è·å–mainLockã€‚ ^ffb99a

æˆ‘å½“æ—¶çœ‹åˆ°è¿™æ®µä»£ç ï¼Œæœ€å¥‡æ€ªçš„å°±æ˜¯ï¼Œä¸ºä»€ä¹ˆä¼šå»removeã€‚æˆ‘ä»¬çœ‹çœ‹å¤±è´¥çš„å‡ºå‘ç‚¹ï¼š

```java
if (!workerStarted)  
    addWorkerFailed(w);
```

åªæœ‰workerStartedæ˜¯falseæ‰ä¼šè§¦å‘ã€‚ä½†æ˜¯å¦‚æœremoveçš„æ—¶å€™workerçœŸçš„åœ¨workersé‡Œé¢ï¼Œè¯æ˜åˆšæ‰çš„`workers.add(w)`æ˜¯æˆåŠŸçš„ï¼Œåˆ™è¯æ˜`workerAdded`ä¸€å®šæ˜¯trueï¼Œåˆ™è¯æ˜`t.start(); workerStarted = true;`ä¸€å®šä¼šè¢«æ‰§è¡Œã€‚é‚£è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœè¿˜å­˜åœ¨ï¼Œå”¯ä¸€çš„è§£é‡Šå°±æ˜¯ï¼Œ`t.start()`æŠ›å‡ºäº†å¼‚å¸¸ã€‚è€Œè¿™ä¸ªå¼‚å¸¸ä¼šå†ç”¨ä¸€ä¸ªtry catchæ•è·ï¼Œå¯¼è‡´åœ¨`addWorkerFailed`çš„æ—¶å€™ï¼Œå‘ç°workersé‡Œå±…ç„¶è¿˜æœ‰æˆ‘åˆšåˆšæ·»åŠ çš„workerã€‚

> [!attention]
> ä¸Šé¢è¿™æ®µå¯¹ç€ä»£ç ç†è§£ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘å°±å¯ä»¥æŠŠæ•´ä¸ªaddWorkeræ–¹æ³•è´´å‡ºæ¥äº†ï¼Œæ¯ä¸€å¥ä»£ç æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œéƒ½åº”è¯¥å¾ˆæ¸…æ¥šäº†ï¼š

```java
private boolean addWorker(Runnable firstTask, boolean core) {
	retry:
	for (int c = ctl.get();;) {
		// Check if queue empty only if necessary.
		if (runStateAtLeast(c, SHUTDOWN)
			&& (runStateAtLeast(c, STOP)
				|| firstTask != null
				|| workQueue.isEmpty()))
			return false;

		for (;;) {
			if (workerCountOf(c) >= ((core ? corePoolSize : maximumPoolSize) & COUNT_MASK))
				return false;
			if (compareAndIncrementWorkerCount(c))
				break retry;
			c = ctl.get();  // Re-read ctl
			if (runStateAtLeast(c, SHUTDOWN))
				continue retry;
			// else CAS failed due to workerCount change; retry inner loop
		}
	}

	/* CASæˆåŠŸï¼Œå¼€å§‹æ·»åŠ worker */

	boolean workerStarted = false;
	boolean workerAdded = false;
	Worker w = null;
	try {  // å¤–å±‚çš„try catchä¸»è¦ç”¨äºæ•è·t.start()çš„å¼‚å¸¸
		w = new Worker(firstTask);
		final Thread t = w.thread;
		if (t != null) {
			final ReentrantLock mainLock = this.mainLock;
			mainLock.lock();
			try {  // å†…å±‚çš„try catchä¸»è¦ç”¨äºæ•è·IllegalThreadStateException
				// Recheck while holding lock.
				// Back out on ThreadFactory failure or if
				// shut down before lock acquired.
				int c = ctl.get();

				if (isRunning(c) ||
					(runStateLessThan(c, STOP) && firstTask == null)) {
					if (t.getState() != Thread.State.NEW)
						throw new IllegalThreadStateException();
					workers.add(w);
					workerAdded = true;
					int s = workers.size();
					if (s > largestPoolSize)
						largestPoolSize = s;
				}
			} finally {
				mainLock.unlock();
			}
			if (workerAdded) {
				t.start();
				workerStarted = true;
			}
		}
	} finally {
		if (! workerStarted)
			addWorkerFailed(w);
	}
	return workerStarted;
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬ä»æ¯ä¸€ä¸ªworkerçš„ç”Ÿå‘½å‘¨æœŸå‡ºå‘ï¼Œæ¥çœ‹çº¿ç¨‹æ˜¯æ€ä¹ˆæ¥æ”¶ä»»åŠ¡ï¼Œå¤„ç†ä»»åŠ¡ï¼Œæœ€ååˆæ˜¯æ€ä¹ˆç»“æŸè‡ªå·±çš„ã€‚

Workerè¿™ä¸ªç±»æ˜¯ç»§æ‰¿è‡ªAQSã€‚é‚£è‡ªç„¶å®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªé”ã€‚è¿™ä¸ªé”å’ŒmainLockæœ‰å•¥åŒºåˆ«å‘¢ï¼ŸmainLockçš„åŠŸèƒ½æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡äº†ï¼š

1. é¿å…æœ‰å¤šä¸ªå·¥ä½œçº¿ç¨‹åŒæ—¶ç»“æŸï¼Œå¹¶å‘åœ°è°ƒç”¨interruptIdleWorkers()ï¼Œå¯¼è‡´çº¿ç¨‹ç–¯ç‹‚ï¼ˆå¹¶å‘åœ°ï¼‰è¢«interruptï¼Œå¼•å‘interrupt stormï¼›
2. ä¿è¯çŠ¶æ€çš„æ”¹å˜æ˜¯åŸå­çš„ã€‚è¿™æ ·åªè¦æˆ‘è·å–äº†mainLockï¼Œåœ¨æˆ‘é‡Šæ”¾å®ƒä¹‹å‰ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å°±ä¸€å®šä¼šä¿æŒä¸å˜ã€‚å› ä¸ºä»»ä½•äººæƒ³è¦æ”¹å˜çº¿ç¨‹æ± çš„çŠ¶æ€éƒ½è¦å…ˆè·å–mainLockã€‚

å¯ä»¥çœ‹åˆ°ï¼ŒmainLockçš„é™åˆ¶éƒ½æ˜¯åŠ åœ¨æ•´ä¸ªçº¿ç¨‹æ± ä¸Šçš„ï¼Œæ›´å‡†ç¡®çš„æ¥è¯´ï¼Œæ˜¯**workers set**ã€‚å°±åƒæ³¨é‡Šé‡Œè¯´çš„é‚£æ ·ï¼›è€Œæ¯ä¸€ä¸ªworkerå¦‚æœä¹Ÿæ˜¯ä¸ªé”çš„è¯ï¼Œè‡ªç„¶å°±æ˜¯ä¸ºäº†ç»™æ²¡ä¸€ä¸ªworkeræ‰§è¡Œä»»åŠ¡çš„æ—¶å€™åŠ ä¸Šä¸€ç‚¹é™åˆ¶ã€‚ä»æ³¨é‡Šé‡Œä¹Ÿèƒ½çœ‹åˆ°ï¼Œè¿™ä¸ªå®ç°æ˜¯opportunisticallyï¼ŒæŠ•æœºå–å·§åœ°ã€‚æ‰€ä»¥å…¶å®å¯ä»¥ç”¨å…¶å®ƒçš„å®ç°ï¼Œæ¯”å¦‚ç»™æ¯ä¸€ä¸ªworkerå•ç‹¬å®‰æ’ä¸€ä¸ªé”ä¹‹ç±»çš„ã€‚è€Œè¿™é‡Œå› ä¸ºéœ€è¦çš„å¹¶å‘æ§åˆ¶æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æ²¡æœ‰åƒmainLockä¸€æ ·ç”¨ReentrantLockï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†ä¸€ä¸ª**ç®€å•çš„ä¸å¯é‡å…¥çš„äº’æ–¥é”**ã€‚è‡³äºæ›´å…·ä½“çš„åŸå› ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¿›è¡Œæ¢ç©¶ã€‚

æ˜ç¡®ä¸€ç‚¹ï¼ŒWorkerè¿™ä¸ªé”æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼š

```java
// The value 0 represents the unlocked state.  
// The value 1 represents the locked state.
```

workeré‡Œé™¤äº†AQSç›¸å…³çš„å®ç°ï¼Œå°±æ˜¯ä¸€ä¸ªrunæ–¹æ³•ã€‚å½“ç„¶ä¹Ÿå°±æ˜¯æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•ã€‚æ¥ä¸‹ä¿©æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿è¡Œçš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆã€‚è¿™ä¸ªrunæ–¹æ³•å°†ä»»åŠ¡è¿è¡Œå§”æ‰˜ç»™äº†çº¿ç¨‹æ± ï¼š

```java
/** Delegates main run loop to outer runWorker. */
public void run() {
	runWorker(this);
}
```

æ‰€ä»¥å®é™…è¿˜æ˜¯è¦çœ‹runWorkerçš„å®ç°ã€‚

æ—¢ç„¶è¦è¿è¡Œä»»åŠ¡ã€‚é¦–å…ˆæœ€é‡è¦çš„ç›®çš„å°±æ˜¯è¦çŸ¥é“ä»»åŠ¡æ˜¯å•¥ã€‚ä»»åŠ¡ä¸»è¦æ¥æºäºä¸¤æ–¹é¢ï¼š

1. workeråˆ›å»ºæ—¶åˆ†é…çš„firstTaskï¼›
2. workerä¸»åŠ¨è·å–çš„taskï¼Œé€šè¿‡getTask()æ–¹æ³•ã€‚

> [!note] getTask()
> `getTask()`æ–¹æ³•è¿”å›å€¼æœ‰ä¸¤ç§ã€‚è¦ä¹ˆæ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œä»£è¡¨æˆåŠŸè·å–åˆ°äº†ä»»åŠ¡ï¼›è¦ä¹ˆæ˜¯nullï¼Œä»£è¡¨æ²¡è·å–åˆ°ï¼Œæ„å‘³ç€è·å–è¿™ä¸ªä»»åŠ¡çš„çº¿ç¨‹è¦é€€å‡ºäº†ã€‚

ç¬¬ä¸€ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹ç¬¬äºŒä¸ªã€‚å½“çº¿ç¨‹æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œç´§æ¥ç€å°±æ˜¯è¦ç»§ç»­è·å–ä»»åŠ¡æ¥æ‰§è¡Œï¼Œè‡ªç„¶ä¹Ÿåªèƒ½é€šè¿‡ä»»åŠ¡é˜Ÿåˆ—ã€‚æˆ‘ä»¬åœ¨åˆ†æexecuteçš„æ—¶å€™ä¹Ÿè¯´è¿‡ï¼Œä»»åŠ¡é˜Ÿåˆ—å°±æ˜¯è¿™ä¸ªworkQueueã€‚åªæœ‰executeè¿™ä¸€ä¸ªæ–¹æ³•é‡Œä¼šå°†ä»»åŠ¡å…¥é˜Ÿï¼›åŒæ ·ä¹Ÿåªæœ‰getTaskè¿™ä¸€ä¸ªæ–¹æ³•ä¼šå°†ä»»åŠ¡å‡ºé˜Ÿã€‚

è·å–ä»»åŠ¡ï¼Œå½“ç„¶ä¹Ÿè¦æ˜¯åˆé€‚çš„æ—¶æœºæ‰è¡Œã€‚å¦‚æœæˆ‘ä»¬æŠŠçº¿ç¨‹æ± å…³äº†ï¼Œé‚£ä¹ˆå†è·å–ä»»åŠ¡æ‰§è¡Œä¹Ÿæ²¡æ„ä¹‰äº†ã€‚æ‰€ä»¥æˆ‘ä»¬ä¹Ÿèƒ½åœ¨getTaské‡Œçœ‹åˆ°å’ŒaddWorkerä¸­[[#^29b849|ç±»ä¼¼]]çš„åœºæ™¯ï¼š

```java
// Check if queue empty only if necessary.
if (runStateAtLeast(c, SHUTDOWN)
	&& (runStateAtLeast(c, STOP) || workQueue.isEmpty())) {
	decrementWorkerCount();
	return null;
}
```

åŒæ ·æ˜¯ï¼š

1. çº¿ç¨‹æ± å·²ç»å¤„äºSTOPçŠ¶æ€ï¼›
2. çº¿ç¨‹æ± å¤„äºSHUTDOWNçŠ¶æ€ï¼Œå¹¶ä¸”é˜Ÿåˆ—æ˜¯ç©ºçš„ã€‚

è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šç›´æ¥è¿”å›nullï¼Œå› ä¸ºå·²ç»ä¸éœ€è¦å†è·å–ä»»åŠ¡äº†ã€‚ä½†æ˜¯åœ¨è¿”å›ä»»åŠ¡ä¹‹å‰ï¼Œéœ€è¦å‡å°‘ä¸€ä¸‹çº¿ç¨‹æ•°ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œçš„å‡å°‘çº¿ç¨‹æ•°ä¸æ˜¯ç”¨CASï¼Œæ˜¯ç›´æ¥å‡å°‘ã€‚æ¯•ç«Ÿæ˜¯å…³é—­çº¿ç¨‹æ± ï¼Œæ‰€ä»¥ç›´æ¥å‡å°‘ä¹Ÿæ²¡å•¥ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦è¡¥å……ä¸€ç‚¹ï¼Œè™½ç„¶æ˜¯ç›´æ¥å‡å°‘ï¼Œä½†æ˜¯ç”±äºæ˜¯AtomicIntegerï¼Œæ‰€ä»¥è¿˜æ˜¯å…·æœ‰åŸå­æ€§çš„ï¼š

```java
/**
 * Decrements the workerCount field of ctl. This is called only on
 * abrupt termination of a thread (see processWorkerExit). Other
 * decrements are performed within getTask.
 */
private void decrementWorkerCount() {
	ctl.addAndGet(-1);
}
```

è¿™é‡Œçš„â€œç›´æ¥å‡å°‘â€å¼ºè°ƒçš„å…¶å®æ˜¯ï¼š**æˆ‘ä»¬ä¸å…³å¿ƒå‡å»å½“å‰çº¿ç¨‹ä¹‹åï¼Œè¿˜å‰©ä¸‹å¤šå°‘ä¸ªçº¿ç¨‹**ã€‚é©¬ä¸Šæˆ‘ä»¬å°±ä¼šçœ‹åˆ°ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™ä¹Ÿå…³å¿ƒå‡æ‰ä¹‹ååˆ°åº•è¿˜å‰©å‡ ä¸ªçº¿ç¨‹ã€‚è€Œå¦‚ä½•å®ç°â€œå…³å¿ƒâ€å‘¢ï¼Ÿå½“ç„¶å°±æ˜¯CASå•¦ã€‚

è¿˜æœ‰ä¸€ä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹ä¸ä¼šç»§ç»­å–ä»»åŠ¡ï¼Œä¼šé€€å‡ºã€‚é‚£å°±æ˜¯è¦çœ‹çœ‹çº¿ç¨‹æ± ä¸­å½“å‰çº¿ç¨‹æ± çš„ä¸ªæ•°ï¼Œæ˜¯å¦å·²ç»è¿‡äº†ã€‚

æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ï¼Œæ·»åŠ workeræ—¶ï¼Œè¿™ä¸ªworkeræ˜¯æ ¸å¿ƒè¿˜æ˜¯éæ ¸å¿ƒï¼Œå…¶å®å°±æ˜¯è®¾ç½®ä¸€ä¸ªupper boundã€‚å¦‚æœæ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œé‚£ä¹ˆupper boundå°±æ˜¯corePoolSizeï¼›å¦‚æœæ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œé‚£å°±æ˜¯maximumPoolSizeã€‚

è€Œåœ¨getTask()ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æƒ…å†µã€‚å½“ä¸€ä¸ªçº¿ç¨‹å› ä¸ºé•¿æ—¶é—´è·å–ä¸åˆ°ä»»åŠ¡ï¼ˆè¿™ä¸ªä¹‹åä¼šè®²ï¼‰ï¼Œä»è€Œè¶…æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹å°±åº”è¯¥ç»“æŸäº†ã€‚é‚£ä¹ˆå½“å‰çº¿ç¨‹æ˜¯å¦è¦ç»“æŸï¼Œæœ‰å¦‚ä¸‹åˆ¤æ–­ï¼š

- çœ‹çº¿ç¨‹æ± çš„é…ç½®ä¸­ï¼Œæ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼ˆallowCoreThreadTimeOutï¼‰ï¼›
- çœ‹å½“å‰çš„çº¿ç¨‹æ•°æ˜¯å¦å·²ç»è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚

è¿™ä¸¤ä¸ªæƒ…å†µä¸­ä»»æ„ä¸€ä¸ªæ»¡è¶³ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚ä½ å¯èƒ½æ„Ÿè§‰æ¯”è¾ƒç»•ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ã€‚ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒå“ªå‡ ä¸ªçº¿ç¨‹æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œåªå…³å¿ƒæœ‰å‡ ä¸ªçº¿ç¨‹æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚çº¿ç¨‹æ± å¯¹å¾…ä»»æ„ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½æ˜¯ä¸€è§†åŒä»ã€‚æ‰€ä»¥ï¼Œå¯¹äºæ‰§è¡Œåˆ°è¿™é‡Œçš„çº¿ç¨‹ï¼Œå®ƒæ˜¯å¦åº”è¯¥é€€å‡ºï¼Œä¸æ˜¯çœ‹å®ƒæ˜¯ä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼ˆå½“ç„¶ä¹Ÿçœ‹ä¸åˆ°ï¼Œæ ¹æœ¬æ²¡è¿™æ ‡è®°ä½ï¼‰ï¼Œè€Œæ˜¯çœ‹å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°æ˜¯å¦è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹ã€‚å¦‚æœå·²ç»è¶…è¿‡äº†ï¼Œé‚£æ¯«æ— ç–‘é—®æˆ‘å°±åº”è¯¥é€€å‡ºäº†ï¼›è€Œå¦‚æœæ²¡è¶…è¿‡ï¼Œé‚£å°±ä»£è¡¨**å½“å‰çº¿ç¨‹æ± é‡Œè¿˜å‰©ä¸‹çš„çº¿ç¨‹å…¶å®éƒ½æ˜¯æ ¸å¿ƒçº¿ç¨‹**ã€‚è¿™ä¸ªæ—¶å€™æˆ‘åº”è¯¥é€€å‡ºå—ï¼Ÿé‚£å½“ç„¶å°±æ˜¯çœ‹çº¿ç¨‹æ± çš„é…ç½®é‡Œæ˜¯ä¸æ˜¯å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶äº†ã€‚

> [!note]- æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦å…è®¸è¶…æ—¶
> å­˜å‚¨åœ¨æ ‡è®°ä½`allowCoreThreadTimeOut`ä¸­ï¼š
> 
> 
> ~~~java
> /**
>  * If false (default), core threads stay alive even when idle.
>  * If true, core threads use keepAliveTime to time out waiting
>  * for work.
>  */
> private volatile boolean allowCoreThreadTimeOut;
> ~~~
> 
> è¿™ä¸ªæ ‡è®°ä½é€šè¿‡allowCoreThreadTimeout()æ–¹æ³•è®¾ç½®ã€‚å¦‚æœè®¾ç½®ä¸ºäº†trueï¼Œé‚£ä¹ˆå°±ä¼šç«‹åˆ»è°ƒç”¨interruptIdleWorkers()ï¼Œæ¥ä¸­æ–­æ‰€æœ‰å·²ç»ä¼‘çœ çš„çº¿ç¨‹ã€‚å› ä¸ºå¦‚æœè¿™äº›ä¼‘çœ çš„æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œé‚£ä½ ä»¬ä¹Ÿè¯¥æ­»å•¦ã€‚

ä»¥ä¸Šé€»è¾‘çš„ä»£ç ï¼š

```java
int wc = workerCountOf(c);
// Are workers subject to culling?
boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;
```

å¦‚æœtimedä¸ºtrueå°±è¡¨ç¤ºï¼šå½“å‰çº¿ç¨‹æ‰§è¡ŒgetTask()æ—¶ï¼Œæ‰§è¡Œåˆ°è¿™é‡Œï¼Œé€šè¿‡çœ‹æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶çš„é…ç½®ï¼Œå’Œå½“å‰çº¿ç¨‹çš„æ•°é‡ä¹‹åï¼Œè¯„ä¼°å‡ºäº†ä¸€ä¸ªç»“è®ºï¼šæˆ‘è¯¥æ­»å•¦ï¼

å½“ç„¶ï¼Œè¿™ä¸¤ç§æƒ…å†µï¼Œåªæ˜¯å½“å‰çº¿ç¨‹è®¤ä¸ºå®ƒè¯¥æ­»äº†ã€‚å…¶å®è¿˜æœ‰ä¸€ç§æƒ…å†µæˆ‘ä»¬æ²¡æœ‰è€ƒè™‘åˆ°ï¼Œå°±æ˜¯å½“å‰çº¿ç¨‹çš„ä¸ªæ•°å·²ç»è¶…è¿‡äº†æœ€å¤§çº¿ç¨‹æ•°ã€‚é‚£è¿™ä¸ªå°±ä¸æ˜¯ä½ è‡ªå·±çš„é—®é¢˜äº†ï¼Œæ˜¯çº¿ç¨‹æ± éƒ½å‡ºäº†é—®é¢˜ã€‚æ‰€ä»¥è‡ªç„¶è¦ç®—åœ¨é‡Œé¢ã€‚

é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆåœ¨ä»£ç é‡Œï¼Œæ²¡æœ‰å°†`wc > maximumPoolSize`è¿™ç§æƒ…å†µå¹¶å…¥åˆ°`timed`é‡Œé¢å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å› ä¸ºï¼Œå³ä½¿`timed == true`ï¼Œè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¸æ˜¯å®Œå…¨éœ€è¦é€€å‡ºï¼Œè€Œ`wc > maximunPoolSize`çš„æƒ…å†µä¸‹ï¼Œå½“å‰çº¿ç¨‹å¿…é¡»è¦é€€å‡ºï¼Œå› ä¸ºè¿™å·²ç»å±äºé”™è¯¯äº†ã€‚

é‚£ä¹ˆï¼Œ`timed == true`çš„æƒ…å†µä¸‹ï¼Œè¿˜éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ‰èƒ½é€€å‡ºå‘¢ï¼Ÿçœ‹ä»£ç å°±çŸ¥é“äº†ï¼Œå°±æ˜¯`timedOut`å˜é‡ã€‚è¿™ä¸ªå˜é‡æˆ‘ä»¬è¿˜æ²¡æ¥è§¦åˆ°ï¼Œä¸è¿‡å¯ä»¥å…ˆè¯´ä¸€ä¸‹ï¼Œå®ƒä»£è¡¨ç€**å½“å‰çº¿ç¨‹æ›¾ç»è¯•å›¾ä»workQueueä¸­å–ä»»åŠ¡ï¼Œä¸€ç›´æ²¡å–åˆ°ï¼Œç„¶åå°±åœ¨é‚£å„¿ç­‰ï¼Œç­‰è¶…æ—¶äº†éƒ½**ã€‚å› æ­¤ï¼Œå¦‚æœæ˜¯æ­£å¸¸çš„åœ¨çº¿ç¨‹æ± ä¸­â€œç”Ÿæ´»å·¥ä½œâ€çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒç»“æŸè‡ªå·±çš„å‰ææ¡ä»¶è¦æ˜¯â€œæ²¡æ´»å„¿å¹²â€ã€‚åé¢çš„æ¡ä»¶æ‰æ˜¯æ˜¯å¦æ ¸å¿ƒçº¿ç¨‹ã€‚

æ»¡è¶³ä»¥ä¸Šçš„æ‰€æœ‰æ¡ä»¶ï¼Œçº¿ç¨‹å°±èƒ½é€€å‡ºäº†å—ï¼Ÿå¥½åƒä¸æ˜¯ã€‚å› ä¸ºæˆ‘ä»¬åªè®¨è®ºäº†çº¿ç¨‹æœ¬èº«ï¼Œè¿˜æ²¡æœ‰è®¨è®ºä»»åŠ¡ã€‚åªæœ‰èƒ½è®©çº¿ç¨‹æ± åœ¨ç§»é™¤å½“å‰çº¿ç¨‹åè¿˜èƒ½åˆç†åœ°å®Œæˆä»»åŠ¡ï¼Œæ‰ä¼šå…è®¸å½“å‰çº¿ç¨‹é€€å‡ºã€‚

é¦–å…ˆï¼Œå°±æ˜¯çº¿ç¨‹æ± çš„ä¸ªæ•°å¤§äº1ã€‚å¦‚æœä¸æ»¡è¶³çš„è¯ï¼Œå…¶å®åªæœ‰è¿™ä¸€ç§æƒ…å†µï¼šçº¿ç¨‹æ± å†…ï¼Œå°±åªå‰©æˆ‘è¿™ä¸€ä¸ªæ´»ç€çš„çº¿ç¨‹äº†ã€‚é‚£1-0=0ï¼Œæ²¡äº†æˆ‘ï¼Œçº¿ç¨‹æ± å°±ç©ºäº†ã€‚é‚£è¿™æ´»å„¿è°å¹²ï¼Ÿæ‰€ä»¥ï¼Œå…è®¸å½“å‰çº¿ç¨‹é€€å‡ºçš„ï¼Œå’Œä»»åŠ¡ç›¸å…³çš„æ¡ä»¶æ˜¯ï¼š

è¦ä¹ˆçº¿ç¨‹ä¸ªæ•°å¤§äº1ï¼ˆè¿˜æœ‰äººèƒ½å¹²æ´»å„¿ï¼‰ï¼Œè¦ä¹ˆä»»åŠ¡é˜Ÿåˆ—å·²ç»ç©ºäº†ï¼ˆçœŸæ²¡æ´»å„¿å¹²äº†ï¼‰ã€‚

æœ€åæ€»ç»“ä¸€ä¸‹æ€»ä½“çš„æ¡ä»¶ï¼š

1. çº¿ç¨‹è®¤ä¸ºè‡ªå·±åº”è¯¥é€€å‡ºäº†ï¼Œæˆ–è€…çº¿ç¨‹æ± å‘ç°çº¿ç¨‹æ•°é‡å‡ºç°äº†é”™è¯¯ï¼Œè¶…è¿‡äº†æœ€å¤§é™åˆ¶ï¼›
2. ä¿è¯çº¿ç¨‹é€€å‡ºåï¼Œçº¿ç¨‹æ± è¿˜èƒ½æ­£å¸¸å·¥ä½œã€‚

ä¸¤ä¸ªæ¡ä»¶è¦éƒ½æ»¡è¶³ï¼Œæ‰èƒ½æœ€ç»ˆè®©è¿™ä¸ªçº¿ç¨‹é€€å‡ºï¼š

```java
if (
	(wc > maximumPoolSize || (timed && timedOut)) 
	&& (wc > 1 || workQueue.isEmpty())
) {
	if (compareAndDecrementWorkerCount(c))
		return null;
	continue;
}
```

çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘å€’å¸äº†ä¸€å£å†·æ°”ï¼šä¸ºå•¥æ˜¯CASï¼Ÿéš¾é“è¿˜æœ‰çŒ«è…»ï¼Ÿå¥½åœ¨åˆšåˆšæˆ‘ä»¬å·²ç»æ‰“è¿‡é¢„é˜²é’ˆäº†ã€‚è¿™é‡Œç”¨CASçš„æ ¹æœ¬åŸå› å°±æ˜¯ï¼Œæˆ‘ä»¬å…³å¿ƒç§»é™¤å½“å‰çº¿ç¨‹ä¹‹åçš„ç»“æœã€‚

æˆ‘ä»¬ä»ä¸šåŠ¡æ–¹çš„è§†è§’æ€è€ƒï¼šåœ¨æˆ‘æ²¡è®¾ç½®allowCoreThreadTimeoutçš„æƒ…å†µä¸‹ï¼Œæˆ‘è®¤ä¸ºçº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒçº¿ç¨‹åº”è¯¥æ˜¯æ°¸è¿œä¸ä¼šé€€å‡ºçš„ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœæ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯4ï¼Œåªè¦æˆ‘æ·»åŠ äº†è¶…è¿‡4ä¸ªçº¿ç¨‹ï¼Œä¹‹åçº¿ç¨‹æ•°å°±æ°¸è¿œä¹Ÿä¸ä¼šå°äº4äº†ã€‚

æˆ‘æŠŠè¿™éƒ¨åˆ†ä»£ç è´´å‡ºæ¥ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹ä¸€ä¸ªä¾‹å­ï¼š

```java
int wc = workerCountOf(c);                                     // 1

// Are workers subject to culling?
boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;   // 2

if ((wc > maximumPoolSize || (timed && timedOut))              // 3
	&& (wc > 1 || workQueue.isEmpty())) {
	if (compareAndDecrementWorkerCount(c))                     // 4
		return null;                                           // 5
	continue;                                                  // 6
}
```

è¿˜æ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯4ã€‚å‡è®¾ç°åœ¨å®é™…ä¸Šæœ‰5ä¸ªçº¿ç¨‹ï¼Œç„¶åæœ‰ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘åœ°æ‰§è¡Œåˆ°äº†getTask()ï¼Œç„¶åéƒ½æ²¡å–åˆ°ä»»åŠ¡è¶…æ—¶äº†ï¼ˆtimedOutä¸ºtrueï¼‰ï¼Œç„¶ååˆåŒæ—¶æ‰§è¡Œåˆ°äº†1ã€‚

é‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹å¾—åˆ°çš„`wc`å°±éƒ½æ˜¯5ã€‚

å‡è®¾allowCoreThreadTimeoutæ˜¯falseï¼Œé‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šåˆ¤æ–­`wc > corePoolsize`æ˜¯trueï¼ˆ5 > 4ï¼‰ã€‚æ‰€ä»¥ä¸¤ä¸ªçº¿ç¨‹éƒ½è®¤ä¸ºè‡ªå·±æ˜¯é‚£ä¸ªå¤šä½™çš„çº¿ç¨‹ï¼Œåº”è¯¥é€€å‡ºäº†ã€‚

ç„¶åï¼Œä¸¤ä¸ªçº¿ç¨‹åœ¨3çš„åˆ¤æ–­ä¸­ï¼Œ`timed && timedOut`çš„ç»“æœéƒ½æ˜¯trueï¼Œå¹¶ä¸”æ­¤æ—¶çš„`wc > 1`æ˜¯æ’æˆç«‹çš„ã€‚

ç„¶åä¸¤ä¸ªçº¿ç¨‹å°±ä¼šå¹¶å‘åœ°æ‰§è¡Œåˆ°4ã€‚è€Œå¦‚æœ4è¿™ä¸ªä½ç½®ä¸æ˜¯CASï¼Œè€Œæ˜¯æ™®é€šçš„AtomicIntegerçš„å‡å°‘ï¼Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿé‚£å½“ç„¶å°±æ˜¯çº¿ç¨‹æ•°ä¼šä»5å˜æˆ3ã€‚ç„¶åä¸¤ä¸ªçº¿ç¨‹å°±éƒ½æˆåŠŸé€€å‡ºäº†ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹‹å‰é‚£ä¹ˆè´¹åŠ²å·´æ‹‰åˆ°åº•æ˜¯ä¸ºå•¥ï¼Ÿé‚£ä¸ªallowCoreThreadTimeoutï¼Œè¿˜æ¯”ä»€ä¹ˆæ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºäº†å•¥ï¼Ÿä¸å°±æ˜¯ä¸ºäº†ï¼šä¿ä½æ ¸å¿ƒçº¿ç¨‹ï¼Œä¸è¦è®©ä»–é€€å‡ºå—ï¼Ÿ

æ‰€ä»¥ï¼Œè¿™é‡Œçš„ä¸€ä¸ªå¹¶å‘çš„å°bugï¼Œå°±ä¼šå¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¤ä¸ºè‡ªå·±æ˜¯è¯¥æ­»çš„é‚£ä¸ªï¼Œæˆ‘æ­»äº†ï¼Œå‰©ä¸‹çš„å°±éƒ½æ˜¯æ ¸å¿ƒçº¿ç¨‹äº†ã€‚ç„¶è€Œæ®Šä¸çŸ¥ï¼Œä½ ä¿©è¦çœŸéƒ½æ­»äº†ï¼Œæ ¸å¿ƒçº¿ç¨‹åè€Œå°‘äº†ä¸€ä¸ªã€‚

è¿™å°±æ˜¯ç”¨CASçš„åŸå› ï¼šæˆ‘å…³å¿ƒå½“å‰çº¿ç¨‹é€€å‡ºåï¼Œè¿˜å‰©ä¸‹å¤šå°‘ä¸ªçº¿ç¨‹ã€‚è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡çš„CASçš„ç‰¹ç‚¹å—ï¼Ÿ[[Study Log/java_kotlin_study/concurrency_art/5_4_read_write_lock#^fba60d|æœ‰äººå¤±è´¥ï¼Œå°±ä¸€å®šæœ‰äººæˆåŠŸ]]ã€‚å› æ­¤ï¼Œè¿™é‡Œç”¨äº†å•ç‹¬çš„ä¸€æ¬¡CASï¼Œä¿è¯çš„æ˜¯ï¼šæœ‰å¤šä¸ªçº¿ç¨‹å¹¶å‘åœ°æƒ³è¦é€€å‡ºæ—¶ï¼Œä¿è¯æœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹æœ€ç»ˆèƒ½å¤ŸæˆåŠŸé€€å‡ºã€‚å› ä¸ºé€€å‡ºä¹‹åä¿®æ”¹äº†çº¿ç¨‹æ•°ï¼Œå…¶ä»–æƒ³è¦é€€å‡ºçš„çº¿ç¨‹çš„CASå°±ä¼šå¤±è´¥ï¼Œå¤±è´¥ä¹‹åå°±è¦ç”¨æ–°çš„çŠ¶æ€é‡æ–°æ¥ä¸€éã€‚

å¥½äº†ï¼Œç»ˆäºå¼€å§‹å–ä»»åŠ¡äº†ï¼workQueueæ˜¯ä¸€ä¸ªBlockingQueueï¼Œæˆ‘ä»¬å–ä»»åŠ¡ä¸»è¦ç”¨çš„æ˜¯ä¸¤ç§æ–¹æ³•ï¼š

```java
E poll(long timeout, TimeUnit unit) // å¦‚æœè¶…æ—¶äº†ï¼Œå°±ä¼šè¿”å›
E take()                            // ä¸å–åˆ°ï¼Œæˆ‘å°±ä¸€ç›´ç­‰
```

ä»€ä¹ˆæ—¶å€™ç”¨ä¸€ç›´ç­‰çš„æ–¹æ³•ï¼Ÿæ˜¾ç„¶ï¼Œå¿…é¡»è¦æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œå¹¶ä¸”allowCoreThreadTimeoutè¦æ˜¯falseã€‚å…¶å®ƒçš„æ—¶å€™éƒ½ç”¨è¶…æ—¶çš„è¿™ç§ã€‚é‚£ä¹ˆæ€ä¹ˆåŒºåˆ†ä¸¤ç§æƒ…å†µå‘¢ï¼Ÿå¥½åƒ`timed`å˜é‡å°±æ˜¯å‘€ï¼å¦‚æœ`timed == false`ï¼Œé‚£ä¹ˆallowCoreThreadTimeoutè¦æ˜¯falseï¼ŒåŒæ—¶`wc <= corePoolSize`ï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚ä¸€åˆ‡éƒ½æ˜¯é‚£ä¹ˆå·§åˆã€‚ã€‚ã€‚

```java
Runnable r = timed ?
		workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
		workQueue.take();
```

å¦‚æœè¿™ä¸ªçº¿ç¨‹è¿˜èƒ½å¾€ä¸‹èµ°ï¼Œåªæœ‰ä¸¤ç§æƒ…å†µï¼š

1. æˆåŠŸå–å‡ºäº†ä¸€ä¸ªä»»åŠ¡ï¼›
2. è¶…æ—¶äº†ã€‚

æ‰€ä»¥ï¼Œå‰©ä¸‹çš„å°±å¥½è¯´äº†ã€‚æˆ‘å°±ç›´æ¥è´´å…¨éƒ¨çš„ä»£ç äº†ã€‚ç°åœ¨getTask()çš„æ¯ä¸€è¡Œä»£ç ä½ éƒ½åº”è¯¥çŸ¥é“æ˜¯æ€ä¹ˆå›äº‹äº†ï¼ˆé™¤äº†æœ€åå¼‚å¸¸çš„å¤„ç†ï¼‰ï¼š

```java
private Runnable getTask() {
	boolean timedOut = false; // Did the last poll() time out?

	for (;;) {
		int c = ctl.get();

		// Check if queue empty only if necessary.
		if (runStateAtLeast(c, SHUTDOWN)
			&& (runStateAtLeast(c, STOP) || workQueue.isEmpty())) {
			decrementWorkerCount();
			return null;
		}

		int wc = workerCountOf(c);

		// Are workers subject to culling?
		boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;

		if ((wc > maximumPoolSize || (timed && timedOut))
			&& (wc > 1 || workQueue.isEmpty())) {
			if (compareAndDecrementWorkerCount(c))
				return null;
			continue;
		}

		try {
			Runnable r = timed ?
				workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
				workQueue.take();
			if (r != null)
				return r;
			timedOut = true;
		} catch (InterruptedException retry) {
			timedOut = false;
		}
	}
}
```

- [ ] #TODO tasktodo1725805658470 æœ€åçš„å¼‚å¸¸å¤„ç†æ˜¯ä¸ºäº†åº”å¯¹çº¿ç¨‹åœ¨ç­‰å¾…ä»»åŠ¡çš„æ—¶å€™è¢«ä¸­æ–­ã€‚å¯ä»¥çœ‹åˆ°getTask()çš„è°ƒç”¨è€…â€”â€”runWorker()æ–¹æ³•åœ¨ä¸€å¼€å§‹å°±æ‰§è¡Œäº†w.unlock()ï¼Œæ—è¾¹ä¸€å¥æ³¨é‡Šallow interruptsã€‚é‚£ä¹ˆè¿™é‡Œä¸ºå•¥è¦å…è®¸åˆ«äººä¸­æ–­å®ƒå‘¢ï¼Ÿ â• 2024-09-08 â« ğŸ†” lbku3q 
- [ ] #TODO tasktodo1725805757050 è¿™é‡Œåªæœ‰forå¾ªç¯ä¸€å¼€å§‹è¿›è¡Œäº†çº¿ç¨‹æ± çŠ¶åˆ¤æ–­ã€‚é‚£å¦‚æœåˆšæ£€æŸ¥å®ŒçŠ¶æ€ï¼Œç”šè‡³æ˜¯å·²ç»è·å–åˆ°äº†ä»»åŠ¡çš„æ—¶å€™ï¼Œæœ‰äººæŠŠçº¿ç¨‹æ± å…³äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ â• 2024-09-08 â« ğŸ†” 7lpbsb 






---

```dataviewjs
const pages = dv.pages('"Study Log/java_kotlin_study/concurrency_art"')
let nextChapterHead = undefined
let res = undefined
const current = dv.current()
for (let page of pages) {
	if (page.chapter_root == true && page.order == Number(current.chapter) + 1) {
		console.log("found next head: " + page.name)
		nextChapterHead = page
		continue
	}
	if (page.chapter == undefined || page.chapter != current.chapter) {
		console.log("not current chapter: " + page.file.name)
		continue
	}
	if (page.order == Number(current.order) + 1) {
		res = page
	}
}
console.log("res: " + res)
console.log("next: " + nextChapterHead)
if (res == undefined) {
	res = nextChapterHead
}
let text = ""
if (res != undefined) {
	const path = res.file.path
	const title = res.title
	const decoLink = "[[" + path + "|" + title + "]]"
	text = "Next Article: " + decoLink
} else {
	text = "æ—…é€”çš„ç»ˆç‚¹ï¼"
}
dv.el("p", text, { attr: { align: "right" } })
```