---
title: Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†
order: "2"
chapter: "2"
chapter_root: true
---
## 2 Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†

åœ¨å†™Javaå•ä¾‹æ¨¡å¼æ—¶ï¼Œæœ‰ä¸€ç§éå¸¸ç»å…¸çš„å†™æ³•ï¼Œå«åš[Double Check](https://www.cnblogs.com/leozmm/p/java_singleton_double_check.html)ï¼š

```java
class Singleton {
    private static volatile Singleton INSTANCE = null;  // <-- ç¦æ­¢æŒ‡ä»¤é‡æ’åº
    private Singleton() {}

    public static getInstance() {
        if (null == INSTANCE) {                  // <-- ç¬¬1æ¬¡ï¼Œä¸€èˆ¬æ€§æ£€æŸ¥ï¼Œä½†æ˜¯æœ‰å¹¶å‘éšæ‚£ï¼šå¯èƒ½æœ‰å¤šæ‰§è¡ŒæµåŒæ—¶è¿›å…¥æ”¹å¤„
            synchronized(Singleton.class) {
                if (null == INSTANCE) {          // <-- æ­¤å¤„ç¬¬2æ¬¡æ£€æŸ¥ï¼Œä¸ºäº†é˜²æ­¢åç»­å¤šæ‰§è¡Œæµå¹¶å‘æ—¶ï¼Œåç»­è·å–åŒæ­¥é”çš„æ‰§è¡Œæµï¼Œä¸ä¼šå†æ¬¡åˆå§‹åŒ–Singletonå¯¹è±¡
                    INSTANCE = new Singleton();
                }
            }
        }
        return INSTANCE;
    }
}
```

è¿™é‡Œé¢çš„INSTANCEå®ä¾‹å°±æ˜¯volatileçš„ã€‚é‚£ä¹ˆå®ƒæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸ºä»€ä¹ˆDouble Checkè¦è¿™ä¹ˆå†™å‘¢ï¼Ÿåœ¨æœ¬ä¹¦ä¸­æˆ‘ä»¬å¯¹è¿™ä¸ªé—®é¢˜æ¥ä¸€ä¸ªç»ˆæç‰ˆçš„è®²è§£ã€‚åŒæ—¶ï¼Œè¿™ç¯‡æ–‡ç« ï¼š[volatileå’Œsynchronizedåˆ°åº•å•¥åŒºåˆ«ï¼Ÿå¤šå›¾æ–‡è®²è§£å‘Šè¯‰ä½  - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/111229417)ä¸­çš„å†…å­˜æ¨¡å‹ï¼Œä¹Ÿåœ¨æœ¬ç« ä¸­æœ‰å¾ˆå¤§çš„ä½œç”¨ã€‚

- [ ] #TODO åˆ«å¿˜äº†Double Check â«

[å•ä¾‹è®¾è®¡æ¨¡å¼-Double Check - é˜¿å®339 - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/DFX339/p/12531008.html#:~:text=%E5%8D%95%E4%BE%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Double%20Check,%E5%8D%95%E4%BE%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%BB%E8%A6%81%E6%98%AF%E4%B8%BA%E4%BA%86%E4%BF%9D%E8%AF%81%E5%8F%AA%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%85%B6%E4%BD%99%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E5%A4%8D%E7%94%A8%E7%9A%84%E8%AF%9D%E5%B0%B1%E7%9B%B4%E6%8E%A5%E5%BC%95%E7%94%A8%E9%82%A3%E4%B8%AA%E5%AF%B9%E8%B1%A1%E5%8D%B3%E5%8F%AF%E3%80%82%20%E7%AE%80%E5%8D%95%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%9C%A8%E6%95%B4%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E4%BF%9D%E8%AF%81%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%AD%98%E5%9C%A8%E3%80%82)

### 2.1 volatile

[ä¸ºä»€ä¹ˆvolatileèƒ½ä¿è¯å¯è§æ€§ï¼Ÿ_volitileä¸ºä»€ä¹ˆåªèƒ½ä¿è¯å¯è§æ€§-CSDNåšå®¢](https://blog.csdn.net/m0_37892106/article/details/97050278)

é¦–å…ˆï¼Œè¦å›æƒ³èµ·ä¹‹å‰è®²è¿‡çš„CPUä¸‰çº§ç¼“å­˜ã€‚å› ä¸ºå†…å­˜å®åœ¨æ˜¯å¤ªæ…¢äº†ï¼Œæ‰€ä»¥åœ¨CPUä¸ŠæŒ‚äº†ä¸‰ä¸ªç›¸æ¯”äºå†…å­˜è¦å¿«å¾—å¤šçš„ç¼“å­˜ï¼šL1ã€L2å’ŒL3ã€‚å½“æˆ‘ä»¬è¦ä»å†…å­˜ä¸­è¯»æ•°æ®æ—¶ï¼Œä¼šä¾æ¬¡ç»è¿‡è¿™äº›ç¼“å­˜ï¼Œå¹¶ç•™åœ¨é‡Œé¢ã€‚å¦‚æœä¸‹æ¬¡åˆè¦è¯»çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆä»è¿™äº›ç¼“å­˜ä¸­å»æ‹¿æ•°æ®ï¼Œæ¯”ä»å†…å­˜ä¸­æ‹¿è¦å¿«å¾—å¤šã€‚

ç„¶è€Œï¼Œä¸€æ—¦CPUå˜æˆäº†å¤šçº¿ç¨‹ï¼Œä¼šæ€æ ·ï¼Ÿæœ‰å¯èƒ½ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼**è¿˜æ²¡æ¥å¾—åŠä¿®æ”¹åˆ°å…¶å®ƒçº¿ç¨‹å¯¹æ¥çš„ç¼“å­˜ä¸­**ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹åˆè¦è¯»è¿™ä¸ªå€¼ï¼Œå²‚ä¸æ˜¯è¯»åˆ°çš„å°±å˜æˆäº†æ—§çš„å€¼äº†ï¼Ÿå› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ‰‹æ®µï¼Œ**æ¥é€šçŸ¥å…¶å®ƒçº¿ç¨‹â€œå¯¹äºè¿™ä¸ªå€¼çš„ä¿®æ”¹æ“ä½œå·²ç»å‘ç”Ÿâ€**ã€‚

è€Œvolatileçš„æœ¬è´¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è½¬æ¢æˆæ±‡ç¼–æ¥çœ‹ã€‚ä¸€ä¸ªåŠ äº†volatileçš„æŒ‡ä»¤ï¼Œåœ¨èµ‹å€¼çš„æ—¶å€™æ˜¯è¿™æ ·çš„ã€‚å¦‚æœä¸‹é¢çš„INSTANCEæ˜¯ä¸€ä¸ªvolatileçš„å˜é‡ï¼š

```java
INSTANCE = new Singleton();
```

é‚£ä¹ˆå°†ä»–è½¬æ¢æˆæ±‡ç¼–ä¹‹åå°±æ˜¯è¿™æ ·çš„ï¼š

```asm
0x01a3de1d: movb $0x0,0x1104800(%esi);
0x01a3de24: lock addl $0x0,(%esp);
```

å¯¹æœ‰volatileçš„å˜é‡è¿›è¡Œ**å†™æ“ä½œ**æ—¶ï¼Œå°±ä¼šå¤šå‡ºç¬¬äºŒè¡Œä»£ç ã€‚è€Œè¿™ä¸ªlockæŒ‡ä»¤æ ¹æ®IA-32çš„æŒ‡ä»¤æ‰‹å†Œï¼Œæœ‰è¿™æ ·çš„ä¸¤ä¸ªåŠŸèƒ½ï¼š

* å°†å½“å‰å¤„ç†å™¨`ç¼“å­˜è¡Œ`çš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ï¼› ^35e1b7
* è¿™ä¸ªå†™å›å†…å­˜çš„æ“ä½œä¼šä½¿å…¶å®ƒCPUé‡Œç¼“å­˜äº†è¯¥å†…å­˜çš„åœ°å€çš„æ•°æ®æ— æ•ˆã€‚ ^a73a5c

```ad-note
è¿™é‡Œè¦ä»‹ç»ä¸€ä¸‹â€œç¼“å­˜è¡Œâ€è¿™ä¸ªæ¦‚å¿µã€‚CPUæ˜¯æœ‰Cacheçš„ï¼Œè€ŒCacheä¸­è‚¯å®šä¹Ÿä¸èƒ½å…¨æ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„å°åœ°å€æ’èµ·æ¥ï¼Œä¹Ÿè¦åˆ†å—çš„ã€‚è€Œç¼“å­˜è¡Œå°±æ˜¯è¿™ä¸ªå—çš„æœ€å°å•ä½ã€‚å®ƒå’Œå†…å­˜çš„ä¸€ä¸ªPageç±»ä¼¼ã€‚
```

***æ³¨æ„ï¼Œæˆ‘ä»¬ä¸‹é¢è®¨è®ºçš„éƒ½æ˜¯â€œå†™æ“ä½œâ€ï¼Œè€Œä¸æ˜¯â€œè¯»æ“ä½œâ€æ***ã€‚

æƒ³æƒ³æˆ‘ä»¬è¦åšä»€ä¹ˆï¼šå¯¹äºè¿™æ®µå†…å­˜ï¼Œæˆ‘æœ‰ä¸€ä¸ªæ–°çš„å€¼è¦å†™è¿›å»ã€‚ç„¶è€Œåœ¨è¿™ä¹‹å‰ï¼Œå¾ˆæœ‰å¯èƒ½å®ƒå·²ç»è¢«è¯»å–è¿‡è‹¥å¹²æ¬¡äº†ï¼Œè¿™å°±å¯¼è‡´å®ƒçš„ç¼“å­˜å¯å“ªå„¿éƒ½æ˜¯ï¼Œå†…å­˜ä¸­ã€CPUçš„å„ä¸ªçº§åˆ«çš„Cacheä¸­éƒ½æœ‰å®ƒçš„èº«å½±ã€‚é‚£ä¹ˆæˆ‘ä»¬æƒ³å¾€è¿™ä¸ªå†…å­˜ä¸­å†™å…¥ä¸€ä¸ªæ–°å€¼ï¼Œåº”è¯¥å¦‚ä½•ä¿è¯**ä¸€è‡´æ€§**å‘¢ï¼Ÿ

è¿™å°±æ˜¯lockæŒ‡ä»¤çš„æœ¬è´¨äº†ï¼šé”ï¼é”å•¥ï¼Ÿä»¥å‰çš„å¤„ç†å™¨ä¸­ï¼Œé”çš„æ˜¯`æ€»çº¿`ï¼›è€Œæœ€è¿‘çš„å¤„ç†å™¨ä¸­ï¼Œé”çš„åªæ˜¯ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯Cacheã€‚**å¦‚æœä¸€äº›Cacheä¸­å­˜å…¥äº†è¿™äº›volatileçš„å˜é‡ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½è¢«å¤šä¸ªæ ¸æˆ–è€…çº¿ç¨‹å»åŒæ—¶è®¿é—®ã€‚å› æ­¤é”çš„å°±æ˜¯è¿™äº›ä¼šè¢«åŒæ—¶è®¿é—®çš„Cacheä»¬**ã€‚å¦å¤–ï¼Œé”æ€»çº¿çš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬åœ¨[[Study Log/java_kotlin_study/concurrency_art/2_concurrency_internal#2.3.1 å¤„ç†å™¨å¦‚ä½•å®ç°åŸå­æ“ä½œ|åé¢çš„ç« èŠ‚]]ä¸­ä¼š==ä»‹ç»==ã€‚lockæŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯æŠŠæ–°å€¼æ”¾åˆ°ç¼“å­˜é‡Œï¼Œå¹¶é”å®šè¿™äº›ä¼šè¢«åŒæ—¶è®¿é—®çš„ç¼“å­˜**ä»¥åŠå†…å­˜åŒºåŸŸ**ï¼Œå¹¶å°†è¿™ä¸ªæ–°å€¼==åœ¨æ‰€æœ‰ç¼“å­˜ä¸­æ›´æ–°==ï¼Œæœ€ç»ˆå†™å›åˆ°å†…å­˜é‡Œã€‚ ^ce42bc

- [ ] #TODO â†‘ä»‹ç»äº†å—ï¼Ÿ â«

```ad-note
é”ä½äº†æ€»çº¿ï¼Œå…¶å®ƒCPUï¼ˆæ ¸æˆ–çº¿ç¨‹ï¼‰ä¸èƒ½è®¿é—®æ€»çº¿ï¼Œä¸èƒ½è®¿é—®ä¹Ÿå°±æ„å‘³ç€ä¸èƒ½è®¿é—®å†…å­˜ã€‚
```

å¦ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯è®©å…¶å®ƒçš„æ ¸æˆ–è€…çº¿ç¨‹è®¤ä¸ºè¿™ä¸ªå†…å­˜åœ°å€æ˜¯â€œæ— æ•ˆçš„â€ã€‚å…¶å®ƒçš„çº¿ç¨‹å…¶å®éƒ½æ˜¯å¯ä»¥å»å—…æ¢æ€»çº¿ä¸Šçš„æ•°æ®å˜åŒ–çš„ï¼Œå½“æœ‰äººæƒ³è¦å†™volatileçš„å˜é‡æ—¶ï¼Œå…¶å®ƒäººå°±ä¼šå—…æ¢åˆ°è¿™ä¸€æ“ä½œï¼Œå¹¶è®¤ä¸ºè‡ªå·±å¯¹æ¥çš„è¿™éƒ¨åˆ†CPU Cacheæ˜¯æ— æ•ˆçš„ï¼Œè¿™æ ·ä¹Ÿå°±ä¸ä¼šå‡ºç°**è¯»åˆ°æ—§å€¼**çš„æƒ…å†µäº†ã€‚ ^cd709e

```ad-warning
title: æ³¨æ„

æ³¨æ„å‰é¢è¯´çš„â€œåœ¨æ‰€æœ‰ç¼“å­˜ä¸­æ›´æ–°â€ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿä»ç½‘ä¸Šæ‰¾çš„èµ„æ–™ä¸­æœ‰å†™ï¼Œ`volatile`æœ‰è¿™æ ·çš„è¯­ä¹‰ï¼š

*ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯**ç«‹å³å¯è§**çš„ã€‚*

è¿™ä¸ªç«‹å³å¯è§ï¼Œä¸å°±æ˜¯è¿™ä¸ªæ„æ€å—\~

å¯è§æ€§çš„ä¸€ç¯‡æ–‡ç« ï¼š[ä¸ºä»€ä¹ˆvolatileèƒ½ä¿è¯å¯è§æ€§ï¼Ÿ_volitileä¸ºä»€ä¹ˆåªèƒ½ä¿è¯å¯è§æ€§-CSDNåšå®¢](https://blog.csdn.net/m0_37892106/article/details/97050278)
```

### 2.2 syncronized

syncronizedä¸€å…±æœ‰ä¸‰ç§ä½¿ç”¨æ–¹æ³•ï¼š

```java
public class Syncronized {  
    private final static Object lock = new Object();  

	// æ–¹æ³•1ï¼šé”æ™®é€šæ–¹æ³•
    public synchronized void function1() {  
  
    }  
    // æ–¹æ³•2ï¼šé”é™æ€æ–¹æ³•
    public static synchronized void function2() {  
  
    }  
    // æ–¹æ³•3ï¼šé”ä»£ç å—
    public void function3() {  
        synchronized (lock) {  
  
        }  
    }  
}
```

1. æ™®é€šçš„æ–¹æ³•ç”¨syncronizedä¿®é¥°ï¼Œé”æ˜¯å½“å‰**å®ä¾‹å¯¹è±¡**ã€‚
2. é™æ€æ–¹æ³•ä½¿ç”¨syncronizedä¿®é¥°ï¼Œé”æ˜¯å½“å‰**ç±»çš„Classå¯¹è±¡**ã€‚
3. åœ¨åŒæ­¥å—ä»£ç ä¸­ï¼Œé”æ˜¯**æ‹¬å·é‡Œå†™çš„å¯¹è±¡**ã€‚

é‚£ä¹ˆï¼Œ*å‡­ä»€ä¹ˆå¯¹è±¡å¯ä»¥ä½œä¸ºé”å‘¢*ï¼Ÿ*å½“ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”å­˜åœ¨æ—¶ï¼Œå®ƒåˆæ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢*ï¼Ÿæƒ³è¦äº†è§£è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆè¦äº†è§£javaå¯¹è±¡çš„ç»“æ„ã€‚

#### 2.2.1 Javaå¯¹è±¡å¤´

[æ¶¨å§¿åŠ¿å•¦ï¼Javaç¨‹åºå‘˜è£…Xå¿…å¤‡è¯æ±‡ä¹‹Mark Wordï¼ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/399423994)

Javaå¯¹è±¡çš„å®ä¾‹å¯ä»¥åˆ†ä¸ºä¸‹é¢ä¸‰ä¸ªéƒ¨åˆ†ï¼š

* å¯¹è±¡å¤´
* å®ä¾‹æ•°æ®
* padding

paddingå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å°†å®ä¾‹çš„å¤§å°è¡¥é½æˆå­—èŠ‚çš„æ•´æ•°å€ï¼Œä¹Ÿå°±æ˜¯8bitçš„æ•´æ•°å€ï¼›è€Œå®ä¾‹æ•°æ®å°±æ˜¯å¯¹è±¡å†…éƒ¨çš„ä¸€äº›å†…å®¹ï¼›æœ€åå°±æ˜¯è¿™ä¸ªå¯¹è±¡å¤´äº†ã€‚å®ƒå’Œä»€ä¹ˆipv4çš„è¯·æ±‚å¤´ï¼Œæ–‡ä»¶çš„metadataä¸€æ ·ï¼Œéƒ½æ˜¯ç”¨æ¥å­˜å‚¨å¯¹è±¡çš„åŸºæœ¬ä¿¡æ¯çš„ã€‚è€Œé”çš„ä¿¡æ¯ä¹Ÿå­˜å‚¨åœ¨å¯¹è±¡å¤´ä¸­ã€‚

è€Œå¯¹è±¡å¤´åˆå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæˆ–ä¸‰ä¸ªéƒ¨åˆ†ï¼š

* Mark Word
* Class Metadata Address
* Array lengthï¼ˆå¦‚æœæ˜¯æ•°ç»„ï¼‰

è¿™ä¸‰ä¸ªä¸œè¥¿æ¯ä¸ªéƒ½å äº†ä¸€ä¸ªWordï¼ˆå­—ï¼‰ã€‚è€Œä¸€ä¸ªå­—çš„å¤§å°å–å†³äºæ˜¯32ä½è¿˜æ˜¯64ä½çš„ç³»ç»Ÿã€‚åœ¨32ä½çš„ç³»ç»Ÿä¸­ï¼Œå®ƒä»¬å çš„ç©ºé—´éƒ½æ˜¯32bitï¼Œä¹Ÿå°±æ˜¯4ä¸ªå­—èŠ‚ï¼›è€Œåœ¨64ä½ç³»ç»Ÿä¸­ï¼Œå®ƒä»¬æ‰€å çš„ç©ºé—´åˆ†åˆ«æ˜¯64bit 64bit 32bitã€‚

|   é•¿åº¦   |          å†…å®¹          |             è¯´æ˜             |
|:--------:|:----------------------:|:----------------------------:|
| 32/64bit |       Mark Word        | å­˜å‚¨å¯¹è±¡çš„hashCodeæˆ–é”ä¿¡æ¯ç­‰ |
| 32/64bit | Class Metadata Address |   å­˜å‚¨åˆ°å¯¹è±¡ç±»å‹æ•°æ®çš„æŒ‡é’ˆ   |
| 32/32bit |      Array length      |          æ•°ç»„çš„é•¿åº¦          |

æˆ‘ä»¬ä¹‹å‰ä¹Ÿå¬è¿‡ä»€ä¹ˆâ€œåå‘é”â€ï¼Œâ€œè½»é‡çº§é”â€è¿™äº›æ¦‚å¿µã€‚è€Œè¿™äº›ä¿¡æ¯å°±å­˜å‚¨åœ¨Mark Wordé‡Œã€‚æˆ‘ä»¬å¯ä»¥ç¨å¾®æµè§ˆä¸€ä¸‹Mark Wordçš„å¤§è‡´ç»“æ„ï¼Œè¿™é‡Œå°±åªçœ‹64ä½ç³»ç»Ÿçš„äº†ï¼š

![[Study Log/java_kotlin_study/resources/Pasted image 20230921154823.png]]

ä¸‹é¢æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹é”çš„å…¶å®ƒæ¦‚å¿µï¼Œå†å›å¤´æ¥çœ‹è¿™ä¸ªè¡¨æ ¼ï¼Œå°±æ¸…æ™°å¤šäº†ã€‚

#### 2.2.2 é”çš„å‡çº§ä¸å¯¹æ¯”

Javaçš„å¯¹è±¡åœ¨é”çš„æ–¹é¢ï¼Œä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼š

1. æ— é”çŠ¶æ€ï¼›
2. **åå‘é”**çŠ¶æ€ï¼›
3. **è½»é‡çº§é”**çŠ¶æ€ï¼›
4. **é‡é‡çº§é”**çŠ¶æ€

å®ƒä»¬çš„çº§åˆ«ä»ä½åˆ°é«˜ï¼Œ**ä»£è¡¨ç€çº¿ç¨‹çš„ç«äº‰çš„æ¿€çƒˆç¨‹åº¦ä¹Ÿè¶Šæ¥è¶Šé«˜**ã€‚***é”åªèƒ½å‡çº§ï¼Œä¸èƒ½é™çº§***ã€‚

```ad-hint
title: æ³¨æ„

è¿™é‡Œçš„å››ç§çŠ¶æ€ï¼ŒæŒ‡çš„æ˜¯<u>ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”æ—¶çš„ä¸åŒçŠ¶æ€</u>ã€‚æ¯”å¦‚ï¼Œä¸€æŠŠé”ä¸€å¼€å§‹åªæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰è¢«æ”¾åœ¨syncronizedä¸­ï¼Œé‚£ä¹ˆæ­¤æ—¶å®ƒå°±å¤„äºæ— é”çŠ¶æ€ï¼›è€Œéšç€ç«äº‰è¶Šæ¥è¶Šæ¿€çƒˆï¼Œè¿™ä¸ªå¯¹è±¡çš„é”çŠ¶æ€ä¹Ÿä¼šä¸æ–­**å‡çº§**ã€‚
```

##### åå‘é”

`åå‘é”`æ˜¯Javaä¸­æœ€è½»é‡çš„é”ã€‚æ˜¯åœ¨Java SE 1.6ä¸­ï¼Œä¸ºäº†**å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”çš„æ€§èƒ½æ¶ˆè€—**è€Œå¼•å…¥çš„ã€‚

å½“ä¸€ä¸ªçº¿ç¨‹åˆæ¬¡è·å¾—åå‘é”æ—¶ï¼Œä¼šåœ¨**é”å¯¹è±¡**çš„å¯¹è±¡å¤´ä¸­è®°å½•è‡ªå·±è¿™ä¸ªçº¿ç¨‹çš„IDã€‚ä¹‹åå†è·å–çš„æ—¶å€™ï¼Œå°±ä¸ç”¨è¿›è¡Œ`CAS`æ¥åŠ é”å’Œè§£é”äº†ï¼Œåªéœ€è¦çœ‹çœ‹é”çš„å¯¹è±¡å¤´çš„Mark Wordä¸­çš„è¿™ä¸ªåå‘é”çš„çº¿ç¨‹IDæ˜¯å¦æ˜¯è‡ªå·±ã€‚

```ad-note
CAS(Compare And Swap)æ“ä½œï¼š[ã€Javaå¹¶å‘ã€‘é¢è¯•å®˜é—®æˆ‘CASã€ä¹è§‚é”ã€æ‚²è§‚é”ï¼Œæˆ‘åæ‰‹å°±æ˜¯éª‘è„¸è¾“å‡º_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1ff4y1q7we/?spm_id_from=333.788&vd_source=64798edb37a6df5a2f8713039c334afb)
```

ç„¶åæ˜¯ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆä¼šå«åšâ€œåå‘â€é”ï¼Ÿä»åå­—ä¸Šå¬ï¼Œå°±æ˜¯åœ¨è¯´ï¼Œ**åªè¦æˆ‘è·å¾—äº†è¿™ä¸ªé”ï¼Œé‚£ä¹ˆè¿™æŠŠé”å°±æ˜¯==åå‘==æˆ‘çš„ï¼Œä¹‹åå®ƒä¸ä¼šå†å»åå‘åˆ«äºº**ã€‚

é‚£ä¹ˆè¿™æ ·çœ‹æ¥ï¼Œè¿™æŠŠé”çš„è®¾è®¡æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸€æ—¦ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†è¿™æŠŠé”ï¼Œä¹‹åä¹Ÿæœ€æœ‰å¯èƒ½ä¸€ç›´æ˜¯å®ƒåœ¨è·å¾—è¿™æŠŠé”**ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼ŸHotSpotçš„ä½œè€…ç»è¿‡ç ”ç©¶å‘ç°ï¼Œ**å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”==ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—==**ã€‚

æ‡‚äº†å§\~\~ï¼Œå…¶å®å°±æ˜¯å› ä¸ºæœ‰è¿™æ ·çš„ç°è±¡ï¼Œæ‰æœ‰äº†è¿™æ ·çš„è®¾è®¡ã€‚å¦‚æœæ¯æ¬¡éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹åœ¨è·å¾—è¿™æŠŠé”ï¼Œé‚£*ä¸ºä»€ä¹ˆè¿˜è¦æ¯æ¬¡éƒ½éº»çƒ¦äººå®¶å»åŠ é”è§£é”å‘¢*ï¼Ÿå› æ­¤ï¼Œåå‘é”çš„æ ¹æœ¬ç›®çš„æ˜¯ï¼Œ**è®©çº¿ç¨‹ï¼ˆå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼‰è·å¾—é”çš„ä»£ä»·æ›´ä½**ã€‚

ä¸ºå•¥è¦æœ‰åå‘é”ï¼Ÿå¦‚æœæˆ‘è¿™æŠŠé”åªèƒ½ç»™ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¸ºå•¥è¿˜è¦åŠ é”ï¼Ÿè¿˜è®°å¾—é”çš„å‡çº§è¿‡ç¨‹å—ï¼Ÿ**åå‘é”çš„å­˜åœ¨ï¼Œæ˜¯ä¸ºäº†åœ¨å¹¶å‘è¿‡ç¨‹ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œè®©ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„æƒ…å†µçš„æ€§èƒ½æ›´å¥½**ã€‚ä¸€æ—¦æœ‰ç¬¬äºŒä¸ªçº¿ç¨‹è¯•å›¾å»ç«äº‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆå°±ä¸å†æ˜¯åå‘é”äº†ã€‚

æ›´ç›´ç™½ä¸€ç‚¹è¯´ï¼Œä¸‹é¢çš„æ–¹æ³•ï¼š

```java
public static syncronized void method() {
	doSomething();
}
```

æ˜¯ä¸€ä¸ªåŠ äº†é”çš„æ–¹æ³•ï¼Œå¾ˆå¤šçº¿ç¨‹éƒ½ä¼šåŒæ—¶è°ƒç”¨å®ƒã€‚é‚£ä¹ˆï¼Œåœ¨ç¨‹åºåˆšè¿è¡Œèµ·æ¥çš„æ—¶å€™ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¸ºå•¥è¿˜è¦åŠ é”å‘¢ï¼Ÿä½†æ˜¯ï¼Œåœ¨ä¹‹åçš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½è¿˜ä¼šæœ‰å…¶ä»–çš„çº¿ç¨‹ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚å› æ­¤ï¼Œåå‘é”å°±æ˜¯ä¸ºè¿™æ®µ**åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®**çš„ç©ºæ¡£æœŸè€Œç”Ÿçš„ã€‚

[ï¼ˆäºŒï¼‰åå‘é”è¯¦è§£_åŒ¿ååå‘é”-CSDNåšå®¢](https://blog.csdn.net/qq_28773223/article/details/109706667#:~:text=%E5%81%8F%E5%90%91%E9%94%81%EF%BC%88%E4%B8%8D%E5%A4%AA%E9%9C%80%E8%A6%81%E7%AB%9E%E4%BA%89%E7%9A%84%EF%BC%8C%E4%B8%80%E8%88%AC%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B%EF%BC%89%20%E6%9C%AA%E5%BF%85%E4%BC%9A%E6%8F%90%E9%AB%98%EF%BC%8C%E5%B0%A4%E5%85%B6%E6%98%AF%E5%BD%93%E4%BD%A0%E7%9F%A5%E9%81%93%E4%B8%80%E5%AE%9A%E4%BC%9A%E6%9C%89%E5%A4%A7%E9%87%8F%E7%BA%BF%E7%A8%8B%E5%8E%BB%E7%AB%9E%E4%BA%89%E7%9A%84%E6%97%B6%E5%80%99%E3%80%82%20%E6%89%93%E5%BC%80%E5%81%8F%E5%90%91%E9%94%81%E5%81%8F%E5%90%91%E9%94%81%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%E9%94%81%E6%92%A4%E9%94%80%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%88%E6%8A%8AID%E6%92%95%E4%B8%8B%E6%9D%A5%EF%BC%89%EF%BC%8C,2.%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BB%B6%E8%BF%9F4s%20%E5%9B%A0%E4%B8%BAJVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%87%AA%E5%B7%B1%E6%9C%89%E4%B8%80%E4%BA%9B%E9%BB%98%E8%AE%A4%E7%9A%84%E5%90%AF%E5%8A%A8%E7%BA%BF%E7%A8%8B%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%9C%89%E5%A5%BD%E5%A4%9Async%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BB%A3%E7%A0%81%E5%90%AF%E5%8A%A8%E6%97%B6%E5%B0%B1%E8%82%AF%E5%AE%9A%E4%BC%9A%E6%9C%89%E7%AB%9E%E4%BA%89%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%81%8F%E5%90%91%E9%94%81%EF%BC%8C%E5%B0%B1%E4%BC%9A%E9%80%A0%E6%88%90%E5%81%8F%E5%90%91%E9%94%81%E4%B8%8D%E6%96%AD%E7%9A%84%E8%BF%9B%E8%A1%8C%E9%94%81%E6%92%A4%E9%94%80%E5%92%8C%E9%94%81%E5%8D%87%E7%BA%A7%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%95%88%E7%8E%87%E8%BE%83%E4%BD%8E%203.%E6%80%8E%E6%A0%B7%E8%AE%BE%E7%BD%AE%E5%81%8F%E5%90%91%E9%94%81%E5%BB%B6%E8%BF%9F%E6%97%B6%E9%97%B4)

[Javaçš„Synchronizedé”-åå‘é” - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6994404508344270878)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ¥è¯´æ˜ä¸Šé¢çš„ç»“è®ºã€‚å®šä¹‰ä¸€ä¸ªåå‘é”çš„æ¨¡å‹ï¼š

```kotlin
class BiasLock {  
    var i = 0  
    @Synchronized  
    fun incr() {  
        i++  
        System.out.println(Thread.currentThread().name + " - " + ClassLayout.parseInstance(this).toPrintable())  
    }  
}
```

å½“æœ‰çº¿ç¨‹è°ƒç”¨è¿™ä¸ª`incr()`æ–¹æ³•æ—¶ï¼Œå°±ä¼šè¿›å…¥åŒæ­¥ä»£ç å—çš„åŒºåŸŸã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ä¸€ä¸‹è¯•è¯•ï¼š

```kotlin
class LockTest() {  
    companion object {  
        fun test() {  
            val lock = BiasLock()  
            System.err.println(ClassLayout.parseInstance(lock).toPrintable())  
            lock.incr()  
            System.err.println(ClassLayout.parseInstance(lock).toPrintable())  
        }  
    }  
}
```

æ‰§è¡Œ`LockTest.test()`å°±å¯ä»¥äº†ã€‚ç„¶è€Œï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯jdk15+çš„ç‰ˆæœ¬ï¼Œåº”è¯¥ä¸ä¼šçœ‹åˆ°æœ‰å…³åå‘é”çš„ä¿¡æ¯ã€‚å› ä¸ºåœ¨è¿™ä¹‹ååå‘é”å·²ç»è¢«é»˜è®¤ç§»é™¤äº†ï¼š[javaåå‘é”é»˜è®¤å¼€å¯è¿˜æ˜¯å…³é—­,JDK15 é»˜è®¤å…³é—­åå‘é”ä¼˜åŒ–åŸå› -CSDNåšå®¢](https://blog.csdn.net/weixin_39764379/article/details/116055860)

ä¸ºäº†é‡æ–°å¼€å¯åå‘é”ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®è™šæ‹Ÿæœºå‚æ•°ï¼š

![[Study Log/java_kotlin_study/resources/Pasted image 20231003164409.png]]

```
-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay=0
```

æ­¤æ—¶çš„è¾“å‡ºæ˜¯è¿™æ ·çš„ï¼š

```shell
Java HotSpot(TM) 64-Bit Server VM warning: Option UseBiasedLocking was deprecated in version 15.0 and will likely be removed in a future release.
Java HotSpot(TM) 64-Bit Server VM warning: Option BiasedLockingStartupDelay was deprecated in version 15.0 and will likely be removed in a future release.
# WARNING: Unable to get Instrumentation. Dynamic Attach failed. You may add this JAR as -javaagent manually, or supply -Djdk.attach.allowAttachSelf
concurrency.lock.BiasLock object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x0000000000000005 (biasable; age: 0)
  8   4        (object header: class)    0x00c02420
 12   4    int BiasLock.i                0
Instance size: 16 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total

concurrency.lock.BiasLock object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x000002aec274c805 (biased: 0x00000000abb09d32; epoch: 0; age: 0)
  8   4        (object header: class)    0x00c02420
 12   4    int BiasLock.i                1
Instance size: 16 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total

main - concurrency.lock.BiasLock object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x000002aec274c805 (biased: 0x00000000abb09d32; epoch: 0; age: 0)
  8   4        (object header: class)    0x00c02420
 12   4    int BiasLock.i                1
Instance size: 16 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total
```

æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼š

1. ä¸€å¼€å§‹çš„è­¦å‘Šå°±æ˜¯åœ¨è¯´ï¼Œåå‘é”å·²ç»è¢«ç§»é™¤äº†ï¼Œæœ€å¥½ä¸è¦ç”¨ï¼Œä¼šæœ‰æ€§èƒ½æŸå¤±ï¼›
2. ç¬¬ä¸‰æ®µï¼Œä¹Ÿå°±æ˜¯mainå¼€å¤´çš„é‚£ä¸ªï¼Œæ˜¯æˆ‘åœ¨`incr()`æ–¹æ³•é‡Œé¢å†™çš„ã€‚å¦‚æœå•æ­¥è°ƒè¯•èµ°çš„è¯ï¼Œè¿™æ®µåº”è¯¥åœ¨ä¸­é—´ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒæ®µè¾“å‡ºã€‚æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆå®ƒä¼šå‡ºç°åœ¨ç¬¬ä¸‰æ®µã€‚

ä»è¾“å‡ºä¿¡æ¯ï¼Œæˆ‘ä»¬èƒ½çœ‹å‡ºï¼Œåå‘é”å·²ç»å¯åŠ¨ã€‚å¹¶ä¸”ï¼Œå½“`incr()`æ–¹æ³•æ‰§è¡Œç»“æŸä¹‹åï¼Œåå‘é”ä¸­ä¿å­˜çš„çº¿ç¨‹IDä¾ç„¶æ˜¯`0x00000000abb09d32`ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**åå‘é”æ˜¯ä¸ä¼šè§£é”çš„ï¼Œå®ƒåªä¼šå±äºä¸€ä¸ªçº¿ç¨‹**ã€‚

```ad-note
ä¸‹å›¾ä¸­ï¼Œçº¿ç¨‹1æ‰§è¡Œåå‘é”çš„è·å¾—è¿‡ç¨‹ï¼›çº¿ç¨‹2æ‰§è¡Œåå‘é”çš„æ’¤é”€è¿‡ç¨‹ã€‚
```

![[Study Log/java_kotlin_study/resources/Pasted image 20231002215029.png]]

å…¶ä»–èµ„æ–™ï¼š[éš¾æçš„åå‘é”ç»ˆäºè¢« Java ç§»é™¤äº† - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7046921350065160206#heading-2)è¿™ç¯‡èµ„æ–™ä»‹ç»äº†ä¸ºä»€ä¹ˆåå‘é”è¢«åºŸå¼ƒï¼Œä¸ºä»€ä¹ˆåå‘é”å¯ç”¨éœ€è¦å»¶è¿Ÿ4ç§’å·¦å³ã€‚ä»¥åŠè¿˜æ²¡æœ‰æåˆ°çš„epochç­‰ç­‰å†…å®¹ã€‚

- [ ] #TODO åå‘é”çš„è¿™éƒ¨åˆ†å†…å®¹ï¼Œä¹‹åæœ‰æ—¶é—´çš„è¯æœ€å¥½è¡¥å……ä¸Šå»ã€‚ ğŸ”½

##### è½»é‡çº§é”

ä¸€æ—¦æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šçº¿ç¨‹å»ç«äº‰ä¸€æŠŠé”æ—¶ï¼Œåå‘é”å°±ä¼šå‡çº§æˆä¸º`è½»é‡çº§é”`ã€‚è¿™é‡Œä¸»è¦é‡‡ç”¨çš„æ‰‹æ®µæ˜¯CASæ“ä½œã€‚

åœ¨ä¹‹å‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä¸€ä¸‹LockTestï¼š

```kotlin
class LockTest(private val lock: BiasLock) : Runnable {  
    override fun run() {  
        this.lock.incr()  
    }  
    companion object {  
        fun test() {  
            val lock = BiasLock()  
            System.err.println(ClassLayout.parseInstance(lock).toPrintable())  
            lock.incr()  
            System.err.println(ClassLayout.parseInstance(lock).toPrintable())  
            Thread(LockTest(lock)).start()  
        }
    }  
}
```

è¿™æ ·å°±æœ‰ä¸¤ä¸ªçº¿ç¨‹åœ¨ç«äº‰lockè¿™æŠŠé”ï¼Œå½“ç¬¬äºŒæ¬¡æ‰§è¡Œåˆ°`incr()`æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°ï¼Œé”å·²ç»å‡çº§æˆäº†thin-lockã€‚

[Javaé”ä¹‹åå‘çº§é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”_åå‘é”æ˜¯ä»€ä¹ˆ?è½»é‡çº§é”æ˜¯ä»€ä¹ˆ?_Colourfulï¼çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/Colorful_X/article/details/117110786)

[è½»é‡çº§é”åŠ è§£é”è¿‡ç¨‹è¯¦è§£ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/141554048)

---

åœ¨ä»‹ç»è½»é‡çº§é”çš„åŠ é”å’Œè§£é”è¿‡ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹**æ ˆå¸§**è¿™ä¸ªæ¦‚å¿µã€‚è¿™ä¸ªæ¦‚å¿µåœ¨æˆ‘æ­£å¼å­¦ä¹ ä¹‹å‰ä¹Ÿæœ‰æ‰€äº†è§£å’Œè®¤çŸ¥ï¼Œä½†æ€»æ˜¯æ„Ÿè§‰å¦‚æ¢¦ä¼¼å¹»ï¼Œä¸‹é¢å°±æ¥æ­£å¼ä»‹ç»ä¸€ä¸‹ã€‚

[å›¾è§£æ ˆå¸§ï¼Œåˆ«å†æ­»è®°ç¡¬èƒŒ_Java_æå­æŒ_InfoQå†™ä½œç¤¾åŒº](https://xie.infoq.cn/article/6b7026f6d930eca0efa021371)

ç¨‹åºè¿è¡Œéƒ½æœ‰ä¸ªæ ˆç©ºé—´ï¼Œè¿™æ˜¯æˆ‘ä»¬çŸ¥é“çš„ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæ ˆç©ºé—´å†…éƒ¨æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿæˆ‘ä»¬çŒœéƒ½èƒ½çŒœå‡ºæ¥ï¼š**å°±æ˜¯æ ˆå¸§ç»„æˆçš„å‘—**ï¼

![[Study Log/java_kotlin_study/resources/Pasted image 20231003191740.png]]

ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œä¼š**è¿›è¡Œè‹¥å¹²æ¬¡çš„å‡½æ•°è°ƒç”¨ï¼Œç”šè‡³é€’å½’è°ƒç”¨**ã€‚æ¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨**è¿™æ¬¡å‡½æ•°æ‰§è¡Œçš„å‘¨æœŸå†…**ï¼Œåœ¨æ ˆç©ºé—´ä¸­åˆ†é…ä¸€æ®µç©ºé—´ï¼Œç”¨æ¥å­˜è¿™ä¸ªå‡½æ•°ç‹¬æœ‰çš„å˜é‡ã€‚

```java
public static void method() {
	int a;
}
```

ä¸Šé¢ä»£ç ä¸­çš„å˜é‡aå°±æ˜¯è¿™ä¸ªæ–¹æ³•ç‹¬äº«çš„ï¼Œä¹Ÿè‡ªç„¶åªå­˜åœ¨äºä¸ºè¿™ä¸ªå‡½æ•°åˆ†é…çš„**æ ˆå¸§**ä¸­ã€‚

---

okï¼Œç°åœ¨å¯ä»¥ä»‹ç»è½»é‡çº§é”çš„åŠ é”è¿‡ç¨‹äº†ã€‚å…¶å®éå¸¸ç®€å•ï¼š

***1. å°†é”çš„å¯¹è±¡å¤´ä¸­çš„Mark Wordå¤åˆ¶åˆ°çº¿ç¨‹è‡ªå·±çš„æ ˆå¸§ä¸­***ã€‚

çº¿ç¨‹çš„æ ˆå¸§çš„è¿™éƒ¨åˆ†ç©ºé—´å«åš**Lock Record**ï¼Œå¤åˆ¶è¿‡æ¥çš„Mark Wordå«åš**Displaced Mark Word**ã€‚ç›´è¯‘è¿‡æ¥ï¼Œå°±æ˜¯â€œè¢«ç§»èµ°çš„Mark Wordâ€ã€‚éå¸¸ç®€å•æ˜“æ‡‚æ˜¯ä¸æ˜¯ğŸ™‚ã€‚

***2. çº¿ç¨‹å°è¯•å°†é”çš„å¯¹è±¡å¤´çš„Mark Wordæ›¿æ¢ä¸ºè‡ªå·±è¿™ä¸ªDisplaced Mark Wordçš„æŒ‡é’ˆ***ã€‚

è¿™ä¸€æ­¥ç¨å¾®æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬ç”»ä¸ªå›¾è§£é‡Šä¸€ä¸‹ã€‚é¦–å…ˆï¼Œçº¿ç¨‹è‡ªå·±çš„æ ˆå¸§é‡Œå­˜çš„æ˜¯Displaced Mark Wordï¼Œä¹Ÿå°±æ˜¯ä»é”é‡Œé¢å¤åˆ¶è¿‡æ¥çš„ï¼š

![[Study Log/java_kotlin_study/resources/Drawing 2023-10-03 22.23.04.excalidraw.png]]

ç„¶åï¼Œ**è¿™ä¸ªDisplaced Mark Wordè‚¯å®šä¼šæœ‰ä¸ªåœ°å€å‘€**ï¼æˆ‘ä»¬å‡è®¾å®ƒæ˜¯`0x1234abcd`ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œè¿™ä¸ªåœ°å€å°±ä¼šè¢«æ›¿æ¢åˆ°é”çš„Mark Wordä¸­ï¼š

![[Study Log/java_kotlin_study/resources/Drawing 2023-10-03 22.26.30.excalidraw.png]]

ç°åœ¨å›å¤´çœ‹ä¸€ä¸‹ä¹‹å‰ä»‹ç»Mark Wordå†…éƒ¨ç»“æ„æ—¶çš„å›¾ç‰‡ï¼š

![[Study Log/java_kotlin_study/resources/Pasted image 20230921154823.png]]

å½“é”ä¸ºè½»é‡çº§é”æ—¶ï¼ŒMark Wordçš„ç»“æ„å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆåŠ ä¸Šæ ‡è¯†ä½00ã€‚è¿™å’Œæˆ‘åˆšåˆšç”»çš„å›¾æ˜¯ä¸€æ ·çš„ã€‚

ä½†æ˜¯è¦æ³¨æ„ï¼Œåªæ˜¯åœ¨å°è¯•ã€‚è¿™å°±ä»£è¡¨ä¸ä¸€å®šèƒ½æˆåŠŸã€‚ç”±äº**è¿™æ­¥æ›¿æ¢æ“ä½œä½¿ç”¨çš„æ˜¯CAS**ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€ä¼šæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿè¦è¿›è¡Œæ›¿æ¢ã€‚è€Œå¦‚æœæŸä¸ªçº¿ç¨‹æ¯”æˆ‘æŠ¢å…ˆä¸€æ­¥è¿›è¡Œäº†æ›¿æ¢ï¼Œé‚£ä¹ˆæˆ‘å¦‚æœç«‹åˆ»è¿›è¡Œæ›¿æ¢çš„è¯ï¼Œå°±äº§ç”Ÿäº†ç«äº‰ã€‚é‚£ä¹ˆæˆ‘æ­¤æ—¶çš„æ›¿æ¢å°±ä¼šå¤±è´¥ã€‚

å¤±è´¥äº†ä¹‹åå‘¢ï¼Ÿæˆ‘å½“å‰è¿™ä¸ªçº¿ç¨‹ä¼šä½¿ç”¨~~è‡ªæ—‹~~æ¥ä¸æ–­é‡æ–°å°è¯•è·å–é”ã€‚è€Œå¦‚æœæ€»æ˜¯è·å¾—ä¸äº†ï¼Œè¾¾åˆ°ä¸€å®šæ¬¡æ•°ä¹‹åï¼Œå°±ä¼šå‡çº§æˆé‡é‡çº§é”ã€‚

```ad-note
çœŸçš„ä¼šè‡ªæ—‹å—ï¼Ÿçœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š[åˆ«å†å’Œé¢è¯•å®˜è¯´Synchronizedè½»é‡çº§é”è‡ªæ—‹äº†ï¼Œé”™äº†ï¼_ç‰›å®¢ç½‘ (nowcoder.com)](https://www.nowcoder.com/discuss/353157586415460352)
```

---

ç„¶åï¼Œæ˜¯è½»é‡çº§é”è§£é”çš„è¿‡ç¨‹ã€‚å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆšåˆšä¸æ˜¯å¤åˆ¶äº†ä¸ªDisplaced Mark Wordå‡ºæ¥å—ï¼Ÿ**å®ƒå…¶å®å°±ç›¸å½“äºä¸€ä¸ªå¤‡ä»½**ã€‚åœ¨å¤‡ä»½ä¹‹åï¼Œæˆ‘ä»¬å°†åŸæ¥é”ä¸­çš„Mark Wordçš„å‰è¾¹éƒ½æ›¿æ¢æˆäº†æˆ‘ä»¬è¿™ä¸ªDMWçš„æŒ‡é’ˆã€‚é‚£æ—¢ç„¶è¦è§£é”ï¼ŒæŠŠå¤‡ä»½è¿˜åŸå›å»å°±è¡Œäº†å‘—ï¼š

***ä½¿ç”¨CASæ“ä½œå°†Displaced Mark Wordæ›¿æ¢å›åˆ°é”çš„å¯¹è±¡å¤´ä¸­***ã€‚

```ad-attention
title: æ³¨æ„

åŠ é”æ—¶çš„æ›¿æ¢æŒ‡é’ˆçš„æ“ä½œï¼Œå’Œè§£é”æ—¶è¿˜åŸå¤‡ä»½çš„æ“ä½œï¼Œéƒ½æ˜¯CASã€‚
```

å¦‚æœè¿˜åŸæˆåŠŸï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å‘ç”Ÿç«äº‰ï¼ŒæˆåŠŸè§£é”ï¼›å¦‚æœå¤±è´¥ï¼Œé‚£ä¹ˆå°±ä»£è¡¨æ­¤æ—¶ä¾ç„¶è¿˜å­˜åœ¨é”çš„ç«äº‰ã€‚é‚£ä¹ˆæ­¤æ—¶é”å°±ä¼šå˜æˆé‡é‡çº§çš„é”ã€‚

![[Study Log/java_kotlin_study/resources/Pasted image 20231003224859.png]]

å…¶å®ƒèµ„æ–™ï¼š[æ­»ç£•Synchronizedåº•å±‚å®ç°--æ¦‚è®º Â· Issue #12 Â· farmerjohngit/myblog (github.com)](https://github.com/farmerjohngit/myblog/issues/12)

- [>] é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”

| é”       | ä¼˜ç‚¹                                                               | ç¼ºç‚¹                                           | é€‚ç”¨åœºæ™¯                           |
| -------- | ------------------------------------------------------------------ | ---------------------------------------------- | ---------------------------------- |
| åå‘é”   | åŠ é”å’Œè§£é”ä¸éœ€è¦é¢å¤–çš„æ¶ˆè€—ï¼Œå’Œæ‰§è¡ŒéåŒæ­¥æ–¹æ³•ç›¸æ¯”ä»…å­˜åœ¨çº³ç§’çº§çš„å·®è· | å¦‚æœçº¿ç¨‹é—´å­˜åœ¨é”ç«äº‰ï¼Œä¼šå¸¦æ¥é¢å¤–çš„é”æ’¤é”€çš„æ¶ˆè€— | é€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—çš„åœºæ™¯ |
| è½»é‡çº§é” | ç«äº‰çš„çº¿ç¨‹**ä¸ä¼šé˜»å¡**ï¼Œæé«˜äº†ç¨‹åºçš„å“åº”é€Ÿåº¦                           | å¦‚æœå§‹ç»ˆå¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ï¼Œ~~ä½¿ç”¨è‡ªæ—‹ä¼šæ¶ˆè€—CPU~~  | è¿½æ±‚å“åº”æ—¶é—´ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦éå¸¸å¿« |
| é‡é‡çº§é” | çº¿ç¨‹ç«äº‰ä¸ä½¿ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€—CPU                                    | çº¿ç¨‹**é˜»å¡**ï¼Œå“åº”æ—¶é—´æ…¢                           | è¿½æ±‚ååé‡ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦è¾ƒæ…¢                                   |

```ad-note
æ³¨æ„ä¹‹å‰å¯¹äºè‡ªæ—‹çš„è§£é‡Šã€‚
```

### 2.3 åŸå­æ“ä½œ

#### 2.3.1 å¤„ç†å™¨å¦‚ä½•å®ç°åŸå­æ“ä½œ

> <small>32 ä½ IA-32 å¤„ç†å™¨ä½¿ç”¨åŸºäºå¯¹ç¼“å­˜åŠ é”æˆ–æ€»çº¿åŠ é”çš„æ–¹å¼æ¥å®ç°å¤šå¤„ç†å™¨ä¹‹é—´çš„åŸå­æ“ä½œã€‚é¦–å…ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨ä¿è¯åŸºæœ¬çš„å†…å­˜æ“ä½œçš„åŸå­æ€§ã€‚å¤„ç†å™¨ä¿è¯ä»ç³»ç»Ÿå†…å­˜ä¸­è¯»å–æˆ–è€…å†™å…¥ä¸€ä¸ªå­—èŠ‚æ˜¯åŸå­çš„ï¼Œæ„æ€æ˜¯å½“ä¸€ä¸ªå¤„ç†å™¨è¯»å–ä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½è®¿é—®è¿™ä¸ªå­—èŠ‚çš„å†…å­˜åœ°å€ã€‚Pentium 6 å’Œæœ€æ–°çš„å¤„ç†å™¨èƒ½è‡ªåŠ¨ä¿è¯å•å¤„ç†å™¨å¯¹åŒä¸€ä¸ªç¼“å­˜è¡Œé‡Œè¿›è¡Œ 16/32/64 ä½çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œä½†æ˜¯å¤æ‚çš„å†…å­˜æ“ä½œå¤„ç†å™¨æ˜¯ä¸èƒ½è‡ªåŠ¨ä¿è¯å…¶åŸå­æ€§çš„ï¼Œæ¯”å¦‚è·¨æ€»çº¿å®½åº¦ã€è·¨å¤šä¸ªç¼“å­˜è¡Œå’Œè·¨é¡µè¡¨çš„è®¿é—®ã€‚ä½†æ˜¯ï¼Œå¤„ç†å™¨æä¾›<font color="yellow">æ€»çº¿é”å®š</font>å’Œ<font color="yellow">ç¼“å­˜é”å®š</font>ä¸¤ä¸ªæœºåˆ¶æ¥ä¿è¯å¤æ‚å†…å­˜æ“ä½œçš„åŸå­æ€§ã€‚</small>

##### æ€»çº¿é”

ç°åœ¨å‡è®¾ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œä¸¤æ¬¡`i++`æ“ä½œã€‚å¦‚æœiçš„åˆå€¼æ˜¯1ï¼Œé‚£ä¹ˆç»“æœåº”è¯¥æ˜¯3ã€‚ä½†æ˜¯å¦‚æœè¿™ä¸¤æ¬¡i++æ“ä½œæ˜¯ç”±ä¸¤ä¸ªçº¿ç¨‹å»å®Œæˆçš„ï¼Œé‚£å¯èƒ½ä¼šæœ‰è¿™æ ·çš„æƒ…å†µï¼š

![[Study Log/java_kotlin_study/resources/Pasted image 20231005134008.png]]

ä¸¤ä¸ªCPUåŒæ—¶è¯»åˆ°äº†içš„åˆå€¼éƒ½æ˜¯1ï¼Œç„¶ååˆ†åˆ«æŠŠå®ƒä»¬åŠ æˆäº†2ï¼Œç„¶åå†™å›åˆ°å†…å­˜ä¸­ã€‚è¿™æ ·çš„ç»“æœå°±æ˜¯é”™è¯¯çš„ã€‚

é”™è¯¯çš„æ ¹æœ¬åŸå› åœ¨äºï¼Œ**å½“ä¸€ä¸ªCPUå¯¹å˜é‡è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¦ä¸€ä¸ªå˜é‡ä¹Ÿè¯•å›¾è¯»å–==å¹¶ä¿®æ”¹==è¿™ä¸ªå˜é‡ï¼Œä¸”æˆåŠŸè¯»å–**ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼Œè®©ä»–å¤±è´¥ã€‚

æ€»çº¿é”å°±æ˜¯å¤„ç†å™¨æä¾›çš„ä¸€ä¸ª`LOCK#`ä¿¡å·ï¼Œå½“ä¸€ä¸ªå¤„ç†å™¨åœ¨æ€»çº¿ä¸Šè¾“å‡ºè¿™ä¸ªä¿¡å·çš„æ—¶å€™ï¼Œ**å…¶å®ƒå¤„ç†å™¨çš„è¯·æ±‚å°±ä¼šé˜»å¡**ã€‚ä¹‹å‰ä»‹ç»volatileçš„æ—¶å€™æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼š[[#^ce42bc]]

##### ç¼“å­˜é”

ä¹Ÿæ˜¯ä¹‹å‰çš„ä»‹ç»ä¸­ï¼Œæ¯”æ€»çº¿é”æ›´èªæ˜çš„æ˜¯ç¼“å­˜é”ã€‚æ—¢ç„¶ä½ ä¸è®©å¤šä¸ªCPUåŒæ—¶è¯»åˆ°iï¼Œé‚£ä½ åªæŠŠiçš„é‚£æ®µå†…å­˜é”ä½ä¸å°±å¥½äº†å˜›ï¼Œè¿˜å¹²å˜›é”æ•´ä¸ªæ€»çº¿å‘¢ï¼Ÿ**åœ¨åŒä¸€æ—¶åˆ»ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿è¯å¯¹æŸä¸ªå†…å­˜åœ°å€çš„æ“ä½œæ˜¯åŸå­æ€§çš„å³å¯**ã€‚

è¿˜è®°å¾—ä¹‹å‰è¯´è¿‡çš„L1 L2 L3ç¼“å­˜å—ï¼Ÿå¦‚æœæ˜¯é¢‘ç¹ä½¿ç”¨çš„å†…å­˜ï¼Œé‚£ä¹ˆå®ƒä»¬å°±æ›´æœ‰å¯èƒ½å‡ºç°åœ¨è¿™äº›ç¼“å­˜ä¸­ã€‚æ‰€ä»¥ï¼Œå¯¹äºä¼šè¢«å¹¶å‘æ“ä½œï¼ˆå¤šäººè¿åŠ¨ï¼‰çš„å†…å­˜ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å®ƒå¯¹åº”çš„ç¼“å­˜ä¸­è¿›è¡ŒåŸå­æ“ä½œå°±å¯ä»¥äº†ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœCPU1åœ¨ä¿®æ”¹içš„æ—¶å€™ä½¿ç”¨äº†`ç¼“å­˜é”å®š`ï¼Œé‚£ä¹ˆCPU2å°±ä¸èƒ½åŒæ—¶ç¼“å­˜içš„ç¼“å­˜è¡Œã€‚

**ä½†æ˜¯ï¼Œæœ‰ä¸€äº›ä¾‹å¤–æƒ…å†µï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ç¼“å­˜é”ï¼Œåªèƒ½ä½¿ç”¨æ€»çº¿é”**ï¼š

* å½“æ“ä½œçš„æ•°æ®æ ¹æœ¬å°±ä¸èƒ½ç¼“å­˜æ—¶ï¼›
* æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œï¼ˆcache lineï¼‰æ—¶ï¼›
* å¤„ç†å™¨æœ¬èº«å°±ä¸æ”¯æŒç¼“å­˜é”æ—¶ã€‚

> <small>é’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªæœºåˆ¶ï¼Œæˆ‘ä»¬é€šè¿‡ Intel å¤„ç†å™¨æä¾›äº†å¾ˆå¤š Lock å‰ç¼€çš„æŒ‡ä»¤æ¥å®ç°ã€‚ä¾‹å¦‚ï¼Œä½æµ‹è¯•å’Œä¿®æ”¹æŒ‡ä»¤ï¼šBTSã€BTRã€BTCï¼›äº¤æ¢æŒ‡ä»¤ XADDã€CMPXCHGï¼Œä»¥åŠå…¶ä»–ä¸€äº›æ“ä½œæ•°å’Œé€»è¾‘æŒ‡ä»¤ï¼ˆå¦‚ ADDã€ORï¼‰ç­‰ï¼Œè¢«è¿™äº›æŒ‡ä»¤æ“ä½œçš„å†…å­˜åŒºåŸŸå°±ä¼šåŠ é”ï¼Œå¯¼è‡´å…¶ä»–å¤„ç†å™¨ä¸èƒ½åŒæ—¶è®¿é—®å®ƒã€‚</small>

#### 2.3.2 Javaå¦‚ä½•å®ç°åŸå­æ“ä½œï¼ˆCASï¼‰

å…¶å®å°±æ˜¯AtomicXXXã€‚æˆ‘ä»¬å†™ä¸€ä¸ªè®¡æ•°å™¨æ¥æ¯”è¾ƒä¸€ä¸‹çº¿ç¨‹å®‰å…¨å’Œéçº¿ç¨‹å®‰å…¨çš„åŒºåˆ«ã€‚

é¦–å…ˆï¼Œéœ€è¦ä¸¤ä¸ªå˜é‡ã€‚ä¸€ä¸ªæ˜¯çº¿ç¨‹å®‰å…¨çš„æ•´æ•°ï¼Œä¸€ä¸ªæ˜¯éçº¿ç¨‹å®‰å…¨çš„æ•´æ•°ï¼š

```kotlin
class AtomCounter {  
    // Thread safe counter  
    private val atomicInteger = AtomicInteger(0)  
    // Thread unsafe counter  
    private var i = 0
}
```

ç„¶åï¼Œå®šä¹‰ä¸¤ä¸ªæ–¹æ³•ã€‚ä¸€ä¸ªå¯¹çº¿ç¨‹å®‰å…¨çš„æ•´æ•°ç´¯åŠ ï¼Œå¦ä¸€ä¸ªå¯¹éçº¿ç¨‹å®‰å…¨çš„æ•´æ•°ç´¯åŠ ï¼š

```kotlin
class AtomCounter {  
    // Thread safe counter  
    private val atomicInteger = AtomicInteger(0)  
    // Thread unsafe counter  
    private var i = 0  
  
    private fun safeCount() {  
        while (true) {  
            var i = atomicInteger.get()  
            val success = atomicInteger.compareAndSet(i, ++i)  
            if (success) break  
        }  
    }  
  
    private fun unsafeCount() {  
        i++  
    } 
}
```

è¿™é‡Œè¦æ³¨æ„çº¿ç¨‹å®‰å…¨çš„ç´¯åŠ è¿‡ç¨‹ã€‚ç”±äºå¤šçº¿ç¨‹å¹¶å‘è¿‡ç¨‹ä¸­ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨è¿›è¡Œç´¯åŠ çš„æ—¶å€™ä¼šå‡ºç°ç«äº‰ï¼Œæ‰€ä»¥ä¸èƒ½åªç´¯åŠ ï¼Œè¿˜è¦å…ˆæ¯”è¾ƒä¸€ä¸‹ï¼Œå½“ç´¯åŠ æˆåŠŸä¹‹åæ‰é€€å‡ºï¼Œå¦åˆ™**ä½¿ç”¨å¾ªç¯**ä¸æ–­å°è¯•ç´¯åŠ ã€‚è¿™æ ·æ‰èƒ½ä¿è¯**ä»»æ„çº¿ç¨‹çš„ä»»æ„ä¸€ä¸ªç´¯åŠ ä»»åŠ¡éƒ½èƒ½æ‰§è¡ŒæˆåŠŸ**ã€‚

æœ€åæµ‹è¯•ä¸€ä¸‹ã€‚æˆ‘ä»¬ä½¿ç”¨100ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªListé‡Œé¢å¡100ä¸ªçº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹çš„ä»»åŠ¡éƒ½æ˜¯ï¼š

* å¾ªç¯ç´¯åŠ `atomicInteger`10000æ¬¡ï¼›
* å¾ªç¯ç´¯åŠ `i`10000æ¬¡ã€‚

```kotlin
companion object {  
    fun test() {  
        val cas = AtomCounter()  
        val threads = ArrayList<Thread>(600)  // 600è¿™ä¸ªæ•°å­—ä¸é‡è¦
        val start = System.currentTimeMillis()  
        repeat(100) { // thread count  
            val t = Thread {  
                for (i in 0 until 10000) {  
                    cas.safeCount()  
                    cas.unsafeCount()  
                }  
            }  
            threads.add(t)  
        }  
        for (t in threads) {  
            t.start()  
        }  
        // Wait all threads to finish.  
        for (t in threads) {  
            try {  
                t.join()  
            } catch (e: InterruptedException) {  
                e.printStackTrace()  
            }  
        }  
        println("unsafe res: ${cas.i}")  
        println("safe res: ${cas.atomicInteger}")  
        println("time: ${System.currentTimeMillis() - start} ms")  
    }  
}
```

æˆ‘ä»¬å¤šæ‰§è¡Œå‡ æ¬¡ï¼Œçœ‹çœ‹ç»“æœï¼š

```
unsafe res: 996511
safe res: 1000000
time: 131 ms

unsafe res: 995692
safe res: 1000000
time: 134 ms

unsafe res: 992205
safe res: 1000000
time: 127 ms
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸‰æ¬¡æ‰§è¡Œç»“æœä¸­ï¼Œéçº¿ç¨‹å®‰å…¨çš„ç‰ˆæœ¬æ¯æ¬¡çš„ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œå¯è§å®ƒå¹¶æ²¡æœ‰å¾ˆå¥½åœ°æ§åˆ¶å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µï¼›è€Œä½¿ç”¨äº†AtomicIntegerä¹‹åï¼Œæ— è®ºæ€ä¹ˆæ‰§è¡Œï¼Œéƒ½æ˜¯100ä¸ªçº¿ç¨‹æ¯ä¸ªç´¯åŠ äº†10000æ¬¡ï¼Œæœ€åçš„ç»“æœä¸€ç›´éƒ½æ˜¯1000000ã€‚

---

æ¥ä¸‹æ¥ï¼Œè®²è®²ä¸ºä»€ä¹ˆè¦ç”¨å¾ªç¯ã€‚æˆ‘ä»¬å¦‚æœæŠŠçº¿ç¨‹å®‰å…¨çš„ç‰ˆæœ¬è¿™ä¹ˆå†™ï¼š

```kotlin
private fun safeCount2() {  
    atomicInteger.set(atomicInteger.get() + 1)  
}
```

é‚£ä¹ˆæ‰§è¡Œå‡ æ¬¡ä½ å°±ä¼šçœ‹åˆ°ï¼Œå’Œéçº¿ç¨‹å®‰å…¨çš„ç‰ˆæœ¬æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚å¦‚æœæ”¹æˆä¸‹é¢çš„æ ·å­ï¼Œå°±æ˜¯ä»…ä»…æŠŠwhileå¾ªç¯å»æ‰ï¼Œä¹Ÿæ˜¯ä¸è¡Œçš„ï¼š

```kotlin
private fun safeCount2() {  
    val i = atomicInteger.get()  
    atomicInteger.compareAndSet(i, i + 1)
}
```

å¦‚æœæƒ³ä¸ç”¨å¾ªç¯è¿™ä¹ˆéº»çƒ¦ï¼Œå…¶å®AtomicåŒ…é‡Œæœ‰ä¸ªåŸå­è‡ªå¢çš„æ–¹æ³•ï¼š

```kotlin
private fun safeCount2() {  
    atomicInteger.incrementAndGet()  
}
```

è¿™æ ·å°±åªéœ€è¦ä¸€å¥è¯å°±èƒ½æ§åˆ¶å¹¶å‘äº†ã€‚ä½†æ˜¯è¦è®°ä½ï¼Œè¿™é‡Œçš„`incrementAndGet()`æ–¹æ³•**æœ¬è´¨ä¸Šè¿˜æ˜¯ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼å»å®ç°çš„**ã€‚

- [ ] #TODO è¿™é‡Œçš„è¿‡ç¨‹ï¼Œä»¥åŠCASå†…éƒ¨çš„åŸç†ï¼Œä¹‹åè¦ç ”ç©¶ä¸€ä¸‹ã€‚

---

CASè¿™å¥½é‚£å¥½ï¼Œä¹Ÿæ€»ä¼šå‡ºç°é—®é¢˜ã€‚æœ‰ä¸‰ä¸ªéå¸¸ç»å…¸çš„é—®é¢˜ï¼š

1. ABAé—®é¢˜
2. å¾ªç¯æ—¶é—´é•¿ï¼Œå¼€é”€å¤§
3. åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ

- [>] ABAé—®é¢˜

ä»ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬ä¸éš¾çŒœå‡º`compareAndSet()`è¿™ä¸ªæ–¹æ³•å†…éƒ¨å¤§è‡´çš„æ‰§è¡Œæ­¥éª¤ã€‚å‡è®¾içš„å€¼åŸæ¥æ˜¯2ï¼Œæˆ‘ä»¬æƒ³è¦æŠŠä»–å˜æˆ3çš„è¯ï¼š

1. çœ‹çœ‹ç°åœ¨çš„å€¼æ˜¯å‡ ï¼›
2. å¦‚æœæ˜¯2çš„è¯ï¼Œå°±è®¤ä¸ºå®ƒæ²¡å‘ç”Ÿå˜åŒ–ï¼ŒæŠŠå®ƒå˜æˆ3ï¼Œè¿”å›trueï¼›
3. å¦‚æœä¸æ˜¯2çš„è¯ï¼Œå°±è®¤ä¸ºå®ƒå‘ç”Ÿäº†å˜åŒ–ï¼Œè¿”å›falseè¡¨ç¤ºæ“ä½œå¤±è´¥ã€‚

è¿™ä¸ªæ­¥éª¤çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³æƒ³è¿™æ ·çš„ä¸€ä¸ªæƒ…å†µã€‚ä¸€ä¸ªçº¿ç¨‹ç…äº†ä¸€çœ¼è¿™ä¸ªiï¼Œå‘ç°å®ƒæ˜¯2ã€‚æ­¤æ—¶å®ƒç†æ‰€å½“ç„¶åœ°è®¤ä¸ºï¼Œiæ²¡æœ‰å‘ç”Ÿè¿‡å˜åŒ–ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯åœ¨å®ƒâ€œç…è¿™ä¸€çœ¼â€ä¹‹å‰ï¼Œå…¶å®ƒçš„çº¿ç¨‹**å…ˆæŠŠè¿™ä¸ªiä»2æ”¹æˆäº†100ï¼ŒåˆæŠŠå®ƒä»100æ”¹å›äº†2**ã€‚è¿™æ ·è™½ç„¶ç»“æœä¸Šæ¥è¯´æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯äº‹å®æ˜¯**iå·²ç»ç¡®ç¡®å®å®è¢«å…¶å®ƒçš„å˜é‡ä¿®æ”¹è¿‡äº†**ã€‚

è™½ç„¶çœ‹èµ·æ¥è¿™æ ·çš„é—®é¢˜ä¸ä¼šå¸¦æ¥ä»€ä¹ˆä¸¥é‡çš„åæœï¼Œä½†äº‹å®å¹¶ä¸æ˜¯è¿™æ ·ã€‚å¦‚æœåœ¨æˆ‘â€œç…è¿™ä¸€çœ¼â€ä¹‹å‰ï¼Œå…¶å®ƒçº¿ç¨‹è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¿®æ”¹å›æ¥çš„æ“ä½œï¼Œ**ä½†æ˜¯è¿™ä¸ªæ“ä½œæœ¬èº«å°±æ˜¯ä¸€ä¸ªéæ³•çš„æ“ä½œ**ï¼Œè¿™å°±æ„å‘³ç€å³ä½¿æœ€åç»“æœæ˜¯å¥½çš„ï¼Œä½†æ˜¯å·²ç»äº§ç”Ÿäº†ä¸€æ¬¡éæ³•çš„è¡Œä¸ºï¼ˆè·Ÿæˆ‘å»è‡ªé¦–ğŸ•¶ï¼‰ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åŠ ä¸Šç‰ˆæœ¬å·å°±å¥½äº†ã€‚æ¯æ¬¡ä¿®æ”¹è¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œéƒ½é¡ºå¸¦ç€æ›´æ–°ä¸€ä¸‹é™„å¸¦çš„ç‰ˆæœ¬å·ï¼Œç„¶åæ¯æ¬¡æ¯”è¾ƒçš„æ—¶å€™ä¸ä½†è¦æ¯”è¾ƒå€¼æ˜¯å¦ç›¸åŒï¼Œè¿˜è¦æ¯”è¾ƒç‰ˆæœ¬å·æ˜¯å¦ç›¸åŒã€‚

æ¯”å¦‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œiçš„å˜åŒ–æ˜¯è¿™æ ·çš„ï¼š

$$
2 \rightarrow 100 \rightarrow 2
$$

å¸¦ä¸Šç‰ˆæœ¬å·ä¹‹åï¼Œå°±æ˜¯è¿™æ ·çš„ï¼š

$$
2(1) \rightarrow 100(2) \rightarrow 2(3)
$$

å¦‚æœä¸€å¼€å§‹æˆ‘æ‹¿åˆ°çš„ç‰ˆæœ¬å·æ˜¯1ï¼Œç„¶åç»è¿‡å…¶å®ƒçº¿ç¨‹çš„å·é¸¡æ“ä½œä¹‹åå†ä¸€çœ‹ï¼Œè™½ç„¶å€¼ä¸€æ ·éƒ½æ˜¯2ï¼Œ*ä½†ç‰ˆæœ¬å·å’‹å˜æˆ3äº†*ï¼Ÿ**è‚¯å®šæ˜¯æœ‰äººè¶æˆ‘ä¸æ³¨æ„ç»™æ”¹äº†**ã€‚æ‰€ä»¥æˆ‘ç›´æ¥æŠ¥å‘Šå¤±è´¥å°±è¡Œäº†ï¼Œç­‰ä¸‹ä¸€æ¬¡å¾ªç¯çš„æ—¶å€™æˆ‘æ‹¿åˆ°çš„å°±æ˜¯æ–°çš„2(3)äº†ã€‚

- [>] å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§

å…¶å®ä»ä¸Šé¢çš„ä¾‹å­å•èƒ½çœ‹å‡ºæ¥ï¼Œè‡ªæ—‹çš„CASå°±çƒ‚åœ¨è‡ªæ—‹ã€‚æ¯æ¬¡å¤±è´¥ä¹‹åè¿˜è¦whileå¾ªç¯è·‘å›å»é‡æ–°è¯•ä¸€éï¼Œè¿™å°±å¾ˆåƒbusy waitingçš„æ€æƒ³äº†ã€‚ç„¶åæ˜¯ä¹¦ä¸Šçš„ä¸€äº›åºŸè¯ï¼Œçœ‹ä»–çš„æ„æ€ï¼Œå¥½åƒJVMè¿˜ä¸æ”¯æŒpauseæŒ‡ä»¤ï¼Œåªæ˜¯å¹»æƒ³æ—¶é—´è€Œå·²ã€‚

> <small><font color="yellow">å¦‚æœï¼ˆè¿™ä¸ªå¦‚æœå°±å¾ˆçµæ€§ï¼‰</font> JVM èƒ½æ”¯æŒå¤„ç†å™¨æä¾›çš„ pause æŒ‡ä»¤ï¼Œé‚£ä¹ˆæ•ˆç‡ä¼šæœ‰ä¸€å®šçš„æå‡ã€‚pause æŒ‡ä»¤æœ‰ä¸¤ä¸ªä½œç”¨ï¼šç¬¬ä¸€ï¼Œå®ƒå¯ä»¥å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤ï¼ˆde-pipelineï¼‰ï¼Œä½¿ CPU ä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„æ‰§è¡Œèµ„æºï¼Œå»¶è¿Ÿçš„æ—¶é—´å–å†³äºå…·ä½“å®ç°çš„ç‰ˆæœ¬ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šå»¶è¿Ÿæ—¶é—´æ˜¯é›¶ï¼›ç¬¬äºŒï¼Œå®ƒå¯ä»¥é¿å…åœ¨é€€å‡ºå¾ªç¯çš„æ—¶å€™å› å†…å­˜é¡ºåºå†²çªï¼ˆMemory Order Violationï¼‰è€Œå¼•èµ· CPU æµæ°´çº¿è¢«æ¸…ç©ºï¼ˆCPU Pipeline Flushï¼‰ï¼Œä»è€Œæé«˜ CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚</small>

- [>] åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ

è¿˜æ˜¯ä¸Šé¢çš„`atomicInteger`ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ•´æ•°å¯¹å§ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨ä¸€æ¬¡CASæ“ä½œä¸­æ“ä½œå¤šä¸ªå…±äº«å˜é‡ã€‚å› æ­¤ï¼Œå¦‚æœæƒ³æ“ä½œå¤šä¸ªå˜é‡ï¼Œè¦ä¹ˆä½¿ç”¨é”ï¼Œè¦ä¹ˆå°†å¤šä¸ªå˜é‡åˆå¹¶ã€‚æ¯”å¦‚AtomicReferenceå°±å¯ä»¥å°†å¤šä¸ªå˜é‡å¡åˆ°ä¸€ä¸ªå¯¹è±¡é‡Œæ“ä½œã€‚

```ad-note
title: ä½¿ç”¨é”æœºåˆ¶å®ç°åŸå­æ“ä½œ

é”æœºåˆ¶ä¿è¯äº†åªæœ‰è·å¾—é”çš„çº¿ç¨‹æ‰èƒ½å¤Ÿæ“ä½œé”å®šçš„å†…å­˜åŒºåŸŸã€‚JVM å†…éƒ¨å®ç°äº†å¾ˆå¤šç§é”æœºåˆ¶ï¼Œæœ‰åå‘é”ã€è½»é‡çº§é”å’Œäº’æ–¥é”ã€‚æœ‰æ„æ€çš„æ˜¯é™¤äº†åå‘é”ï¼ŒJVM å®ç°é”çš„æ–¹å¼éƒ½ç”¨äº†å¾ªç¯ CASï¼Œå³å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥è·å–é”ï¼Œå½“å®ƒé€€å‡ºåŒæ­¥å—çš„æ—¶å€™ä½¿ç”¨å¾ªç¯ CAS é‡Šæ”¾é”ã€‚
```

---

```dataviewjs
const pages = dv.pages('"Study Log/java_kotlin_study/concurrency_art"')
let nextChapterHead = undefined
let res = undefined
const current = dv.current()
for (let page of pages) {
	if (page.chapter_root == true && page.order == Number(current.chapter) + 1) {
		console.log("found next head: " + page.name)
		nextChapterHead = page
		continue
	}
	if (page.chapter == undefined || page.chapter != current.chapter) {
		console.log("not current chapter: " + page.file.name)
		continue
	}
	if (page.order == Number(current.order) + 1) {
		res = page
	}
}
console.log("res: " + res)
console.log("next: " + nextChapterHead)
if (res == undefined) {
	res = nextChapterHead
}
let text = ""
if (res != undefined) {
	const path = res.file.path
	const title = res.title
	const decoLink = "[[" + path + "|" + title + "]]"
	text = "Next Article: " + decoLink
} else {
	text = "æ—…é€”çš„ç»ˆç‚¹ï¼"
}
dv.el("p", text, { attr: { align: "right" } })
```