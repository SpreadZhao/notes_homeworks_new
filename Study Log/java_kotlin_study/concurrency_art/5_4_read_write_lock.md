---
title: 5.4 è¯»å†™é”
chapter: "5"
order: "4"
---

## 5.4 è¯»å†™é”

å…¶å®æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡è¯»å†™é”äº†ï¼Œåœ¨æœ¬ç« çš„[[Study Log/java_kotlin_study/concurrency_art/5_2_aqs#5.2.2.4 å…±äº«å¼è·å–|5_2_aqs]]ã€‚è¯»å†™é”å°±æ˜¯ç”¨è¯»çš„æ–¹å¼å’Œå†™çš„æ–¹å¼å»è®¿é—®åŒä¸€æŠŠé”ï¼Œæ¥è§£å†³ã€è¯»å†™è€…é—®é¢˜ã€ï¼š

* å¦‚æœæœ‰è¯»è€…ï¼Œé‚£ä¹ˆåªæœ‰è¯»è€…èƒ½è®¿é—®ï¼Œå…¶å®ƒå†™è€…ä¸èƒ½è®¿é—®ï¼›
* å¦‚æœæœ‰å†™è€…ï¼Œé‚£ä¹ˆå…¶å®ƒè¯»è€…å’Œå†™è€…éƒ½ä¸èƒ½è®¿é—®ã€‚

æˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼Œè¯»å†™é”å…¶å®æ˜¯ä¸€æŠŠé”ï¼Œä½†æ˜¯è¯»å†™çš„è®¿é—®æ–¹å¼ä¸ä¸€æ ·è€Œå·²ã€‚å…¶ä¸­è¯»è€…æ˜¯å…±äº«å¼è®¿é—®ï¼Œå†™è€…æ˜¯ç‹¬å å¼è®¿é—®ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ç¨å¾®çœ‹ä¸€ä¸‹concurrentåŒ…çš„è¯»å†™é”å®ç°ReentrantReadWriteLockï¼Œä¼šå‘ç°å¹¶ä¸æ˜¯è¿™æ ·ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20240304232804.png]]

æˆ‘ä»¬å‘ç°ï¼Œè¯»å†™é”é‡Œé¢æœ‰ä¸¤ä¸ªLockï¼Ÿä¸ºå•¥æ˜¯è¿™æ ·ï¼Ÿå…¶å®ï¼Œå¦‚æœæˆ‘ä»¬ç¨å¾®ç»†çœ‹ä¸€ç‚¹ï¼Œå°±èƒ½å‘ç°ï¼Œå®é™…ä¸Šè¿˜æ˜¯åŒä¸€æŠŠé”ï¼š

```java
// è¯»é”çš„æ„é€ 
protected ReadLock(ReentrantReadWriteLock lock) {
	sync = lock.sync;
}

// å†™é”çš„æ„é€ 
protected WriteLock(ReentrantReadWriteLock lock) {
	sync = lock.sync;
}

// è¯»å†™é”çš„æ„é€ 
public ReentrantReadWriteLock(boolean fair) {
	sync = fair ? new FairSync() : new NonfairSync();
	readerLock = new ReadLock(this);
	writerLock = new WriteLock(this);
}
```

æˆ‘ä»¬å‘ç°ï¼Œæœ€ç»ˆä½¿ç”¨çš„Syncå…¶å®éƒ½æ˜¯åŒä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**è¯»å†™é”ä¾èµ–äºåŒä¸€ä¸ªAQSç»´æŠ¤çš„çŠ¶æ€**ã€‚é‚£ä¸ç®¡ä½ Lockæ€ä¹ˆåˆ†ï¼Œæœ€åç®¡ç†çš„éƒ½æ˜¯åŒä¸€ä¸ªçŠ¶æ€ã€‚

### 5.4.1 ä½¿ç”¨ä¾‹å­

ç¨å¾®çœ‹ä¸€çœ‹ä½¿ç”¨ï¼Œéå¸¸ç®€å•ï¼š

```java
object TestReadWriteLock {

    private val map = HashMap<String, Any>()
    private val rwl = ReentrantReadWriteLock()
    private val rl = rwl.readLock()
    private val wl = rwl.writeLock()

    operator fun get(key: String): Any? {
        rl.lock()
        try {
            println("read locked by ${Thread.currentThread().name}")
            return map[key]
        } finally {
            rl.unlock()
        }
    }

    operator fun set(key: String, value: Any): Any? {
        wl.lock()
        try {
            println("write locked by ${Thread.currentThread().name}")
            return map.put(key, value)
        } finally {
            wl.unlock()
        }
    }

    fun clear() {
        wl.lock()
        try {
            map.clear()
        } finally {
            wl.unlock()
        }
    }
}
```

æˆ‘ä»¬è®©HashMapçš„è®¿é—®åŠ ä¸Šè¯»å†™é”ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå®ç°ConcurrentHashMapçš„åŠŸèƒ½äº†ã€‚

- [ ] #TODO ConcurrentHashMapå†…éƒ¨æ˜¯ç”¨synchronizedä¿è¯å¹¶å‘å®‰å…¨çš„ã€‚é‚£ä¹ˆç”¨è¯»å†™é”çš„æ–¹å¼å’ŒConcurrentHashMapå“ªç§æ›´å¥½ï¼Ÿâ• 2024-03-04 â« 

### 5.4.2 è¯»å†™é”å®ç°åˆ†æ

ä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ŒReentrantReadWriteLockæ—¢æ”¯æŒè¯»å†™é”ï¼Œä¹Ÿæ”¯æŒå¯é‡å…¥ï¼ˆç”šè‡³æ”¯æŒå…¬å¹³ & éå…¬å¹³ï¼‰ã€‚é‚£è¿™é‡Œå°±å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼šæ—¢ç„¶å¯é‡å…¥ï¼Œé‚£æˆ‘å°±è¦çŸ¥é“ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å¾—äº†å¤šå°‘æ¬¡è¿™ä¸ªé”ã€‚ä½†æ˜¯ï¼Œé”åªæœ‰ä¸€æŠŠï¼Œä½†æ˜¯è·å–çš„æ–¹å¼æœ‰è¯»å’Œå†™ä¸¤ç§ã€‚**é‚£ä¹ˆæˆ‘å°±è¦èƒ½è¡¨ç¤ºä¸¤ç§çŠ¶æ€åˆ†åˆ«è¢«è·å–äº†å¤šå°‘æ¬¡**ï¼Œ<fieldset class="inline"><legend class="small">ğŸ’¬</legend>å³ä½¿è¿™ä¸¤ç§çŠ¶æ€æ˜¯ä¸ä¼šåŒæ—¶å‡ºç°çš„</fieldset>ã€‚

> [!comment] å³ä½¿è¿™ä¸¤ç§çŠ¶æ€æ˜¯ä¸ä¼šåŒæ—¶å‡ºç°çš„
> å¦‚æœæ˜¯å†™çŠ¶æ€ï¼Œé‚£ä¹ˆè¯»æ˜¯ä¸å¯èƒ½æœ‰çš„ï¼›å¦‚æœæ˜¯è¯»çŠ¶æ€ï¼Œé‚£ä¹ˆä¹Ÿåªèƒ½æœ‰å…¶å®ƒçš„è¯»ï¼Œä¸èƒ½æœ‰å†™ã€‚

è€Œæˆ‘ä»¬çŸ¥é“ï¼ŒAQSå†…éƒ¨å°±æ˜¯ç”¨ä¸€ä¸ªvolatileçš„intæ¥ç»´æŠ¤è¿™æŠŠé”çš„å…¨éƒ¨çŠ¶æ€çš„ã€‚é‚£ä¹ˆï¼Œå’‹ç”¨ä¸€ä¸ªintæ¥è¡¨ç¤ºä¸¤ç§çŠ¶æ€ä¸‹çš„æƒ…å†µï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ**æŠŠintç»™æ‹†å¼€**ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Pasted image 20240309225759.png]]

ä¸€ä¸ªintæ˜¯4ä¸ªbyteï¼Œ32ä¸ªbitã€‚æ‰€ä»¥æ‹†æˆé«˜16ä½å’Œä½16ä½ã€‚é«˜çš„è¡¨ç¤ºè¯»çŠ¶æ€ï¼Œä½çš„è¡¨ç¤ºå†™çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œä¹‹åå¯¹äºè¿™æŠŠè¯»å†™é”çš„æ“ä½œå°±æ˜¯è¿™æ ·çš„ï¼š

* è·å–å†™é”ï¼šå°†è¿™ä¸ªå€¼+1ï¼›
* è·å–è¯»é”ï¼šå°†è¿™ä¸ªå€¼+(1<<16)ï¼›
* æŸ¥çœ‹è¯»é”çš„è·å–çŠ¶æ€ï¼šå°†è¿™ä¸ªå€¼å’Œ0xFFFF0000æŒ‰ä½ä¸ï¼ˆå–é«˜16ä½ï¼‰ï¼›
* æŸ¥çœ‹å†™é”çš„è·å–çŠ¶æ€ï¼šå°†è¿™ä¸ªå€¼å’Œ0x0000FFFFæŒ‰ä½ä¸ï¼ˆå–ä½16ä½ï¼‰ã€‚

å¤©æ‰ï¼ä¸€ä¸ªintä¸å¤Ÿç”¨ï¼Œå°±æ‹†æˆä¸¤ä¸ªåŠä¸ªintï¼

åŸºäºè¿™ä¸ªæ€æƒ³ï¼Œæˆ‘ä»¬å†æ¥çœ‹è¯»å†™é”çš„å†…éƒ¨å®ç°ï¼Œå°±ä¼šæ¯”è¾ƒç®€å•äº†ã€‚

> [!attention] ç‰¢è®°
> * è¯»é”åˆ©ç”¨çš„æ˜¯AQSçš„å…±äº«è·å–èƒ½åŠ›ï¼›
> * å†™é”åˆ©ç”¨çš„æ˜¯AQSçš„ç‹¬å è·å–èƒ½åŠ›ã€‚

ä¸‹é¢ï¼Œå’Œé‡å…¥é”ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿæ¥ç»™è¯»å†™é”ç”»ä¸€ä¸ªå›¾ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œè¯»å†™é”åŒæ—¶æ”¯æŒï¼š

* å¯é‡å…¥ï¼›
* å…¬å¹³ & éå…¬å¹³ï¼›
* è¯» & å†™ã€‚

æ‰€ä»¥ï¼Œè¿™ä¸ªå›¾ä¼šæ¯”è¾ƒå¤æ‚ï¼š

![[Study Log/java_kotlin_study/concurrency_art/resources/Drawing 2024-03-10 13.58.31.excalidraw.svg]]

è¿™å¹…å›¾æ¯”[[Study Log/java_kotlin_study/concurrency_art/5_3_reentrant_lock#5.3.2 å…¬å¹³ & éå…¬å¹³|ä¹‹å‰çš„é‚£å¼ ]]æ”¹è¿›äº†ä¸€äº›ï¼Œæ›´å¥½çœ‹æ‡‚ã€‚æˆ‘ä»¬å‘ç°ï¼Œæ— è®ºé”æœ¬èº«å¤šä¹ˆå¤æ‚ï¼Œè¿™å¥—æ¨¡æ¿æ–¹æ³•çš„è§„åˆ™æ˜¯ä¸å˜çš„ï¼š**Lockçš„å®ç°ç±»éœ€è¦åœ¨å®ç°çš„æ¥å£ä¸­ï¼ˆæ¯”å¦‚`lock()`ï¼Œ`unlock()`ç­‰ï¼‰è°ƒç”¨AQSæä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼ˆæ¯”å¦‚`acquire()`, `acquireShared()`ï¼‰ï¼Œç„¶åè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè‡ªåŠ¨èµ°åˆ°æˆ‘ä»¬çš„AQSå®ç°ç±»ä¸­ï¼ˆæ¯”å¦‚`tryAcquire()`, `tryAcquireShared()`ï¼‰**ã€‚

> [!attention]
> è¿™é‡Œä¾ç„¶è¦æ³¨æ„æˆ‘ä»¬å¼ºè°ƒè¿‡çš„ç‚¹ï¼šAQSå¹¶æ²¡æœ‰ç»™`tryLock()`æä¾›ä¸€ä¸ªèƒ½è°ƒç”¨çš„æ¨¡æ¿æ–¹æ³•ï¼Œå› ä¸ºå°è¯•è·å¾—é”åªä¼šå»å°è¯•ä¸€æ¬¡ï¼Œä¸éœ€è¦ä¾èµ–AQSå†…éƒ¨çš„ç­‰å¾…é˜Ÿåˆ—ã€‚åªä¸è¿‡ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒAQSå†…éƒ¨çš„`tryAcquire()`åˆšå¥½å¯ä»¥ç”¨æ¥å®ç°`tryLock()`æ–¹æ³•ã€‚ä¸è¿‡ç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°ReentrantReadWriteLockæ²¡æœ‰é‡‡ç”¨è¿™ç§ç­–ç•¥ï¼ˆå…¶å®ä»ReentrantLockå¼€å§‹å°±å·²ç»ä¸æ˜¯è¿™ç§ç­–ç•¥äº†ï¼‰ã€‚

^7c2914

#### 5.4.2.1 å†™é”çš„è·å–

æˆ‘ä»¬é¦–å…ˆä»ç‹¬å å¼çš„å†™é”å¼€å§‹åˆ†æã€‚æˆ‘ä»¬å¯ä»¥å¤§è‡´çŒœæµ‹ä¸€ä¸‹å†™è·å–é”çš„ç­–ç•¥ï¼š

1. å¦‚æœæ²¡æœ‰ä»»ä½•äººè·å–ä»»ä½•é”ï¼Œç›´æ¥è·³åˆ°4ï¼Œå¦‚æœæœ‰äººè·å–é”ï¼Œèµ°2å’Œ3ï¼›
2. å¦‚æœæ­£åœ¨æœ‰äººè·å–è¯»é”ï¼Œé‚£ä¹ˆæˆ‘ä¸èƒ½å»è·å¾—ï¼›
3. å¦‚æœæ²¡äººè·å–è¯»é”ï¼Œé‚£å°±æ˜¯æœ‰äººåœ¨è·å–å†™é”ã€‚æ‰€ä»¥åªæœ‰å½“å‰è·å–å†™é”çš„äººå°±æ˜¯æˆ‘è‡ªå·±çš„æ—¶å€™ï¼Œæ‰èƒ½ç»§ç»­è·å¾—é”ï¼Œå¦åˆ™æˆ‘ä¹Ÿä¸èƒ½è·å¾—ï¼›
4. å°è¯•<fieldset class="inline"><legend class="small">ğŸ’¬</legend>ä½¿ç”¨CAS</fieldset>è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸäº†ï¼Œå°±æˆåŠŸï¼Œå¦åˆ™è¿˜æ˜¯å¤±è´¥ã€‚

> [!comment] ä½¿ç”¨CAS
> è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç»†èŠ‚é—®é¢˜éœ€è¦ææ¸…æ¥šï¼š**ä½¿ç”¨CASï¼Œè€Œä¸æ˜¯å¾ªç¯CAS**ã€‚åœ¨[[Study Log/java_kotlin_study/concurrency_art/5_2_aqs#5.2.3 å®æˆ˜ - TwinsLock|#5.2.3 å®æˆ˜ - TwinsLock]]çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°è¯•å†™äº†ä¸€ä¸ªå…±äº«å¼çš„ï¼Œèƒ½è¢«ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å–çš„ä¸å¯é‡å…¥çš„é”ã€‚æˆ‘ååˆ†å»ºè®®ä½ é‡æ–°è¯»ä¸€ä¸‹é‚£ä¸€èŠ‚ï¼Œææ¸…æ¥šé‚£ä¸ªæ—¶å€™æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ã€åœ¨èµ„æºæ•°>1çš„å…±äº«å¼é”ä¸­ï¼ŒCASå¤±è´¥ï¼Œå¹¶ä¸ç­‰äºè·å–é”å¤±è´¥ã€ã€‚å› ä¸ºå½“æ—¶æˆ‘ä»¬çš„stateæ˜¯ä¸º0ï¼Œ1ï¼Œ2çš„æ—¶å€™æˆç«‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å…ˆçœ‹çœ‹CASç»“æŸåçš„æ–°å€¼æ˜¯ä»€ä¹ˆï¼Œæ‰èƒ½åˆ¤æ–­é”æ˜¯å¦æˆåŠŸè·å–ã€‚ä½†æ˜¯åˆ°äº†è¿™ä¸ªç‹¬å å¼çš„é”ï¼Œä¸ºä»€ä¹ˆåˆå¯ä»¥ä½¿ç”¨CASè€Œä¸æ˜¯å¾ªç¯CASäº†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å›å¤´çœ‹ä¸€ä¸‹ä¹‹å‰æˆ‘[[Study Log/java_kotlin_study/concurrency_art/5_2_aqs#^4dc7b7|ä¸¾çš„ä¾‹å­]]ã€‚åœ¨èµ„æºæ•°ä¸º2çš„å…±äº«å¼é”ä¸­ï¼Œå¦‚æœæ˜¯åˆå§‹çŠ¶æ€ï¼Œä¸‰ä¸ªçº¿ç¨‹åŒæ—¶å»æŠ¢é”ï¼Œé‚£ä¹ˆç»“æœä¸€å®šæ˜¯ä¸¤ä¸ªçº¿ç¨‹è·å¾—ï¼Œä¸€ä¸ªçº¿ç¨‹æ²¡è·å¾—ã€‚å› æ­¤ä»…ä»…æ˜¯CASå¤±è´¥ä¸è¶³ä»¥è¯æ˜æˆ‘çœŸçš„æ²¡è·å¾—ï¼Œåªæ˜¯æœ‰äººåœ¨è·Ÿæˆ‘æŠ¢ï¼Œå¦‚æœæˆ‘é‡æ–°å°è¯•ï¼Œæ²¡å‡†å°±èƒ½è·å¾—äº†ã€‚ä½†æ˜¯å›å¤´æ¥çœ‹ç‹¬å å¼çš„é”ï¼Œå¦‚æœä¹Ÿæ˜¯ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶å»æŠ¢ï¼Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ**ä¸€å®šæ˜¯ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†ï¼Œä¸¤ä¸ªçº¿ç¨‹æ²¡è·å¾—**ã€‚é‚£ä¹ˆæ ¹æ®CASçš„ç‰¹ç‚¹æˆ‘ä»¬èƒ½çŸ¥é“ï¼Œæœ‰äººå¤±è´¥ï¼Œå°±ä¸€å®šæœ‰äººæˆåŠŸã€‚å› ä¸ºä¹‹æ‰€ä»¥æˆ‘å¤±è´¥ï¼Œå°±æ˜¯å› ä¸ºè·Ÿæˆ‘äº‰æŠ¢å»ä¿®æ”¹å€¼çš„æŸä¸€ä¸ªäººæœ€ç»ˆæˆåŠŸå°†stateç»™æ›´æ–°äº†ã€‚æ‰€ä»¥ï¼Œåœ¨ç‹¬å å¼çš„æƒ…å†µä¸‹ï¼Œ**CASå¤±è´¥å°±ä»£è¡¨è·å–é”å¤±è´¥**ï¼Œå› ä¸ºå³ä½¿æˆ‘å†æ€ä¹ˆå°è¯•ï¼Œä¹Ÿç»æ— å¯èƒ½è·å¾—ï¼Œå› ä¸ºå®ƒå·²ç»è¢«å…¶å®ƒæŸä¸ªäººç»™ç‹¬å äº†ã€‚åœ¨[[#5.4.2.2 è¯»é”çš„è·å–|åé¢]]æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°ï¼ŒReentrantReadWriteLockçš„è¯»é”åœ¨å°è¯•è·å–çš„æ—¶å€™é‡‡ç”¨çš„ä¹Ÿæ˜¯å¾ªç¯CASï¼Œå’Œæˆ‘ä»¬è‡ªå·±å®ç°çš„TwinsLockæ˜¯ä¸€è‡´çš„ã€‚

é™¤äº†ä¸Šé¢çš„è¿™å‡ æ¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ä¸€äº›äº‹æƒ…ã€‚åœ¨ä¹‹å‰ä»‹ç»ReentrantLockçš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ†æè¿‡è¿™æ ·çš„äº‹æƒ…ï¼šå³ä½¿æ˜¯å…¬å¹³é”ï¼Œåœ¨tryLock()çš„æ—¶å€™ä¹Ÿæ˜¯ç”¨çš„éå…¬å¹³å®ç°ã€‚åˆ°äº†è¯»å†™é”ä¸­ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„å¥—è·¯ï¼Œé‚£æ®µæ³¨é‡Šä¾ç„¶ä¹Ÿåœ¨è¿™é‡Œå‡ºç°äº†ã€‚æ‰€ä»¥ï¼Œå›å¤´çœ‹ä¸€ä¸‹ä¹‹å‰è¯´è¿‡çš„ï¼š[[#^7c2914]]ï¼Œåˆšæ‰è¯´çš„ã€ç¨åã€å°±æ˜¯ç°åœ¨ï¼

> å…¶å®ä¸æŠŠtryAcquire()ç›´æ¥æ¬åˆ°tryLock()ä¸­ä¸»è¦çš„åŸå› ï¼Œå°±æ˜¯å› ä¸ºè®¾è®¡è€…å¸Œæœ›å°è¯•è·å–é”èƒ½å¤Ÿè®©å…¬å¹³é”ä¹Ÿèƒ½æ‰“ç ´å…¬å¹³ã€‚

å†™é”çš„æœ€ç»ˆè·å–ï¼Œé€šè¿‡ä¸€å¼€å§‹çš„å›¾å°±çŸ¥é“ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°Syncä¸­çš„tryAcquire()æ–¹æ³•ï¼›è€Œå°è¯•è·å–é”ï¼Œå°±ä¼šèµ°å¦ä¸€å¥—å®ç°ã€‚ä½†æ˜¯ï¼ŒäºŒè€…çš„ä»£ç å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯é‚£ä¸ªæ‰“ç ´å…¬å¹³çš„è§„åˆ™ã€‚

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å†™é”tryLock()æœ€ç»ˆçš„å®ç°tryWriteLock()ï¼š

```java
/**
 * Performs tryLock for write, enabling barging in both modes.
 * This is identical in effect to tryAcquire except for lack
 * of calls to writerShouldBlock.
 */
@ReservedStackAccess
final boolean tryWriteLock() {
	Thread current = Thread.currentThread();
	int c = getState();
	if (c != 0) {
		int w = exclusiveCount(c);
		if (w == 0 || current != getExclusiveOwnerThread())
			return false;
		if (w == MAX_COUNT)
			throw new Error("Maximum lock count exceeded");
	}
	if (!compareAndSetState(c, c + 1))
		return false;
	setExclusiveOwnerThread(current);
	return true;
}
```

> [!comment]
> ä¸Šé¢çš„æ³¨é‡Šå’Œæˆ‘åˆšæ‰è¯´çš„ä¸€æ ·ï¼Œå’ŒtryAcquire()å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å…¬å¹³çš„æ‰“ç ´ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æ–¹æ³•æ²¡æœ‰è°ƒç”¨writerShouldBlock()ã€‚

å’Œé‚£å››æ­¥èµ°æ˜¯ä¸€æ ·çš„é€»è¾‘ï¼Œå°±ä¸å¤šè¯´äº†ã€‚ç„¶åçœ‹çœ‹tryAcquire()çš„é€»è¾‘ï¼š

```java
protected final boolean tryAcquire(int acquires) {
	/*
	 * Walkthrough:
	 * 1. If read count nonzero or write count nonzero
	 *    and owner is a different thread, fail.
	 * 2. If count would saturate, fail. (This can only
	 *    happen if count is already nonzero.)
	 * 3. Otherwise, this thread is eligible for lock if
	 *    it is either a reentrant acquire or
	 *    queue policy allows it. If so, update state
	 *    and set owner.
	 */
	Thread current = Thread.currentThread();
	int c = getState();
	int w = exclusiveCount(c);
	if (c != 0) {
		// (Note: if c != 0 and w == 0 then shared count != 0)
		if (w == 0 || current != getExclusiveOwnerThread())
			return false;
		if (w + exclusiveCount(acquires) > MAX_COUNT)
			throw new Error("Maximum lock count exceeded");
		// Reentrant acquire
		setState(c + acquires);
		return true;
	}
	if (writerShouldBlock() ||
		!compareAndSetState(c, c + acquires))
		return false;
	setExclusiveOwnerThread(current);
	return true;
}
```

å¯¹æ¯”ä¸€ä¸‹å¯ä»¥å‘ç°ï¼Œå…¶å®ƒçš„é€»è¾‘å‡ ä¹éƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ— éå¤šäº†ä¸€äº›è¾¹ç•Œçš„åˆ¤æ–­ï¼ˆæ¯”å¦‚`exclusiveCount(acquires)`ï¼‰ã€‚å”¯ä¸€ä¸åŒçš„å°±æ˜¯æœ€åå¦‚æœ`writerShouldBlock()`è¿”å›trueï¼Œé‚£ä¹ˆæˆ‘ä¹Ÿä¸èƒ½è·å¾—é”ã€‚è€Œè¿™é‡Œé¢å°±æ˜¯å…¬å¹³æ€§çš„åˆ¤æ–­ã€‚åœ¨ä¹‹å‰tryLock()ä¸­æ²¡æœ‰è°ƒç”¨å®ƒï¼Œå°±ç›¸å½“äºè¿™é‡Œæ°¸è¿œè¿”å›falseï¼Œä¹Ÿå°±æ˜¯ä¸å‚ä¸æ¡ä»¶åˆ¤æ–­äº†ã€‚

é‚£ä¹ˆè¿™é‡Œé¢çš„é€»è¾‘æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®éå¸¸ç®€å•ï¼Œæˆ‘ä»¬éƒ½èƒ½çŒœå‡ºæ¥ã€‚é¦–å…ˆï¼Œå¦‚æœæ˜¯éå…¬å¹³çš„é”ï¼Œè¿™ä¸ªæ–¹æ³•è‚¯å®šç›´æ¥è¿”å›falseï¼Œå› ä¸ºä¸éœ€è¦å…¬å¹³æ€§åˆ¤æ–­ï¼›è€Œå¦‚æœæ˜¯å…¬å¹³é”ï¼Œè¿˜è®°å¾—ä¹‹å‰è¯´ReentrantLockçš„æ—¶å€™å…¬å¹³æ˜¯æ€ä¹ˆæ¥çš„å—ï¼Ÿ[[Study Log/java_kotlin_study/concurrency_art/5_3_reentrant_lock#^d7044c|5_3_reentrant_lock]] ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå‰é¢æœ‰äººæ’ç€ï¼Œé‚£ä¹ˆæˆ‘å°±è®¤ä¸ºè·å–é”å·²ç»å¤±è´¥äº†ã€‚å› æ­¤ï¼š

```java
// FairSyncå¯¹äºwriterShouldBlock()çš„å®ç°
final boolean writerShouldBlock() {
	return hasQueuedPredecessors();
}

// NonfairSyncå¯¹äºwriterShouldBlock()çš„å®ç°
final boolean writerShouldBlock() {
	return false; // writers can always barge
}
```

å†™é”çš„é‡Šæ”¾ä¸[[Study Log/java_kotlin_study/concurrency_art/5_3_reentrant_lock#^reentrantrelease|ReentrantLockçš„é‡Šæ”¾]]è¿‡ç¨‹å‡ ä¹ä¸€è‡´ï¼š

> <small>å†™é”çš„é‡Šæ”¾ä¸ ReentrantLock çš„é‡Šæ”¾è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œæ¯æ¬¡é‡Šæ”¾å‡å‡å°‘å†™çŠ¶æ€ï¼Œå½“å†™çŠ¶æ€ä¸º 0 æ—¶è¡¨ç¤ºå†™é”å·²è¢«é‡Šæ”¾ï¼Œä»è€Œç­‰å¾…çš„è¯»å†™çº¿ç¨‹èƒ½å¤Ÿç»§ç»­è®¿é—®è¯»å†™é”ï¼ŒåŒæ—¶å‰æ¬¡å†™çº¿ç¨‹çš„ä¿®æ”¹å¯¹åç»­è¯»å†™çº¿ç¨‹å¯è§ã€‚</small>

- [ ] #TODO [[Study Log/java_kotlin_study/concurrency_art/5_2_aqs#^7548dc|5_2_aqs]] å…¶ä¸­ä¸€ä¸ªåŸå› ã€‚é‡Šæ”¾é”çš„æ—¶å€™ä¸éœ€è¦CASï¼Œé‚£ä¹ˆå°±è¦ä¿è¯æˆ‘é‡Šæ”¾åçš„ç»“æœå¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚è€Œè¿™ä¸ªvolatileå°±ä¿è¯äº†è¿™ä¸€ç‚¹ã€‚ â• 2024-03-10 â« 

#### 5.4.2.2 è¯»é”çš„è·å–

å…³äºè¯»é”ï¼Œå®ƒçš„å®ç°çœ‹èµ·æ¥éå¸¸å¤æ‚ã€‚è¿™æ˜¯å› ä¸ºç”±äºè¯»é”æ˜¯å…±äº«å¼çš„ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦è·å–åˆ°æ¯ä¸ªçº¿ç¨‹å…³äºè¯»é”çš„ä¿¡æ¯ï¼Œå°±æ¯”è¾ƒå›°éš¾ã€‚

æ¯”å¦‚ï¼Œç°åœ¨çš„stateå°±æ˜¯ä¸€ä¸ªintï¼Œé‚£ä¹ˆè¿™é‡Œçš„é«˜16ä½è‚¯å®šè®°å½•çš„å°±æ˜¯æ‰€æœ‰çº¿ç¨‹åŠ èµ·æ¥ï¼Œä¸€å…±è·å–äº†å¤šå°‘æ¬¡è¯»é”ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘æƒ³çŸ¥é“æ¯ä¸ªçº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°å‘¢ï¼Ÿè¿™ç”¨ç®€å•å¯¹intçš„æ“ä½œå°±åŠä¸åˆ°äº†ã€‚jdké‡‡ç”¨çš„åšæ³•æ˜¯ï¼Œä½¿ç”¨ThreadLocalä¿å­˜æ¯ä¸ªçº¿ç¨‹å¯¹äºè¯»é”çš„è·å–ä¿¡æ¯ã€‚åŠ ä¸Šäº†è¿™äº›æ“ä½œï¼Œå°±ä½¿å¾—è¯»é”çš„è·å–æµç¨‹çœ‹èµ·æ¥è¶…çº§å¤æ‚ã€‚

> [!comment]
> ç”±äºå†™é”æ˜¯ç‹¬å å¼çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ä»€ä¹ˆæ¯ä¸ªçº¿ç¨‹è·å–äº†å¤šå°‘æ¬¡è¿™ç§ä¿¡æ¯ï¼Œåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å–ï¼Œé‚£è¿˜ThreadLocalå¹²é¸¡æ¯›ã€‚

è¿˜æœ‰ä¸€ç‚¹ï¼Œå’Œæˆ‘ä»¬å®ç°çš„TwinsLockä¸åŒï¼ŒTwinsLockçš„æ€»èµ„æºæ•°æ˜¯2ï¼Œæ‰€ä»¥å¥½çš„ç­–ç•¥æ˜¯è·å–é”çš„æ—¶å€™ï¼Œä»2å¾€ä¸‹å‡ï¼›ä½†æ˜¯è¯»é”ä¸ä¸€æ ·ï¼Œæ²¡æœ‰èµ„æºé™åˆ¶ï¼Œåªè¦æ²¡äººå†™ï¼Œé‚£è°éƒ½èƒ½è¯»ã€‚æ‰€ä»¥è¿™é‡Œçš„ç­–ç•¥æ˜¯è¯»çŠ¶æ€ä»0å¾€ä¸ŠåŠ ã€‚ä¸è¿‡ï¼Œå¦‚æœè¶…è¿‡äº†16bitçš„æœ€å¤§é™åˆ¶ï¼Œè‚¯å®šè¿˜æ˜¯ä¼šæŠ¥é”™çš„ã€‚

æ—¢ç„¶å¦‚æ­¤ï¼Œè·å–é”æˆåŠŸçš„æ¡ä»¶æ˜¯å•¥ï¼Ÿå¦‚æœä¸è€ƒè™‘æº¢å‡ºçš„è¯ï¼Œåªè¦å¾ªç¯CASæˆåŠŸäº†ï¼Œå°±æ˜¯è·å–é”æˆåŠŸäº†ã€‚æ‰€ä»¥ï¼Œé€šè¿‡ä»£ç æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°ï¼Œæ— è®ºæ˜¯tryReadLock()è¿˜æ˜¯tryAcquireShared()ï¼Œåªè¦CASæˆåŠŸäº†ï¼Œåªæœ‰è¿”å›~~true~~æˆåŠŸçš„å¯èƒ½ã€‚

è¿™é‡Œå°±åªåˆ†æä¸€ä¸‹tryLock()é‚£ä¸€ä¾§çš„å®ç°å§ï¼Œè¿™é‡Œæ¸…æ™°ä¸€äº›ã€‚

é¦–å…ˆï¼Œå¾—åˆ°å½“å‰çš„çŠ¶æ€ï¼š

```java
int c = getState();
```

å¦‚æœæœ‰**åˆ«**äººè·å¾—äº†**å†™**é”ï¼Œé‚£ä¹ˆæˆ‘ä¸èƒ½è·å¾—è¯»é”ï¼š

```java
if (exclusiveCount(c) != 0 &&
	getExclusiveOwnerThread() != current)
	return false;
```

å¦‚æœå½“å‰è¯»é”çš„çŠ¶æ€å·²ç»çˆ†äº†ï¼ˆè¶…è¿‡16bitï¼‰ï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºé”™è¯¯ï¼š

```java
int r = sharedCount(c);
if (r == MAX_COUNT)
	throw new Error("Maximum lock count exceeded");
```

æœ€åï¼Œå¦‚æœCASæˆåŠŸï¼Œé‚£ä¹ˆè¿”å›trueï¼Œå¦åˆ™ä»å¤´å¼€å§‹ï¼š

```java
if (compareAndSetState(c, c + SHARED_UNIT)) {
	... ... // å’ŒThreadLocalæœ‰å…³çš„æ“ä½œï¼ŒæŒ‰ä¸‹ä¸è¡¨
	return true;
}
```

ä»¥ä¸Šå‡ æ­¥è¢«åŒ…è£¹åœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ï¼Œæ­£åº”äº†ä¹‹å‰åˆ†æçš„å¾ªç¯CASã€‚

#### 5.4.2.3 è¯»å†™é”çš„é™çº§

è¯»å†™é”æ˜¯æ”¯æŒé™çº§çš„ï¼šå†™é” -> è¯»é”ã€‚ä½†æ˜¯ä¸æ”¯æŒå‡çº§ã€‚è¿™é‡Œçš„æ”¯æŒå’Œä¸æ”¯æŒæŒ‡çš„æ˜¯ä»å®ç°çš„è§’åº¦ï¼Œå®ƒå¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªé™çº§æˆ–è€…å‡çº§çš„æ¥å£ã€‚æ‰€ä»¥ï¼Œé™çº§æ“ä½œå¾—æˆ‘ä»¬è‡ªå·±æ¥å®Œæˆã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å…ˆè·å¾—å†™é”ï¼Œç„¶åé‡Šæ”¾å®ƒï¼Œå†è·å¾—è¯»é”ï¼Œè¿™ä¸ªä¸å«é™çº§ã€‚é™çº§å¿…é¡»æ˜¯ä¸€ä¸ªçº¿ç¨‹åœ¨å·²ç»è·å–äº†å†™é”çš„æƒ…å†µä¸‹ï¼Œä¸é‡Šæ”¾ï¼Œå†è·å–è¯»é”ã€‚æ”¯æŒè¿™ä¸ªåœ°æ–¹çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ä»[[#5.4.2.2 è¯»é”çš„è·å–]]ä¸­åˆ†æå‡ºæ¥ï¼Œå°±æ˜¯è¿™å¥ä»£ç ï¼š

```java
if (exclusiveCount(c) != 0 &&
	getExclusiveOwnerThread() != current)
	return false;
```

å¦‚æœæˆ‘åœ¨è·å–è¯»é”çš„æ—¶å€™ï¼Œå‘ç°æœ‰äººè·å–å†™é”ï¼Œä½†æ˜¯è¿™äººå±…ç„¶æ˜¯æˆ‘è‡ªå·±ï¼Œé‚£ä¹ˆæˆ‘ä¹Ÿèƒ½æˆåŠŸè·å¾—è¯»é”ã€‚

è¯´å®è¯ï¼Œè¿™ä¸ªç‰¹æ€§å…¶å®å’Œç›´æ¥è·å–å†™é”æ²¡å•¥åŒºåˆ«ï¼Œå› ä¸ºå³ä½¿é”åˆšåˆšé™çº§ï¼Œä½†æ˜¯ç”±äºæˆ‘è¿˜æ²¡é‡Šæ”¾å†™é”ï¼Œæ‰€ä»¥å…¶å®ƒçº¿ç¨‹ä¹Ÿè¿˜æ˜¯ä¼šè¢«é˜»å¡ä½ï¼Œåªæœ‰æˆ‘ä¸€ä¸ªäººèƒ½è¯»ã€‚è¿™ä¹ˆåšçš„æ„ä¹‰æˆ‘è§‰å¾—æ˜¯è­¦ç¤ºé”çš„ä½¿ç”¨è€…ï¼Œè®©ä»–é™çº§äº†ä¹‹åè™½ç„¶æœ‰å†™é”çš„æƒåŠ›ï¼Œä½†æ˜¯ä½ æœ€å¥½è¿˜æ˜¯åªå¹²è¯»é”èƒ½åšçš„äº‹æƒ…ã€‚

å› æ­¤ï¼Œä¸æ”¯æŒé”å‡çº§çš„åŸå› ä¹Ÿæ˜¾è€Œæ˜“è§ï¼šä½ è¯»é”çš„æƒåˆ©æœ¬èº«å°±æ¯”å†™é”å°ï¼Œé‚£ä¹ˆä½ å¦‚æœæŒæœ‰äº†è¯»é”ï¼Œè·å–å†™é”çš„æ—¶å€™ï¼Œå’Œå…¶å®ƒå•¥é”ä¹Ÿæ²¡è·å–çš„çº¿ç¨‹åº”è¯¥æ˜¯å…¬å¹³ç«äº‰çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å­˜åœ¨å‡çº§è¿™ä¸€è¯´ã€‚

> ä¹¦ä¸Šè¯´ä»€ä¹ˆä¿æŒå¯è§æ€§ï¼Œè¿™ä¸œè¥¿æ„Ÿè§‰æ²¡è¯´åˆ°æœ¬è´¨ã€‚

é”é™çº§çš„ä¸€èˆ¬è¿‡ç¨‹ï¼š

```java
public void processData() {
	readLock.lock();
	if (!update) {
		// å¿…é¡»å…ˆé‡Šæ”¾è¯»é”
		readLock.unlock();
		// é”é™çº§ä»å†™é”è·å–åˆ°å¼€å§‹
		writeLock.lock();
		try {
			if (!update) {
				// å‡†å¤‡æ•°æ®çš„æµç¨‹ï¼ˆç•¥ï¼‰
				update = true;
			}
			readLock.lock();
		} finally {
			writeLock.unlock();
		}
		// é”é™çº§å®Œæˆï¼Œå†™é”é™çº§ä¸ºè¯»é”
	}
	try { // ä½¿ç”¨æ•°æ®çš„æµç¨‹ï¼ˆç•¥ï¼‰
	} finally {
		readLock.unlock();
	}
}
```

è¿™æ®µä»£ç ä¸ä»…ä»…æè¿°äº†é”é™çº§ï¼Œæ›´æ˜¯ä¸€ä¸ªæ¯”è¾ƒå…·ä½“çš„åœºæ™¯ï¼š

1. é¦–å…ˆï¼Œæˆ‘åªæ˜¯æƒ³è¯»è¿™ä¸ªä¸œè¥¿ï¼Œæ‰€ä»¥è·å–äº†è¯»é”ã€‚ä¹‹åï¼Œæˆ‘çªç„¶åˆæƒ³å†™ç‚¹ä¸œè¥¿äº†ï¼Œæ‰€ä»¥æˆ‘å¿…é¡»å…ˆé‡Šæ”¾è¯»é”ï¼Œç„¶åå†è·å–å†™é”ã€‚å› ä¸ºä¸æ”¯æŒé”çš„å‡çº§ï¼›
2. ç„¶åï¼Œåœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæˆ‘å†™å®Œäº†ï¼Œä¹‹åæˆ‘è¿˜æ˜¯è¦è¯»äº†ï¼Œä½†æ˜¯ï¼Œæˆ‘ä¸å¸Œæœ›åœ¨æˆ‘ä¹‹åè¯»çš„æ—¶å€™ï¼ˆä¸Šé¢ç¬¬ä¸€ä¸ªfinallyå—ä¹‹å‰çš„è¯»ï¼Œè€Œä¸æ˜¯ç¬¬äºŒä¸ªfinallyï¼‰è¢«å…¶å®ƒçº¿ç¨‹å†™å…¥ï¼Œæ‰€ä»¥æˆ‘ä¾ç„¶ä¿æŒç€å†™é”ä¸é‡Šæ”¾ï¼Œç»§ç»­è·å–è¯»é”ï¼Œä¹Ÿå°±æ˜¯é”é™çº§ã€‚åªä¸è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿåˆ†æè¿‡ï¼Œè¿™é‡Œçš„é™çº§å°±æ˜¯é—¹ç€ç©å„¿ï¼Œåªæ˜¯æç¤ºä¸€ä¸‹å¼€å‘è€…ä½ ç°åœ¨æœ€å¥½åªç»™æˆ‘è¯»ï¼Œåˆ«å†™è€Œå·²ï¼›
3. æœ€åï¼Œæˆ‘ä¾ç„¶æƒ³è¯»ï¼Œä½†æ˜¯æˆ‘å·²ç»ä¸åœ¨ä¹åˆ«äººæ˜¯å¦å†™å…¥äº†ï¼Œæ‰€ä»¥æˆ‘é‡Šæ”¾äº†å†™é”ï¼Œæœ€åæƒ³æ€ä¹ˆè¯»æ€ä¹ˆè¯»å§ï¼›
4. è‡³äºæœ€åä¸€ä¸ªfinallyå—é‡Œçš„unlock()ï¼Œæ˜¯ä¸ºäº†åº”å¯¹updateä¸€å¼€å§‹å°±ä¸ºtrueçš„æƒ…å†µã€‚

- [ ] #TODO æŒæœ‰è¯»é”çš„æ—¶å€™è·å–å†™é”ï¼Œå¦‚æœä¸é‡Šæ”¾è¯»é”ä¼šæ€æ ·ï¼Ÿè·å–å¤±è´¥ï¼Ÿè¿˜æ˜¯ç›´æ¥sleepäº†ï¼Ÿ â• 2024-03-13 â« 
- [ ] #TODO tasktodo1715757751142 æŒæœ‰å†™é”çš„æ—¶å€™ï¼Œé™çº§æˆè¯»é”ï¼Œæ­¤çº¿ç¨‹ä¾ç„¶å…·æœ‰å†™é”çš„æƒåŠ›ï¼Œè¿™å¥è¯æ˜¯å¯¹çš„å—ï¼Ÿå¯ä»¥åšä¸€ä¸ªå®éªŒéªŒè¯ä¸€ä¸‹ï¼šå¦‚æœé™çº§ä¹‹åï¼Œå…¶å®ƒçº¿ç¨‹è¯•å›¾è·å–è¯»é”å¤±è´¥äº†ï¼Œé‚£è¿™å¥è¯å°±æ˜¯å¯¹çš„ï¼Œè€Œåªè¦èƒ½æˆåŠŸï¼Œé‚£ä¹ˆå°±ä»£è¡¨é™çº§é”çš„çº¿ç¨‹å·²ç»ä¸å…·æœ‰å†™é”çš„æƒé™äº†ï¼›å¦å¤–ï¼Œå¦‚æœè¿™å¥è¯æ˜¯é”™çš„ï¼Œé‚£ä¹ˆæˆ‘ä¹‹å‰è¯´çš„é‚£äº›â€œé—¹ç€ç©â€å°±ä¹Ÿéƒ½æ˜¯é”™çš„äº†ã€‚ â« â• 2024-05-15

> [!attention]
> ä¸Šé¢çš„`update`éœ€è¦æ˜¯volatileçš„ï¼Œéœ€è¦å¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚

---

```dataviewjs
const pages = dv.pages('"Study Log/java_kotlin_study/concurrency_art"')
let nextChapterHead = undefined
let res = undefined
const current = dv.current()
for (let page of pages) {
	if (page.chapter_root == true && page.order == Number(current.chapter) + 1) {
		console.log("found next head: " + page.name)
		nextChapterHead = page
		continue
	}
	if (page.chapter == undefined || page.chapter != current.chapter) {
		console.log("not current chapter: " + page.file.name)
		continue
	}
	if (page.order == Number(current.order) + 1) {
		res = page
	}
}
console.log("res: " + res)
console.log("next: " + nextChapterHead)
if (res == undefined) {
	res = nextChapterHead
}
let text = ""
if (res != undefined) {
	const path = res.file.path
	const title = res.title
	const decoLink = "[[" + path + "|" + title + "]]"
	text = "Next Article: " + decoLink
} else {
	text = "æ—…é€”çš„ç»ˆç‚¹ï¼"
}
dv.el("p", text, { attr: { align: "right" } })
```