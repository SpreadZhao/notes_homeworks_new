

### çœ‹ä¸€æ®µä»£ç æ¨æ–­è¿è¡Œç»“æœ

ä»£ç å¦‚ä¸‹ï¼š
```java
public class WaitNotify {
    static boolean flag = true;
    static Object  lock = new Object();

    public static void main(String[] args) throws Exception {
        Thread waitThread = new Thread(new Wait(), "WaitThread");
        waitThread.start();
        TimeUnit.SECONDS.sleep(1);

        Thread notifyThread = new Thread(new Notify(), "NotifyThread");
        notifyThread.start();
    }

    static class Wait implements Runnable {
        public void run() {
            // åŠ é”ï¼Œæ‹¥æœ‰lockçš„Monitor
            synchronized (lock) {
                // å½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œç»§ç»­waitï¼ŒåŒæ—¶é‡Šæ”¾äº†lockçš„é”
                while (flag) {
                    try {
                        System.out.println(Thread.currentThread() + " flag is true. wait @ "
                                           + new SimpleDateFormat("HH:mm:ss").format(new Date()));
                        lock.wait();
                    } catch (InterruptedException e) {
                    }
                }
                // æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå®Œæˆå·¥ä½œ
                System.out.println(Thread.currentThread() + " flag is false. running @ "
                                   + new SimpleDateFormat("HH:mm:ss").format(new Date()));
            }
        }
    }

    static class Notify implements Runnable {
        public void run() {
            // åŠ é”ï¼Œæ‹¥æœ‰lockçš„Monitor
            synchronized (lock) {
                // è·å–lockçš„é”ï¼Œç„¶åè¿›è¡Œé€šçŸ¥ï¼Œé€šçŸ¥æ—¶ä¸ä¼šé‡Šæ”¾lockçš„é”ï¼Œ
                // ç›´åˆ°å½“å‰çº¿ç¨‹é‡Šæ”¾äº†lockåï¼ŒWaitThreadæ‰èƒ½ä»waitæ–¹æ³•ä¸­è¿”å›
                System.out.println(Thread.currentThread() + " hold lock. notify @ " + new SimpleDateFormat("HH:mm:ss").format(new Date()));
                lock.notifyAll();       // æ³¨æ„ï¼šæ­¤å¤„ç¡®å®è°ƒç”¨äº†notifyAllæ–¹æ³•ç”¨æ¥å”¤é†’waitï¼Œä½†æ˜¯ä½†æ˜¯æ­¤å¤„çš„ğŸ”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼ï¼ï¼æ‰€ä»¥waitæ–¹æ³•ä¸èƒ½ç«‹åˆ»æ‰§è¡Œ
                flag = false;
                SleepUtils.second(5);
            }
            // å†æ¬¡åŠ é”
            synchronized (lock) {
                System.out.println(Thread.currentThread() + " hold lock again. sleep @ "
                                   + new SimpleDateFormat("HH:mm:ss").format(new Date()));
                SleepUtils.second(5);
            }
        }
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š
```text
Thread[WaitThread,5,main] flag is true. wait @ 22:23:03
Thread[NotifyThread,5,main] hold lock. notify @ 22:23:04
Thread[NotifyThread,5,main] hold lock again. sleep @ 22:23:09
Thread[WaitThread,5,main] flag is false. running @ 22:23:14
```
ä¸Šè¿°ç¬¬3è¡Œå’Œç¬¬4è¡Œè¾“å‡ºçš„é¡ºåºå¯èƒ½ä¼šäº’æ¢

### åˆ†æç¨‹åº
1. ä½¿ç”¨wait()ã€notify()å’ŒnotifyAll()æ—¶éœ€è¦å…ˆå¯¹è°ƒç”¨å¯¹è±¡åŠ é”
2. è°ƒç”¨wait()æ–¹æ³•åï¼Œçº¿ç¨‹çŠ¶æ€ç”±RUNNINGå˜ä¸ºWAITINGï¼Œå¹¶å°†å½“å‰çº¿ç¨‹æ”¾ç½®åˆ°å¯¹è±¡çš„ç­‰å¾…é˜Ÿåˆ—
3. **notify()æˆ–notifyAll()æ–¹æ³•è°ƒç”¨åï¼Œç­‰å¾…çº¿ç¨‹ä¾æ—§ä¸ä¼šä»wait()è¿”å›ï¼Œéœ€è¦è°ƒç”¨notify()æˆ–notifAll()çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œç­‰å¾…çº¿ç¨‹æ‰æœ‰æœºä¼šä»wait()è¿”å›**
4. notify()æ–¹æ³•å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè€ŒnotifyAll()
   æ–¹æ³•åˆ™æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„çº¿ç¨‹å…¨éƒ¨ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè¢«ç§»åŠ¨çš„çº¿ç¨‹çŠ¶æ€ç”±WAITINGå˜ä¸º
   BLOCKEDã€è¿›å…¥åŒæ­¥é˜Ÿåˆ—åä¾ç„¶éœ€è¦æŠ¢é”ã€‘
5. ä»wait()æ–¹æ³•è¿”å›çš„å‰ææ˜¯è·å¾—äº†è°ƒç”¨å¯¹è±¡çš„é”

å›¾4-3æè¿°äº†ä¸Šè¿°ç¤ºä¾‹çš„è¿‡ç¨‹ï¼š
![](/Users/apple/Documents/Work/aliyun-oss/dev-images/2023-03-05-23-17-46-image.png)
1. WaitThreadé¦–å…ˆè·å–äº†å¯¹è±¡çš„é”ï¼Œç„¶åè°ƒç”¨å¯¹è±¡çš„wait()æ–¹æ³•ï¼Œä»è€Œæ”¾å¼ƒäº†é”
   å¹¶è¿›å…¥äº†å¯¹è±¡çš„ç­‰å¾…é˜Ÿåˆ—WaitQueueä¸­ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€
2. ç”±äºWaitThreadé‡Šæ”¾äº†å¯¹è±¡çš„é”ï¼ŒNotifyThreadéšåè·å–äº†å¯¹è±¡çš„é”ï¼Œå¹¶è°ƒç”¨å¯¹è±¡çš„notify()æ–¹æ³•ï¼Œå°†WaitThreadä»WaitQueueç§»åˆ°
   SynchronizedQueueä¸­ã€‚
3. NotifyThreadé‡Šæ”¾äº†é”ä¹‹åï¼Œ
   WaitThreadå†æ¬¡è·å–åˆ°é”å¹¶ä»wait()æ–¹æ³•è¿”å›ç»§ç»­æ‰§è¡Œ

### waitæ–¹æ³•çš„åŸç†
waitæ–¹æ³•æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œåœ¨åº•å±‚æ˜¯ä½¿ç”¨c++å®ç°çš„ã€‚ä»Threadç±»çš„waitæ–¹æ³•æ³¨é‡Šä¸­å¯ä»¥çŸ¥é“å¦‚ä¸‹å‡ ç‚¹ï¼š
1. åŠŸèƒ½æ˜¯ï¼šé€ æˆå½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨notifyæ–¹æ³•ã€notifyAllæ–¹æ³•ã€æˆ–è€…æŒ‡å®šçš„æ—¶é—´åˆ°äº†
2. å‰æï¼šå½“å‰çº¿ç¨‹å¿…é¡»è·å–å¯¹è±¡ç›‘è§†å™¨(å°±æ˜¯é”)
3. è¿™ä¸ªæ–¹æ³•é€ æˆå½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…é›†åˆï¼Œç„¶åæ”¾å¼ƒæ‰€æœ‰çš„åŒæ­¥å£°æ˜ã€‚
   å½“å‰çº¿ç¨‹Tæ­¤æ—¶å¯¹äºçº¿ç¨‹è°ƒåº¦å™¨æ˜¯ä¸å¯è®¿é—®çš„ï¼Œç›´åˆ°å‘ç”Ÿä¸€ä¸‹äº‹æƒ…ï¼š
   1. å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†notifyæ–¹æ³•
   2. å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†notifyAllæ–¹æ³•
   3. å…¶ä»–çº¿ç¨‹ä¸­æ–­äº†Tçº¿ç¨‹
   4. æŒ‡å®šçš„æ—¶é—´åˆ°äº†(å¦‚æœæ˜¯æ—¶é—´æ˜¯0åˆ™è¡¨ç¤ºä¸€ç›´ç­‰å¾…ç›´åˆ°notifyå‘ç”Ÿ)